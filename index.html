<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>DMV Tennis</title>

<!-- â•â• PWA META TAGS â•â• -->
<meta name="application-name" content="DMV Tennis">
<meta name="description" content="DMV Tennis League â€“ RSVP, court assignments, and scores">
<meta name="theme-color" content="#1a5c2a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DMV Tennis">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='32' fill='%231a5c2a'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle'%3EğŸ¾%3C/text%3E%3C/svg%3E">

<!-- PWA Manifest -->
<script>
(function(){
  var manifest = {
    name:"DMV Tennis",short_name:"DMV Tennis",
    description:"DMV Tennis League â€“ RSVP, court assignments, and scores",
    start_url:"./",display:"standalone",
    background_color:"#f0f4f0",theme_color:"#1a5c2a",
    orientation:"portrait-primary",
    icons:[
      {src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='32' fill='%231a5c2a'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle'%3EğŸ¾%3C/text%3E%3C/svg%3E",sizes:"192x192",type:"image/svg+xml",purpose:"any maskable"},
      {src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='80' fill='%231a5c2a'/%3E%3Ctext x='256' y='350' font-size='280' text-anchor='middle'%3EğŸ¾%3C/text%3E%3C/svg%3E",sizes:"512x512",type:"image/svg+xml",purpose:"any maskable"}
    ]
  };
  var blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
  var link=document.createElement('link');
  link.rel='manifest'; link.href=URL.createObjectURL(blob);
  document.head.appendChild(link);
})();
</script>

<!-- Firebase SDK (ESM module - no external script blocking issues) -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';
window._fbInit = function(config) {
  const app = initializeApp(config);
  const db = getDatabase(app);
  window._fbDb = db;
  window._fbRef = ref;
  window._fbSet = set;
  window._fbOnValue = onValue;
  window.dispatchEvent(new Event('firebase-ready'));
};
window._fbInit({
  apiKey: "AIzaSyDh2HPkMnsUqf0jJ1gq3BbpsOW6IGagdvQ",
  authDomain: "dmv-tennis.firebaseapp.com",
  databaseURL: "https://dmv-tennis-default-rtdb.firebaseio.com",
  projectId: "dmv-tennis",
  storageBucket: "dmv-tennis.firebasestorage.app",
  messagingSenderId: "44825593054",
  appId: "1:44825593054:web:460f3bfc71c91d9ecf6e4f"
});
</script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:#f0f4f0;color:#222;min-height:100vh}
body{padding-bottom:env(safe-area-inset-bottom)}
header{background:#1a5c2a;color:#fff;padding:14px 20px;padding-top:max(14px,env(safe-area-inset-top));padding-left:max(20px,env(safe-area-inset-left));padding-right:max(20px,env(safe-area-inset-right));display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
header h1{font-size:1.2rem}
.btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:.9rem;font-weight:600;transition:opacity .2s;display:inline-block;-webkit-tap-highlight-color:transparent}
.btn-primary{background:#f5a623;color:#222}
.btn-green{background:#1a5c2a;color:#fff}
.btn-secondary{background:#fff;color:#1a5c2a;border:2px solid #1a5c2a}
.btn-danger{background:#c0392b;color:#fff}
.btn-sm{padding:5px 10px;font-size:.8rem}
.btn:active{opacity:.7}
#app{max-width:1000px;margin:0 auto;padding:16px}
.card{background:#fff;border-radius:10px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.card h2{color:#1a5c2a;margin-bottom:12px;font-size:1.1rem;border-bottom:2px solid #e8f5e9;padding-bottom:8px}
.tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.tab{padding:9px 18px;border-radius:20px;cursor:pointer;font-weight:600;font-size:.9rem;border:2px solid #1a5c2a;color:#1a5c2a;background:#fff;-webkit-tap-highlight-color:transparent}
.tab.active{background:#1a5c2a;color:#fff}
input,select,textarea{width:100%;padding:10px;border:1.5px solid #ccc;border-radius:6px;font-size:1rem;margin-bottom:8px;-webkit-appearance:none;appearance:none}
input:focus,select:focus,textarea:focus{outline:none;border-color:#1a5c2a}
label{font-size:.85rem;font-weight:600;color:#444;display:block;margin-bottom:4px}
.form-row{display:flex;gap:8px;flex-wrap:wrap}
.form-row>div{flex:1;min-width:140px}
table{width:100%;border-collapse:collapse;font-size:.88rem}
th{background:#1a5c2a;color:#fff;padding:8px;text-align:left}
td{padding:8px;border-bottom:1px solid #eee;vertical-align:middle}
.sticky-table-wrap{overflow-y:auto;max-height:60vh;border-radius:8px;border:1px solid #ddd}
.sticky-table-wrap table{border-collapse:separate;border-spacing:0}
.sticky-table-wrap th{position:sticky;top:0;z-index:2;box-shadow:0 2px 4px rgba(0,0,0,.12)}
.pts-badge{background:#1a5c2a;color:#fff;border-radius:14px;padding:3px 10px;font-size:.82rem;font-weight:700}
.team-a-chip{background:#dbeafe;color:#1e40af;border-radius:14px;padding:3px 10px;font-size:.82rem;font-weight:600;display:inline-block;margin:2px}
.team-b-chip{background:#fee2e2;color:#991b1b;border-radius:14px;padding:3px 10px;font-size:.82rem;font-weight:600;display:inline-block;margin:2px}
.captain-crown{font-size:.8rem;margin-right:2px}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:.75rem;font-weight:700}
.badge-in{background:#d4edda;color:#155724}
.badge-out{background:#f8d7da;color:#721c24}
.round-block{margin-bottom:20px}
.round-title{font-weight:700;color:#1a5c2a;font-size:1rem;margin-bottom:10px;padding:6px 12px;background:#e8f5e9;border-radius:6px}
.courts-row{display:flex;gap:10px;flex-wrap:wrap}
.court-card{border:2px solid #1a5c2a;border-radius:10px;overflow:hidden;flex:1;min-width:200px;max-width:280px}
.court-card.hl-court{border-color:#e67e00}
.court-header{background:#1a5c2a;color:#fff;padding:7px 12px;font-weight:700;font-size:.9rem}
.court-header.hl-hdr{background:#e67e00}
.court-body{padding:10px 12px}
.team{background:#e8f5e9;border-radius:6px;padding:7px 10px;margin:3px 0}
.team-label{font-size:.72rem;font-weight:700;color:#1a5c2a;margin-bottom:3px}
.player-chip{display:inline-block;background:#fff;border:1.5px solid #1a5c2a;border-radius:14px;padding:2px 9px;margin:2px;font-size:.78rem}
.player-chip.hl{background:#f5a623;border-color:#e67e00;font-weight:700}
.bye-chip{background:#fff3cd;border:1.5px solid #e6ac00}
.vs{text-align:center;font-weight:700;color:#888;margin:3px 0;font-size:.78rem}
.score-row{display:flex;align-items:center;justify-content:flex-end;gap:6px;margin-top:8px;padding-top:8px;border-top:1px dashed #ccc}
.score-badge{background:#e8f5e9;border-radius:6px;padding:3px 8px;font-size:.82rem;font-weight:700;color:#1a5c2a}
.score-na{color:#aaa;font-size:.8rem;font-style:italic;flex:1}
.team-row{display:flex;align-items:center;justify-content:space-between;gap:6px}
.team-score{background:#1a5c2a;color:#fff;border-radius:6px;padding:2px 10px;font-size:.85rem;font-weight:700;min-width:28px;text-align:center;flex-shrink:0}
.team-score.winner{background:#f5a623;color:#222}
.team-score.empty{background:#eee;color:#aaa}
.bye-row{background:#fff3cd;border-radius:6px;padding:8px 12px;margin-top:8px;font-size:.85rem}
.alert{padding:10px 14px;border-radius:6px;margin-bottom:12px;font-size:.88rem}
.alert-info{background:#d1ecf1;color:#0c5460}
.alert-warn{background:#fff3cd;color:#856404}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:8px}
.cal-day{padding:6px;text-align:center;border-radius:6px;font-size:.82rem;cursor:default}
.cal-sat{border:1.5px solid #ccc;background:#f9f9f9;cursor:pointer;-webkit-tap-highlight-color:transparent}
.cal-sat:active{background:#e8f5e9}
.cal-sat.cal-sat-hl{border-color:#a5d6b0;background:#f0faf2}
.cal-sat.active{background:#1a5c2a;color:#fff;border-color:#1a5c2a}
.cal-hdr{font-weight:700;font-size:.75rem;color:#666}
.cal-other{color:#ccc}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
.modal-overlay.open{display:flex}
.modal{background:#fff;border-radius:12px;padding:20px;max-width:440px;width:100%;max-height:90vh;overflow-y:auto}
.modal.modal-wide{max-width:680px}
.modal h3{color:#1a5c2a;margin-bottom:14px}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
.season-btn{padding:6px 14px;border-radius:16px;border:2px solid #1a5c2a;cursor:pointer;font-weight:600;font-size:.85rem;background:#fff;color:#1a5c2a;-webkit-tap-highlight-color:transparent}
.season-btn.active{background:#1a5c2a;color:#fff}
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 22px;border-radius:20px;font-size:.9rem;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.3);opacity:0;transition:opacity .4s;pointer-events:none;white-space:nowrap;max-width:90vw;text-align:center}
.score-input-wrap{display:flex;align-items:center;gap:8px;margin:6px 0}
.score-input-wrap input{margin:0;width:70px;text-align:center;flex-shrink:0}
.score-team-lbl{font-size:.9rem;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rsvp-big-btn{flex:1;padding:16px;font-size:1.1rem;border-radius:8px;margin-top:4px}

/* Sync indicator */
#sync-dot{width:8px;height:8px;border-radius:50%;background:#f5a623;display:inline-block;margin-left:6px;vertical-align:middle;transition:background .4s}
#sync-dot.synced{background:#4caf50}
#sync-dot.error{background:#c0392b}

/* Loading screen */
#loading{position:fixed;inset:0;background:#1a5c2a;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999;color:#fff}
#loading .spin{font-size:3rem;animation:spin 1s linear infinite;margin-bottom:16px}
#loading p{font-size:1rem;opacity:.8}
@keyframes spin{to{transform:rotate(360deg)}}

/* PWA Install Banner */
#install-banner{display:none;position:fixed;bottom:0;left:0;right:0;background:#1a5c2a;color:#fff;padding:14px 16px;padding-bottom:max(14px,env(safe-area-inset-bottom));z-index:8888;flex-direction:row;align-items:center;gap:12px;box-shadow:0 -2px 12px rgba(0,0,0,.2)}
#install-banner.show{display:flex}
#install-banner .ib-text{flex:1;font-size:.9rem;line-height:1.3}
#install-banner .ib-text strong{display:block;font-size:1rem}
#install-banner .ib-btns{display:flex;gap:8px;flex-shrink:0}
#install-banner .ib-install{background:#f5a623;color:#222;border:none;border-radius:8px;padding:9px 18px;font-weight:700;font-size:.9rem;cursor:pointer}
#install-banner .ib-dismiss{background:transparent;color:rgba(255,255,255,.7);border:1.5px solid rgba(255,255,255,.4);border-radius:8px;padding:9px 14px;font-size:.9rem;cursor:pointer}
#ios-tip{display:none;position:fixed;bottom:0;left:0;right:0;background:#1a5c2a;color:#fff;padding:16px;padding-bottom:max(16px,env(safe-area-inset-bottom));z-index:8888;box-shadow:0 -2px 12px rgba(0,0,0,.2);text-align:center;font-size:.9rem;line-height:1.5}
#ios-tip.show{display:block}
#ios-tip strong{display:block;margin-bottom:4px;font-size:1rem}
#ios-tip .ios-close{margin-top:10px;background:rgba(255,255,255,.2);border:none;color:#fff;border-radius:8px;padding:8px 24px;font-size:.9rem;cursor:pointer}
</style>
</head>
<body>

<!-- Loading screen shown until Firebase data is ready -->
<div id="loading">
  <div class="spin">ğŸ¾</div>
  <p>Loading DMV Tennisâ€¦</p>
</div>

<!-- PWA Install prompts -->
<div id="install-banner">
  <div class="ib-text"><strong>ğŸ“² Install DMV Tennis</strong>Add to your home screen for quick access</div>
  <div class="ib-btns">
    <button class="ib-dismiss" id="ib-dismiss">Later</button>
    <button class="ib-install" id="ib-install">Install</button>
  </div>
</div>
<div id="ios-tip">
  <strong>ğŸ“² Install DMV Tennis on your iPhone</strong>
  Tap <strong>Share</strong> (â–¡â†‘) then <strong>"Add to Home Screen"</strong>
  <br><button class="ios-close" id="ios-close">Got it</button>
</div>

<header>
  <h1>ğŸ¾ DMV Tennis <span id="sync-dot" title="Syncingâ€¦"></span></h1>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <span id="hdr-season" style="font-size:.85rem;opacity:.85"></span>
    <button class="btn btn-secondary btn-sm" id="admin-btn">Admin Login</button>
  </div>
</header>
<div id="app"></div>
<div class="modal-overlay" id="modal-overlay"><div class="modal" id="modal-body"></div></div>
<div id="toast"></div>

<script>
// â•â• FIREBASE INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase ESM module sets window._fbDb, _fbRef, _fbSet, _fbOnValue
// We defer setup until 'firebase-ready' fires
var dbRef = null;
var _saveTimer = null;
var _loaded = false;

// â•â• PWA INSTALL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _deferredPrompt = null;
window.addEventListener('beforeinstallprompt', function(e){
  e.preventDefault(); _deferredPrompt = e;
  if(!isStandalone()) document.getElementById('install-banner').classList.add('show');
});
function isStandalone(){ return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone===true; }
function isIOS(){ return /iphone|ipad|ipod/i.test(navigator.userAgent) && !window.MSStream; }
document.getElementById('ib-install').addEventListener('click', function(){
  if(!_deferredPrompt) return;
  _deferredPrompt.prompt();
  _deferredPrompt.userChoice.then(function(){ _deferredPrompt=null; document.getElementById('install-banner').classList.remove('show'); });
});
document.getElementById('ib-dismiss').addEventListener('click', function(){ document.getElementById('install-banner').classList.remove('show'); });
document.getElementById('ios-close').addEventListener('click', function(){
  document.getElementById('ios-tip').classList.remove('show');
  try{ localStorage.setItem('dmvt_ios_tip','1'); }catch(e){}
});
window.addEventListener('load', function(){
  if(isIOS() && !isStandalone()){
    var seen=false; try{ seen=!!localStorage.getItem('dmvt_ios_tip'); }catch(e){}
    if(!seen) setTimeout(function(){ document.getElementById('ios-tip').classList.add('show'); }, 3000);
  }
});

// â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var S = {
  players: [],
  seasons: {Spring:[],Summer:[],Fall:[],Winter:[]},
  currentSeason: 'Winter',
  sessions: {},
  byeCounts: {},
  playerStats: {},
  captainPid: null,
  pointsConfig: {matchWin:3, gameWin:1, attendance:1},
  isAdmin: false,
  selectedDate: null,
  adminTab: 'roster',
  userTab: 'rsvp'
};
var PASS = 'mydmvtennis';
var SEASONS = ['Spring','Summer','Fall','Winter'];

// â”€â”€ Load admin pref from localStorage (device-only) â”€â”€
try {
  var localPrefs = JSON.parse(localStorage.getItem('dmvt_prefs')||'{}');
  if(localPrefs.isAdmin) S.isAdmin = true;
  if(localPrefs.adminTab) S.adminTab = localPrefs.adminTab;
  if(localPrefs.userTab) S.userTab = localPrefs.userTab;
  if(localPrefs.selectedDate) S.selectedDate = localPrefs.selectedDate;
  if(localPrefs.currentSeason) S.currentSeason = localPrefs.currentSeason;
  if(localPrefs.captainPid) S.captainPid = parseInt(localPrefs.captainPid)||null;
} catch(e){}

function saveLocalPrefs(){
  try{
    localStorage.setItem('dmvt_prefs', JSON.stringify({
      isAdmin: S.isAdmin,
      adminTab: S.adminTab,
      userTab: S.userTab,
      captainPid: S.captainPid||null,
      selectedDate: S.selectedDate,
      currentSeason: S.currentSeason
    }));
  }catch(e){}
}

// â”€â”€ Save shared data to Firebase (debounced 400ms) â”€â”€â”€â”€
function save(){
  saveLocalPrefs();
  if(!dbRef){ return; } // Firebase not ready yet â€” skip remote save
  setSyncDot('saving');
  if(_saveTimer) clearTimeout(_saveTimer);
  _saveTimer = setTimeout(function(){
    var data = {
      players: S.players || [],
      seasons: S.seasons || {},
      sessions: S.sessions || {},
      byeCounts: S.byeCounts || {},
      playerStats:  S.playerStats  || {},
      pointsConfig: S.pointsConfig  || {matchWin:3,gameWin:1,attendance:1}
    };
    // Firebase doesn't support undefined values â€” strip them
    window._fbSet(dbRef, JSON.parse(JSON.stringify(data)))
      .then(function(){ setSyncDot('synced'); })
      .catch(function(e){ setSyncDot('error'); showToast('âš ï¸ Save failed: ' + e.message); });
  }, 400);
}

function setSyncDot(state){
  var dot = document.getElementById('sync-dot');
  if(!dot) return;
  dot.className = state === 'synced' ? 'synced' : state === 'error' ? 'error' : '';
}

// â”€â”€ Listen to Firebase for real-time updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initFirebaseListener() {
  var db = window._fbDb;
  dbRef = window._fbRef(db, 'dmvtennis');
  window._fbOnValue(dbRef, function(snapshot){
    var data = snapshot.val();
    if(data){
      S.players     = data.players     || [];
      S.seasons     = data.seasons     || {Spring:[],Summer:[],Fall:[],Winter:[]};
      S.sessions    = data.sessions    || {};
      S.byeCounts   = data.byeCounts   || {};
      S.playerStats  = data.playerStats  || {};
      S.pointsConfig = data.pointsConfig  || {matchWin:3,gameWin:1,attendance:1};
    }
    setSyncDot('synced');
    // Rebuild stats from scores
    if(data){
      try{ Object.keys(S.seasons||{}).forEach(function(s){ rebuildSeasonStats(s); }); }
      catch(e){ console.error('rebuildSeasonStats error:',e); }
    }
    // Refresh PC court grids live if visible
    try{
      (function(){
        var upD=getUpcoming();
        if(!upD) return;
        var upS=getSession(upD);
        if(!upS||!upS.playersChoice) return;
        var ag=byId('pc-court-grid');
        if(ag){ ag.innerHTML=playersChoiceCourtGrid(upS,upD,true); bindScoreButtons(); }
        var ug=byId('pc-user-grid');
        if(ug){ ug.innerHTML=playersChoiceCourtGrid(upS,upD,false); }
      })();
    } catch(e){ console.error('PC grid refresh error:',e); }
    if(!_loaded){
      _loaded = true;
      document.getElementById('loading').style.display = 'none';
    }
    try{ render(); } catch(e){ console.error('render error:',e); }
  }, function(error){
    console.error('Firebase error:',error);
    setSyncDot('error');
    document.getElementById('loading').style.display = 'none';
    showToast('âš ï¸ Connection error: '+(error&&error.message?error.message:'Check your internet.'));
    if(!_loaded){ _loaded=true; try{ render(); } catch(e){} }
  });
}
window.addEventListener('firebase-ready', initFirebaseListener);

// â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(str){
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function getPlayer(id){
  for(var i=0;i<S.players.length;i++) if(S.players[i].id===id) return S.players[i];
  return null;
}
function fmtId(id){ return id<10?'00'+id:id<100?'0'+id:''+id; }
function fmtDate(d){
  try{ return new Date(d+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'}); }
  catch(e){ return d||''; }
}
function getSession(date){
  if(!date) return {type:'doubles',rotatePartners:true,manualPartners:false,teamBattle:false,playersChoice:false,teamA:[],teamB:[],captainA:null,captainB:null,courts:4,matchesPerPlayer:4,rsvps:{},assignments:null,scores:{},posted:false,lockedTeams:[],noByePids:[],scoresLocked:false};
  if(!S.sessions[date]) S.sessions[date]={type:'doubles',rotatePartners:true,manualPartners:false,teamBattle:false,playersChoice:false,teamA:[],teamB:[],captainA:null,captainB:null,courts:4,matchesPerPlayer:4,rsvps:{},assignments:null,scores:{},posted:false,lockedTeams:[],noByePids:[],scoresLocked:false};
  var sess=S.sessions[date];
  if(!sess.scores) sess.scores={};
  if(!sess.rsvps) sess.rsvps={};
  if(sess.courts===undefined) sess.courts=4;
  if(sess.matchesPerPlayer===undefined) sess.matchesPerPlayer=4;
  if(sess.type===undefined) sess.type='doubles';
  return sess;
}
function getInPlayers(date){
  var sess=getSession(date), result=[];
  for(var i=0;i<S.players.length;i++)
    if(sess.rsvps[S.players[i].id]==='IN') result.push(S.players[i]);
  return result;
}
function getUpcoming(){
  var dates=(S.seasons[S.currentSeason]||[]).slice().sort();
  var today=new Date(); today.setHours(0,0,0,0);
  for(var i=0;i<dates.length;i++)
    if(new Date(dates[i]+'T12:00:00')>=today) return dates[i];
  return null;
}
// Returns upcoming date, or if none, the most recent past date (so team/assignment info stays visible)
function getActiveSession(){
  var upcoming=getUpcoming();
  if(upcoming) return upcoming;
  var dates=(S.seasons[S.currentSeason]||[]).slice().sort();
  return dates.length?dates[dates.length-1]:null;
}
function byId(id){ return document.getElementById(id); }

// â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _tt=null;
function showToast(msg){
  var t=byId('toast'); if(!t) return;
  t.textContent=msg; t.style.opacity='1';
  if(_tt) clearTimeout(_tt);
  _tt=setTimeout(function(){ t.style.opacity='0'; },3000);
}

// â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModal(html,wide){ var m=byId('modal-body').parentElement; if(m){ m.classList.toggle('modal-wide',!!wide); } byId('modal-body').innerHTML=html; byId('modal-overlay').classList.add('open'); }
function closeModal(){ byId('modal-overlay').classList.remove('open'); byId('modal-body').innerHTML=''; }
byId('modal-overlay').addEventListener('click',function(e){ if(e.target.id==='modal-overlay') closeModal(); });

// â•â• ROOT RENDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  byId('hdr-season').textContent=''; // keep sync dot; set season label separately
  var seasonEl = document.createElement('span');
  seasonEl.textContent = S.currentSeason+' Season';
  var hdrSeason = byId('hdr-season');
  if(hdrSeason) hdrSeason.textContent = S.currentSeason+' Season';
  byId('admin-btn').textContent=S.isAdmin?'Logout':'Admin Login';
  try{
    byId('app').innerHTML=S.isAdmin?adminHTML():userHTML();
  } catch(e){
    console.error('render HTML error:',e);
    // Fallback: show user view on error (prevents blank screen after logout)
    try{ byId('app').innerHTML=userHTML(); } catch(e2){
      byId('app').innerHTML='<div class="card"><div class="alert alert-info">Loading...</div></div>';
    }
  }
  try{
    if(S.isAdmin) bindAdmin(); else bindUser();
  } catch(e){ console.error('bind error:',e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USER VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function userHTML(){
  var activeDate=getActiveSession();
  // Find specific session types: scan ALL season dates so TB/PC tabs show for their specific date
  var seasonDates=(S.seasons[S.currentSeason]||[]).slice().sort();
  var today=new Date(); today.setHours(0,0,0,0);
  var tbDate=null;
  for(var _i=0;_i<seasonDates.length;_i++){
    var _d=seasonDates[_i],_ds=S.sessions[_d];
    if(_ds&&_ds.teamBattle){
      if(new Date(_d+'T12:00:00')>=today){ tbDate=_d; break; }
      else tbDate=_d;
    }
  }
  var pcDate=null;
  for(var _i=0;_i<seasonDates.length;_i++){
    var _d=seasonDates[_i],_ds=S.sessions[_d];
    if(_ds&&_ds.playersChoice){
      if(new Date(_d+'T12:00:00')>=today){ pcDate=_d; break; }
      else pcDate=_d;
    }
  }
  var showCaptainTab=!!tbDate;
  var showPCTab=!!pcDate;
  var tbSess=tbDate?getSession(tbDate):null;
  var bothRostersReady=showCaptainTab&&tbSess&&tbSess.teamA&&tbSess.teamA.length>0&&tbSess.teamB&&tbSess.teamB.length>0&&(!tbSess.assignments);
  var safeTab=S.userTab;
  if(safeTab==='captain'&&!showCaptainTab) safeTab='rsvp';
  if(safeTab==='pchoice'&&!showPCTab) safeTab='rsvp';
  var h='<div class="tabs">'
    +'<button class="tab'+(safeTab==='rsvp'?' active':'')+'" data-utab="rsvp">RSVP</button>'
    +'<button class="tab'+(safeTab==='schedule'?' active':'')+'" data-utab="schedule">Court Assignments &amp; Scores</button>'
    +(showCaptainTab?'<button class="tab'+(safeTab==='captain'?' active':'')+'" data-utab="captain">âš”ï¸ Team Battle'+(bothRostersReady?' <span style="background:#f5a623;color:#222;border-radius:8px;padding:1px 6px;font-size:.7rem;font-weight:700">READY</span>':'')+'</button>':'')
    +(showPCTab?'<button class="tab'+(safeTab==='pchoice'?' active':'')+'" data-utab="pchoice">ğŸ¾ My Court</button>':'')
    +'<button class="tab'+(safeTab==='stats'?' active':'')+'" data-utab="stats">Stats</button>'
    +'</div>';
  h+=(safeTab==='rsvp')?rsvpHTML():(safeTab==='captain')?captainTeamHTML():(safeTab==='pchoice')?playersChoiceUserHTML():(safeTab==='schedule')?scheduleHTML(false):byesHTML();
  return h;
}
function bindUser(){
  document.querySelectorAll('[data-utab]').forEach(function(b){
    b.addEventListener('click',function(){ S.userTab=b.dataset.utab; saveLocalPrefs(); render(); });
  });
  var lb=byId('rsvp-lookup-btn'); if(lb) lb.addEventListener('click',renderRsvpStatus);
  var rs=byId('rsvp-sel');
  if(rs){ rs.addEventListener('change',renderRsvpStatus); rs.addEventListener('input',renderRsvpStatus); }
  var capLogin=byId('captain-login-btn'); if(capLogin) capLogin.addEventListener('click',openCaptainLogin);
  var schedDateSel=byId('schedule-date-sel');
  if(schedDateSel) schedDateSel.addEventListener('change',function(){ S._scheduleViewDate=schedDateSel.value; render(); });
  var capCancel=byId('cap-cancel-btn'); if(capCancel) capCancel.addEventListener('click',function(){ S.captainPid=null; saveLocalPrefs(); render(); });
  // Captain roster bindings
  // Find the team battle session
  var _cbDates=(S.seasons[S.currentSeason]||[]).slice().sort();
  var _cbToday=new Date(); _cbToday.setHours(0,0,0,0);
  var capDate=null;
  for(var _cbi=0;_cbi<_cbDates.length;_cbi++){
    var _cbd=_cbDates[_cbi],_cbds=S.sessions[_cbd];
    if(_cbds&&_cbds.teamBattle){
      if(new Date(_cbd+'T12:00:00')>=_cbToday){ capDate=_cbd; break; }
      else capDate=_cbd;
    }
  }
  var capSess=capDate?getSession(capDate):null;
  var isCapA=S.captainPid&&capSess&&S.captainPid==capSess.captainA;
  function myCapColor(){ return isCapA?'#1e40af':'#991b1b'; }

  // Build capSelected from saved team
  var capSelected=[];
  if(S.captainPid&&capSess){
    var capTeamRaw=isCapA?(capSess.teamA||[]):(capSess.teamB||[]);
    capSelected=capTeamRaw.slice().map(function(id){ return parseInt(id); });
    if(capSelected.indexOf(parseInt(S.captainPid))<0) capSelected.push(parseInt(S.captainPid));
  }

  // Helper: compute which pids are currently paired (appear in any complete pair row)
  function getPairedSet(){
    var paired={};
    document.querySelectorAll('#cap-pairs-list > div').forEach(function(row){
      var sels=row.querySelectorAll('.cap-pair-sel');
      if(sels.length===2){
        var p1=parseInt(sels[0].value)||null, p2=parseInt(sels[1].value)||null;
        if(p1&&p2&&p1!==p2){ paired[p1]=true; paired[p2]=true; }
      }
    });
    return paired;
  }

  // Rebuild pair dropdown options from current capSelected, annotating paired players
  function buildPairOpts(pairedSet){
    if(!pairedSet) pairedSet=getPairedSet();
    var opts='<option value="">â€” none â€”</option>';
    capSelected.forEach(function(pid){
      var pp=getPlayer(pid);
      var label=fmtId(pid)+' '+esc(pp?pp.name:fmtId(pid));
      if(pairedSet[pid]) label+=' (paired)';
      opts+='<option value="'+pid+'">'+label+'</option>';
    });
    return opts;
  }

  // Refresh all pair dropdowns preserving current selections, with paired annotations
  function refreshPairDropdowns(){
    var pairedSet=getPairedSet();
    var newOpts=buildPairOpts(pairedSet);
    document.querySelectorAll('.cap-pair-sel').forEach(function(sel){
      var curVal=sel.value;
      sel.innerHTML=newOpts;
      sel.value=curVal;
    });
  }

  // Refresh all player toggle button labels to reflect current capSelected state
  function refreshRosterButtons(){
    var pairedSet=getPairedSet();
    var myTeamLabel=isCapA?'Team A':'Team B';
    document.querySelectorAll('.cap-roster-toggle').forEach(function(b){
      var pid2=parseInt(b.dataset.pid);
      var active=capSelected.indexOf(pid2)>=0;
      var paired=pairedSet[pid2];
      b.style.border='2px solid '+(active?myCapColor():'#ccc');
      b.style.background=active?myCapColor():'#fff';
      b.style.color=active?'#fff':'#444';
      b.style.fontWeight=active?'700':'400';
      var pp2=getPlayer(pid2);
      var statusTxt=active?(paired?'paired':myTeamLabel):'unassigned';
      var statusCol=active?'rgba(255,255,255,.8)':'#888';
      b.innerHTML=(active?'âœ“ ':'')+fmtId(pid2)+' '+esc(pp2?pp2.name:fmtId(pid2))
        +'<span style="font-size:.68rem;color:'+statusCol+';font-weight:700;display:block">'+statusTxt+'</span>';
    });
    var cnt=byId('cap-sel-count'); if(cnt) cnt.textContent=capSelected.length;
  }

  // Player toggle buttons â€” update status instantly, refresh pairs
  document.querySelectorAll('.cap-roster-toggle').forEach(function(btn){
    btn.addEventListener('click',function(){
      var pid=parseInt(btn.dataset.pid);
      var idx=capSelected.indexOf(pid);
      if(idx>=0){ capSelected.splice(idx,1); }
      else { capSelected.push(pid); }
      refreshRosterButtons();
      refreshPairDropdowns();
    });
  });

  // When any pair dropdown changes, refresh buttons and all dropdowns for paired annotations
  document.addEventListener('change',function(e){
    if(e.target&&e.target.classList.contains('cap-pair-sel')){
      refreshRosterButtons();
      refreshPairDropdowns();
    }
  });

  // Unsubmit roster button
  var capUnsubmitBtn=byId('cap-unsubmit-btn');
  if(capUnsubmitBtn) capUnsubmitBtn.addEventListener('click',function(){
    if(!capDate||!capSess) return;
    if(isCapA) capSess.teamA=[]; else capSess.teamB=[];
    S.sessions[capDate]=capSess; save();
    showToast('Roster unsubmitted. You can now edit and resubmit.');
    render();
  });

  // Submit / Resubmit roster button
  var capSubmitBtn=byId('cap-submit-roster-btn');
  if(capSubmitBtn) capSubmitBtn.addEventListener('click',function(){
    if(!capDate||!capSess) return;
    if(capSelected.length<1){ showToast('Select at least 1 player.'); return; }
    if(capSelected.indexOf(parseInt(S.captainPid))<0) capSelected.push(parseInt(S.captainPid));
    if(isCapA) capSess.teamA=capSelected; else capSess.teamB=capSelected;
    // Save pairs from DOM
    var pairsList=byId('cap-pairs-list');
    if(pairsList){
      if(!capSess.captainPairs) capSess.captainPairs={A:[],B:[]};
      var pairs=[];
      pairsList.querySelectorAll('div').forEach(function(row){
        var sels=row.querySelectorAll('.cap-pair-sel');
        if(sels.length===2){
          var p1=parseInt(sels[0].value)||null, p2=parseInt(sels[1].value)||null;
          if(p1&&p2&&p1!==p2) pairs.push([p1,p2]);
        }
      });
      capSess.captainPairs[isCapA?'A':'B']=pairs;
    }
    S.sessions[capDate]=capSess; save();
    showToast('Roster submitted!');
    render();
  });

  // Add Pair button â€” only own-team players
  var capAddPairBtn=byId('cap-add-pair-btn');
  if(capAddPairBtn) capAddPairBtn.addEventListener('click',function(){
    var pairsList=byId('cap-pairs-list'); if(!pairsList) return;
    var newOpts=buildPairOpts();
    var rowNum=pairsList.children.length+1;
    var div=document.createElement('div');
    div.style.cssText='display:flex;gap:6px;margin-bottom:6px;align-items:center';
    div.innerHTML='<span style="font-size:.78rem;color:#888;min-width:16px">'+rowNum+'.</span>'
      +'<select class="cap-pair-sel" style="flex:1;padding:5px;border-radius:6px;border:1.5px solid #ccc;font-size:.8rem">'+newOpts+'</select>'
      +'<span style="font-size:.78rem;color:#888">+</span>'
      +'<select class="cap-pair-sel" style="flex:1;padding:5px;border-radius:6px;border:1.5px solid #ccc;font-size:.8rem">'+newOpts+'</select>';
    pairsList.appendChild(div);
    refreshRosterButtons();
    refreshPairDropdowns();
  });
  var pcSubmit=byId('pc-submit-btn'); if(pcSubmit) pcSubmit.addEventListener('click',submitPlayersChoice);
  bindScoreButtons(); bindHighlightSelect(); bindStatsControls();
}

// â”€â”€ STATS CONTROLS BINDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bindStatsControls(){
  document.querySelectorAll('[data-stats-view]').forEach(function(b){
    b.addEventListener('click',function(){ S._statsView=b.dataset.statsView; render(); });
  });
  var ssSel=byId('stats-session-sel');
  if(ssSel) ssSel.addEventListener('change',function(){ S._statsSessionDate=ssSel.value; render(); });
  var svSel=byId('stats-season-for-view-sel');
  if(svSel) svSel.addEventListener('change',function(){ S._statsSeasonForSession=svSel.value; render(); });
  var pfSel=byId('partner-focus-sel');
  if(pfSel) pfSel.addEventListener('change',function(){ S._partnerFocusPid=parseInt(pfSel.value)||null; render(); });
  document.querySelectorAll('[data-partner-sub]').forEach(function(b){
    b.addEventListener('click',function(){ S._partnerSubView=b.dataset.partnerSub; render(); });
  });
  var psSel=byId('partner-session-sel');
  if(psSel) psSel.addEventListener('change',function(){ S._partnerSessionDate=psSel.value; render(); });
  var bonusBtn=byId('bonus-pts-btn');
  if(bonusBtn) bonusBtn.addEventListener('click',openBonusPointsModal);
  // Custom range filter bindings
  var crApply=byId('cr-apply-btn');
  if(crApply) crApply.addEventListener('click',function(){
    var f=byId('cr-from'), t=byId('cr-to');
    S._crFrom=f?f.value:''; S._crTo=t?t.value:'';
    render();
  });
  var crClear=byId('cr-clear-btn');
  if(crClear) crClear.addEventListener('click',function(){
    S._crFrom=''; S._crTo='';
    render();
  });
}

// â”€â”€ RSVP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ RSVP ROSTER SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rsvpRosterHTML(date){
  var sess=getSession(date), rsvps=sess.rsvps||{};
  var inList=[], outList=[], pendingList=[];
  for(var i=0;i<S.players.length;i++){
    var p=S.players[i], st=rsvps[p.id];
    if(st==='IN') inList.push(p);
    else if(st==='OUT') outList.push(p);
    else pendingList.push(p); // not_submitted (default)
  }
  var h='<div style="margin-top:16px;border-top:2px solid #e8f5e9;padding-top:14px">';
  h+='<div style="font-weight:700;color:#1a5c2a;margin-bottom:10px;font-size:.95rem">ğŸ“‹ Who&#39;s Playing?</div>';

  // IN
  h+='<div style="margin-bottom:10px">';
  h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
  h+='<span class="badge badge-in">âœ… IN</span>';
  h+='<span style="font-size:.82rem;color:#555">'+inList.length+' player'+(inList.length!==1?'s':'')+'</span>';
  h+='</div>';
  if(inList.length){
    h+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
    for(var i=0;i<inList.length;i++){
      h+='<span style="background:#d4edda;color:#155724;border-radius:16px;padding:4px 12px;font-size:.85rem;font-weight:600">'+esc(inList[i].name)+'</span>';
    }
    h+='</div>';
  } else {
    h+='<span style="color:#aaa;font-size:.82rem;font-style:italic">No one yet</span>';
  }
  h+='</div>';

  // OUT
  if(outList.length){
    h+='<div style="margin-bottom:10px">';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
    h+='<span class="badge badge-out">âŒ OUT</span>';
    h+='<span style="font-size:.82rem;color:#555">'+outList.length+' player'+(outList.length!==1?'s':'')+'</span>';
    h+='</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
    for(var i=0;i<outList.length;i++){
      h+='<span style="background:#f8d7da;color:#721c24;border-radius:16px;padding:4px 12px;font-size:.85rem">'+esc(outList[i].name)+'</span>';
    }
    h+='</div></div>';
  }

  // Not Submitted
  if(pendingList.length){
    h+='<div>';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
    h+='<span style="background:#eee;color:#666;border-radius:12px;padding:2px 8px;font-size:.75rem;font-weight:700">ğŸ“­ NOT SUBMITTED</span>';
    h+='<span style="font-size:.82rem;color:#555">'+pendingList.length+' haven&#39;t submitted</span>';
    h+='</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
    for(var i=0;i<pendingList.length;i++){
      h+='<span style="background:#f5f5f5;color:#888;border-radius:16px;padding:4px 12px;font-size:.85rem">'+esc(pendingList[i].name)+'</span>';
    }
    h+='</div></div>';
  }

  h+='</div>';
  return h;
}

function rsvpHTML(){
  var date=getUpcoming();
  if(!date) return '<div class="card"><h2>ğŸ“… Upcoming Saturday</h2><div class="alert alert-info">No upcoming Saturday scheduled yet.</div></div>';
  var label='';
  try{ label=new Date(date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'}); }catch(e){ label=date; }
  var opts='<option value="">-- Choose your name --</option>';
  for(var i=0;i<S.players.length;i++){
    var p=S.players[i];
    opts+='<option value="'+p.id+'">'+fmtId(p.id)+' - '+esc(p.name)+'</option>';
  }
  return '<div class="card"><h2>ğŸ“… '+esc(label)+'</h2>'
    +'<label>Select Your Name</label>'
    +'<select id="rsvp-sel" style="font-size:1rem;padding:12px;margin-bottom:10px">'+opts+'</select>'
    +'<button class="btn btn-green" style="width:100%;padding:12px;font-size:1rem;margin-bottom:12px" id="rsvp-lookup-btn">View / Update My Status</button>'
    +'<div id="rsvp-status"></div>'
    +'<div id="rsvp-roster">'+rsvpRosterHTML(date)+'</div>'
    +'</div>';
}
function renderRsvpStatus(){
  var sel=byId('rsvp-sel'), el=byId('rsvp-status');
  if(!sel||!el) return;
  var pid=parseInt(sel.value);
  if(!pid){ el.innerHTML='<div class="alert alert-warn">Please select your name first.</div>'; return; }
  var date=getUpcoming(); if(!date){ el.innerHTML=''; return; }
  var sess=getSession(date), cur=sess.rsvps[pid]||null, p=getPlayer(pid), name=p?p.name:fmtId(pid);
  el.innerHTML='<div>'
    +'<div style="font-size:.95rem;margin-bottom:10px">Status for <strong>'+esc(name)+'</strong>: '
    +(cur==='IN'?'<span class="badge badge-in">IN</span>':cur==='OUT'?'<span class="badge badge-out">OUT</span>':'<span style="background:#eee;color:#666;border-radius:12px;padding:2px 8px;font-size:.75rem;font-weight:700">NOT SUBMITTED</span>')
    +'</div><div style="display:flex;gap:12px">'
    +'<button class="btn rsvp-big-btn '+(cur==='IN'?'btn-primary':'btn-secondary')+'" id="btn-in">âœ… IN</button>'
    +'<button class="btn rsvp-big-btn '+(cur==='OUT'?'btn-danger':'btn-secondary')+'" id="btn-out">âŒ OUT</button>'
    +'</div></div>';
  byId('btn-in').addEventListener('click',function(){ setRsvp(pid,'IN',date); });
  byId('btn-out').addEventListener('click',function(){ setRsvp(pid,'OUT',date); });
  var rr=byId('rsvp-roster'); if(rr) rr.innerHTML=rsvpRosterHTML(date);
}
function setRsvp(pid,status,date){
  var sess=getSession(date);
  sess.rsvps[pid]=status;
  S.sessions[date]=sess;
  save();
  var p=getPlayer(pid), name=p?p.name:fmtId(pid), el=byId('rsvp-status');
  if(!el) return;
  el.innerHTML='<div>'
    +'<div style="font-size:.95rem;margin-bottom:10px">Status for <strong>'+esc(name)+'</strong>: '
    +'<span class="badge '+(status==='IN'?'badge-in':'badge-out')+'">'+status+'</span></div>'
    +'<div style="display:flex;gap:12px">'
    +'<button class="btn rsvp-big-btn '+(status==='IN'?'btn-primary':'btn-secondary')+'" id="btn-in">âœ… IN</button>'
    +'<button class="btn rsvp-big-btn '+(status==='OUT'?'btn-danger':'btn-secondary')+'" id="btn-out">âŒ OUT</button>'
    +'</div><div style="margin-top:10px;color:#1a5c2a;font-weight:700">âœ“ Saved!</div></div>';
  byId('btn-in').addEventListener('click',function(){ setRsvp(pid,'IN',date); });
  byId('btn-out').addEventListener('click',function(){ setRsvp(pid,'OUT',date); });
  var rr=byId('rsvp-roster'); if(rr) rr.innerHTML=rsvpRosterHTML(date);
}

// â”€â”€ MATCH COUNTS SUMMARY HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function matchCountsSummaryHTML(sess, inP){
  var matchCounts={};
  if(sess.assignments&&sess.assignments.rounds){
    sess.assignments.rounds.forEach(function(round){
      if(!round||!Array.isArray(round.courts)) return;
      round.courts.forEach(function(court){
        if(!court||!Array.isArray(court.teams)) return;
        court.teams.forEach(function(team){
          if(!Array.isArray(team)) return;
          team.forEach(function(pid){ matchCounts[pid]=(matchCounts[pid]||0)+1; });
        });
      });
    });
  }
  var mcPlayers=inP.slice().sort(function(a,b){ return a.id-b.id; });
  if(!mcPlayers.length) return '';
  var mpp=sess.matchesPerPlayer||4;
  var GREEN='#1a5c2a', ORANGE='#e67e00', GREY='#aaa';
  var mcHTML='<div style="margin-bottom:14px;background:#f0faf4;border:1.5px solid #b2dfdb;border-radius:8px;padding:10px 12px">'
    +'<div style="font-size:.8rem;font-weight:700;color:'+GREEN+';margin-bottom:8px">ğŸ¾ Matches Per Player</div>'
    +'<div style="display:flex;flex-wrap:wrap;gap:6px">';
  mcPlayers.forEach(function(p){
    var cnt=matchCounts[p.id]||0;
    var dot=cnt>=mpp?GREEN:cnt>0?ORANGE:GREY;
    mcHTML+='<div style="display:flex;align-items:center;gap:5px;background:#fff;border:1.5px solid '+(cnt>=mpp?GREEN:cnt>0?'#f5a623':'#ddd')+';border-radius:20px;padding:3px 10px 3px 7px;font-size:.78rem">'
      +'<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:'+dot+'"></span>'
      +'<span>'+esc(p.name)+'</span>'
      +'<span style="font-weight:700;color:'+dot+'">'+cnt+'</span>'
      +'</div>';
  });
  mcHTML+='</div>'
    +'<div style="margin-top:6px;font-size:.72rem;color:#888">'
    +'<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:'+GREEN+';margin-right:3px;vertical-align:middle"></span><span style="color:'+GREEN+';font-weight:600">met target</span>'
    +' &nbsp;<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:'+ORANGE+';margin-right:3px;vertical-align:middle"></span>partial'
    +' &nbsp;<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:'+GREY+';margin-right:3px;vertical-align:middle"></span>none'
    +'</div>'
    +'</div>';
  return mcHTML;
}

// â”€â”€ SCHEDULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scheduleHTML(isAdmin){
  if(isAdmin){
    var date=S.selectedDate;
    if(!date) return '<div class="card"><h2>ğŸ† Court Assignments</h2><div class="alert alert-info">No date available.</div></div>';
    var sess=getSession(date);
    if(sess.playersChoice) return playersChoiceCourtGrid(sess, date, true);
    if(!sess.assignments) return '<div class="card"><h2>ğŸ† Court Assignments</h2><div class="alert alert-info">No assignments generated yet.</div></div>';
    var inP=getInPlayers(date);
    var hlOpts='<option value="">-- Select your name --</option>';
    for(var i=0;i<inP.length;i++) hlOpts+='<option value="'+inP[i].id+'">'+fmtId(inP[i].id)+' - '+esc(inP[i].name)+'</option>';
    var mcHTML=matchCountsSummaryHTML(sess,inP);
    var tbWinnerHTML=sess.teamBattle?teamBattleWinnerHTML(sess):'';
    return '<div class="card"><h2>ğŸ† Court Assignments â€” '+fmtDate(date)+'</h2>'      +'<div style="background:#fffde7;border:1.5px solid #f5a623;border-radius:8px;padding:8px 12px;margin-bottom:12px">'      +'<label>ğŸ” Highlight My Matches</label><select id="hl-sel">'+hlOpts+'</select></div>'      +tbWinnerHTML+mcHTML      +'<div id="rounds-display">'+roundsHTML(sess,date,null)+'</div></div>';
  }

  // â”€â”€ USER VIEW: session history pulldown â”€â”€
  var allDates=[];
  Object.keys(S.seasons||{}).forEach(function(s){
    (S.seasons[s]||[]).forEach(function(d){
      var se=S.sessions[d]; if(!se) return;
      var hasA=se.assignments&&se.assignments.rounds;
      if(se.playersChoice&&hasA){ allDates.push(d); return; }
      if(se.teamBattle){ allDates.push(d); return; }
      if(hasA&&se.posted) allDates.push(d);
    });
  });
  allDates.sort();

  var defaultDate=allDates.length?allDates[allDates.length-1]:null;
  var selDate=S._scheduleViewDate&&allDates.indexOf(S._scheduleViewDate)>=0?S._scheduleViewDate:defaultDate;
  S._scheduleViewDate=selDate;

  var pickerHTML='';
  if(allDates.length>1){
    pickerHTML='<div class="card" style="padding:10px 14px;margin-bottom:0">';
    pickerHTML+='<label style="font-size:.85rem;font-weight:700;display:block;margin-bottom:6px">ğŸ“… View Session</label>';
    pickerHTML+='<select id="schedule-date-sel" style="width:100%;padding:8px;border-radius:6px;border:1.5px solid #ccc;font-size:.9rem">';
    for(var di=allDates.length-1;di>=0;di--){
      var d2=allDates[di], se2=S.sessions[d2];
      var tag=se2&&se2.teamBattle?' âš”ï¸':se2&&se2.playersChoice?' ğŸ¾':'';
      pickerHTML+='<option value="'+d2+'"'+( d2===selDate?' selected':'')+'>'+fmtDate(d2)+tag+'</option>';
    }
    pickerHTML+='</select></div>';
  }

  if(!selDate){
    return pickerHTML+'<div class="card"><h2>ğŸ† Court Assignments</h2><div class="alert alert-info">No sessions posted yet.</div></div>';
  }

  var sess=getSession(selDate);
  if(!sess) return pickerHTML+'<div class="card"><div class="alert alert-info">Session not found.</div></div>';

  if(sess.playersChoice){
    return pickerHTML+playersChoiceCourtGrid(sess, selDate, false);
  }

  if(sess.teamBattle){
    var tbHeader=teamBattleRostersHTML(sess);
    var tbWinner=teamBattleWinnerHTML(sess);
    if(!sess.assignments||!sess.assignments.rounds){
      return pickerHTML+tbHeader+'<div class="card"><h2>ğŸ† Court Assignments â€” '+fmtDate(selDate)+'</h2><div class="alert alert-info">Court assignments will appear here once generated by admin.</div></div>';
    }
    var inP2=getInPlayers(selDate);
    var hlOpts2='<option value="">-- Select your name --</option>';
    for(var i=0;i<inP2.length;i++) hlOpts2+='<option value="'+inP2[i].id+'">'+fmtId(inP2[i].id)+' - '+esc(inP2[i].name)+'</option>';
    return pickerHTML+tbHeader+'<div class="card"><h2>ğŸ† Court Assignments â€” '+fmtDate(selDate)+'</h2>'      +'<div style="background:#fffde7;border:1.5px solid #f5a623;border-radius:8px;padding:8px 12px;margin-bottom:12px">'      +'<label>ğŸ” Highlight My Matches</label><select id="hl-sel">'+hlOpts2+'</select></div>'      +tbWinner+matchCountsSummaryHTML(sess,inP2)      +'<div id="rounds-display">'+roundsHTML(sess,selDate,null)+'</div></div>';
  }

  var inP=getInPlayers(selDate);
  var hlOpts='<option value="">-- Select your name --</option>';
  for(var i=0;i<inP.length;i++) hlOpts+='<option value="'+inP[i].id+'">'+fmtId(inP[i].id)+' - '+esc(inP[i].name)+'</option>';
  return pickerHTML+'<div class="card"><h2>ğŸ† Court Assignments â€” '+fmtDate(selDate)+'</h2>'    +'<div style="background:#fffde7;border:1.5px solid #f5a623;border-radius:8px;padding:8px 12px;margin-bottom:12px">'    +'<label>ğŸ” Highlight My Matches</label><select id="hl-sel">'+hlOpts+'</select></div>'    +matchCountsSummaryHTML(sess,inP)    +'<div id="rounds-display">'+roundsHTML(sess,selDate,null)+'</div></div>';
}

// Renders just the two team roster cards (used in scheduleHTML for teamBattle)
function teamBattleRostersHTML(sess){
  var teamA=sess.teamA||[], teamB=sess.teamB||[];
  var h='<div class="card"><h2>âš”ï¸ Team Battle Rosters</h2>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  // Team A
  h+='<div style="border:2px solid #1e40af;border-radius:8px;overflow:hidden">'
    +'<div style="background:#1e40af;color:#fff;padding:8px 12px;font-weight:700;font-size:.9rem">ğŸ”µ Team A ('+teamA.length+')</div>'
    +'<div style="padding:10px">';
  if(teamA.length){
    for(var i=0;i<teamA.length;i++){
      var p=getPlayer(teamA[i]);
      var isCap=(teamA[i]===sess.captainA);
      h+='<div style="padding:3px 0;font-size:.88rem;font-weight:'+(isCap?'700':'400')+'">'+(isCap?'ğŸ‘‘ ':'')+esc(p?p.name:fmtId(teamA[i]))+'</div>';
    }
  } else { h+='<div style="color:#aaa;font-size:.82rem">No players yet</div>'; }
  h+='</div></div>';
  // Team B
  h+='<div style="border:2px solid #991b1b;border-radius:8px;overflow:hidden">'
    +'<div style="background:#991b1b;color:#fff;padding:8px 12px;font-weight:700;font-size:.9rem">ğŸ”´ Team B ('+teamB.length+')</div>'
    +'<div style="padding:10px">';
  if(teamB.length){
    for(var i=0;i<teamB.length;i++){
      var p=getPlayer(teamB[i]);
      var isCap=(teamB[i]===sess.captainB);
      h+='<div style="padding:3px 0;font-size:.88rem;font-weight:'+(isCap?'700':'400')+'">'+(isCap?'ğŸ‘‘ ':'')+esc(p?p.name:fmtId(teamB[i]))+'</div>';
    }
  } else { h+='<div style="color:#aaa;font-size:.82rem">No players yet</div>'; }
  h+='</div></div>';
  h+='</div></div>';
  return h;
}

// Shown on Court Assignments tab for teamBattle before assignments are generated
function teamBattleUserCard(sess, date, isAdmin){
  var h=teamBattleRostersHTML(sess);
  h+='<div class="card"><h2>ğŸ† Court Assignments â€” '+fmtDate(date)+'</h2>'
    +'<div class="alert alert-info">Court assignments will appear here once the admin generates the schedule.</div>'
    +'</div>';
  return h;
}
function roundsHTML(sess,date,hid){
  if(!sess||!sess.assignments||!Array.isArray(sess.assignments.rounds)) return '';
  var scores=sess.scores||{}, out='', rounds=sess.assignments.rounds;
  var noByePids=sess.noByePids||[];
  var lockedTeams=sess.lockedTeams||[];
  // Build a set of all locked player ids
  var lockedPidSet={};
  for(var li=0;li<lockedTeams.length;li++) for(var lj=0;lj<lockedTeams[li].length;lj++) lockedPidSet[lockedTeams[li][lj]]=true;
  // Helper: is this team a locked team?
  function isLockedTeam(team){
    if(!team||team.length<2) return false;
    for(var li=0;li<lockedTeams.length;li++){
      var lt=lockedTeams[li];
      if(lt.length!==team.length) continue;
      var match=true;
      for(var lx=0;lx<team.length;lx++){
        var found=false;
        for(var lz=0;lz<lt.length;lz++){ if(lt[lz]==team[lx]){ found=true; break; } }
        if(!found){ match=false; break; }
      }
      if(match) return true;
    }
    return false;
  }
  for(var ri=0;ri<rounds.length;ri++){
    var round=rounds[ri]; if(!round||!Array.isArray(round.courts)) continue;
    out+='<div class="round-block"><div class="round-title">Round '+(ri+1)+'</div><div class="courts-row">';
    for(var ci=0;ci<round.courts.length;ci++){
      var court=round.courts[ci]; if(!court||!Array.isArray(court.teams)) continue;
      var hasMe=false;
      if(hid!=null) for(var t=0;t<court.teams.length;t++) if(Array.isArray(court.teams[t])&&court.teams[t].indexOf(hid)>=0){ hasMe=true; break; }
      var scoreKey=ri+'_'+ci, sc=scores[scoreKey]||null;
      out+='<div class="court-card'+(hasMe?' hl-court':'')+'">'
        +'<div class="court-header'+(hasMe?' hl-hdr':'')+'">Court '+(ci+1)+'</div>'
        +'<div class="court-body">';
      for(var ti=0;ti<court.teams.length;ti++){
        var team=court.teams[ti]; if(!Array.isArray(team)) continue;
        var teamScore = sc ? (ti===0 ? sc.t1 : sc.t2) : null;
        var otherScore = sc ? (ti===0 ? sc.t2 : sc.t1) : null;
        var isWinner = sc && parseInt(teamScore) > parseInt(otherScore);
        var teamLocked = isLockedTeam(team);
        var tbLabel='';
        if(sess.teamBattle&&sess.assignments&&sess.assignments.mode==='teamBattle'){
          var teamAIds=sess.teamA||[], teamBIds=sess.teamB||[];
          var isTA=team.some(function(pid){ return teamAIds.some(function(id){ return id==pid; }); });
          tbLabel=isTA?'<span style="color:#1e40af;font-weight:700;font-size:.78rem">ğŸ”µ Team A</span>':'<span style="color:#991b1b;font-weight:700;font-size:.78rem">ğŸ”´ Team B</span>';
        }
        out+='<div class="team"><div class="team-row"><div class="team-label" style="margin:0">'+(tbLabel||('Team '+(ti+1)+(teamLocked?' ğŸ”’':'')))+'</div>';
        out+='<span class="team-score'+(sc ? (isWinner ? ' winner' : '') : ' empty')+'">'+(sc ? esc(teamScore) : 'â€”')+'</span>';
        out+='</div><div style="margin-top:4px">';
        for(var pi=0;pi<team.length;pi++){
          var pid2=team[pi], tp=getPlayer(pid2);
          var earlyLeave=noByePids.indexOf(pid2)>=0;
          out+='<span class="player-chip'+(pid2===hid?' hl':'')+'">'+(earlyLeave?'âš¡ ':'')+fmtId(pid2)+' '+(tp?esc(tp.name):'?')+'</span>';
        }
        out+='</div></div>';
        if(ti===0&&court.teams.length>1) out+='<div class="vs">VS</div>';
      }
      out+='<div class="score-row">';
      if(sess.scoresLocked){
        out+='<button class="btn btn-secondary btn-sm" style="color:#999;cursor:default" disabled>ğŸ”’ Locked</button>';
      } else {
        out+='<button class="btn btn-secondary btn-sm" data-score-btn data-date="'+esc(date)+'" data-round="'+ri+'" data-court="'+ci+'">'+(sc?'âœï¸ Edit Score':'+ Score')+'</button>';
      }
      out+='</div></div></div>';
    }
    out+='</div>';
    if(Array.isArray(round.byes)&&round.byes.length){
      out+='<div class="bye-row">â¸ Sitting out: ';
      for(var bi=0;bi<round.byes.length;bi++){
        var bpid=round.byes[bi], bp=getPlayer(bpid);
        out+='<span class="player-chip bye-chip'+(bpid===hid?' hl':'')+'">'+fmtId(bpid)+' '+(bp?esc(bp.name):'?')+'</span>';
      }
      out+='</div>';
    }
    out+='</div>';
  }
  return out;
}
function bindScoreButtons(){
  document.querySelectorAll('[data-score-btn]').forEach(function(b){
    b.addEventListener('click',function(){
      var date=b.dataset.date, ri=parseInt(b.dataset.round), ci=parseInt(b.dataset.court);
      if(date&&!isNaN(ri)&&!isNaN(ci)) openScoreModal(date,ri,ci);
    });
  });
}
function bindHighlightSelect(){
  var hsel=byId('hl-sel'); if(!hsel) return;
  hsel.addEventListener('change',function(){
    var hid=parseInt(hsel.value)||null;
    var date=S.isAdmin?S.selectedDate:getActiveSession(); if(!date) return;
    var sess=getSession(date), el=byId('rounds-display');
    if(el){ el.innerHTML=roundsHTML(sess,date,hid); bindScoreButtons(); }
  });
}

// â”€â”€ SCORE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openScoreModal(date,ri,ci){
  var sess=getSession(date);
  if(!sess.assignments||!Array.isArray(sess.assignments.rounds)) return;
  var round=sess.assignments.rounds[ri]; if(!round||!Array.isArray(round.courts)) return;
  var court=round.courts[ci]; if(!court||!Array.isArray(court.teams)) return;
  var key=ri+'_'+ci, sc=sess.scores[key]||{t1:'',t2:''};
  function teamName(team){ if(!Array.isArray(team)) return 'Team'; var n=[]; for(var i=0;i<team.length;i++){ var p=getPlayer(team[i]); n.push(p?p.name:fmtId(team[i])); } return n.join(' & '); }
  var t1=teamName(court.teams[0])||'Team 1', t2=teamName(court.teams[1])||'Team 2';
  var clrBtn=(sc.t1!=='')?'<button class="btn btn-danger btn-sm" id="sc-clear">Clear</button>':'';
  showModal('<h3>ğŸ“ Score â€” Court '+(ci+1)+', Round '+(ri+1)+'</h3>'
    +'<div class="score-input-wrap"><span class="score-team-lbl">'+esc(t1)+'</span><input id="sc-t1" type="number" min="0" max="99" value="'+esc(sc.t1)+'" placeholder="0"></div>'
    +'<div style="text-align:center;font-weight:700;color:#888;margin:4px 0">VS</div>'
    +'<div class="score-input-wrap"><span class="score-team-lbl">'+esc(t2)+'</span><input id="sc-t2" type="number" min="0" max="99" value="'+esc(sc.t2)+'" placeholder="0"></div>'
    +'<div class="modal-btns">'+clrBtn+'<button class="btn btn-secondary" id="sc-cancel">Cancel</button><button class="btn btn-primary" id="sc-save">Save Score</button></div>');
  byId('sc-cancel').addEventListener('click',closeModal);
  var clr=byId('sc-clear');
  if(clr) clr.addEventListener('click',function(){ delete sess.scores[key]; S.sessions[date]=sess; rebuildSeasonStats(S.currentSeason); save(); closeModal(); render(); showToast('Score cleared.'); });
  byId('sc-save').addEventListener('click',function(){
    var v1=byId('sc-t1').value.trim(), v2=byId('sc-t2').value.trim();
    if(v1===''||v2===''){ showToast('Please enter scores for both teams.'); return; }
    sess.scores[key]={t1:v1,t2:v2}; S.sessions[date]=sess; rebuildSeasonStats(S.currentSeason); save(); closeModal(); render(); showToast('Score saved!');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function adminHTML(){
  var tabs=['roster','calendar','session','byes'], labels=['Roster','Calendar','Session','Stats'];
  var h='<div class="tabs">';
  for(var i=0;i<tabs.length;i++) h+='<button class="tab'+(S.adminTab===tabs[i]?' active':'')+'" data-atab="'+tabs[i]+'">'+labels[i]+'</button>';
  h+='</div>';
  if(S.adminTab==='roster') h+=rosterHTML();
  else if(S.adminTab==='calendar') h+=calendarHTML();
  else if(S.adminTab==='session') h+=sessionHTML();
  else if(S.adminTab==='byes') h+=byesHTML();
  return h;
}
function bindAdmin(){
  document.querySelectorAll('[data-atab]').forEach(function(b){
    b.addEventListener('click',function(){ S.adminTab=b.dataset.atab; saveLocalPrefs(); render(); });
  });
  var addBtn=byId('add-player-btn'); if(addBtn) addBtn.addEventListener('click',function(){ openPlayerModal(null); });
  var syncBtn=byId('sync-btn'); if(syncBtn) syncBtn.addEventListener('click',openSheetSync);
  var exportBtn=byId('export-btn'); if(exportBtn) exportBtn.addEventListener('click',exportCSV);
  var clearStatsBtn=byId('clear-stats-btn'); if(clearStatsBtn) clearStatsBtn.addEventListener('click',openClearStats);
  var exportStatsBtn=byId('export-stats-btn'); if(exportStatsBtn) exportStatsBtn.addEventListener('click',exportStats);
  var importStatsBtn=byId('import-stats-btn'); if(importStatsBtn) importStatsBtn.addEventListener('click',openImportStats);
  var attBtn=byId('att-btn'); if(attBtn) attBtn.addEventListener('click',openAttendanceModal);
  var cfgSave=byId('cfg-save-btn'); if(cfgSave) cfgSave.addEventListener('click',savePointsConfig);
  var exclBtn=byId('cfg-exclude-outliers-btn');
  if(exclBtn) exclBtn.addEventListener('click',function(){
    if(!S.pointsConfig) S.pointsConfig={matchWin:3,gameWin:1,attendance:1};
    S.pointsConfig.excludeOutliers=!S.pointsConfig.excludeOutliers;
    save(); render(); showToast('Exclude outliers: '+(S.pointsConfig.excludeOutliers?'ON':'OFF'));
  });
  document.querySelectorAll('[data-edit-pid]').forEach(function(b){
    b.addEventListener('click',function(){ openPlayerModal(parseInt(b.dataset.editPid)); });
  });
  document.querySelectorAll('[data-del-pid]').forEach(function(b){
    b.addEventListener('click',function(){
      var id=parseInt(b.dataset.delPid), p=getPlayer(id);
      showModal('<h3>Remove Player</h3><p style="margin-bottom:16px">Remove <strong>'+(p?esc(p.name):'this player')+'</strong>?</p>'
        +'<div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Cancel</button><button class="btn btn-danger" id="m-confirm">Remove</button></div>');
      byId('m-cancel').addEventListener('click',closeModal);
      byId('m-confirm').addEventListener('click',function(){ S.players=S.players.filter(function(x){ return x.id!==id; }); save(); closeModal(); });
    });
  });
  document.querySelectorAll('[data-season-btn]').forEach(function(b){
    b.addEventListener('click',function(){ S.currentSeason=b.dataset.seasonBtn; save(); saveLocalPrefs(); render(); });
  });
  document.querySelectorAll('[data-cal-date]').forEach(function(b){
    b.addEventListener('click',function(){
      var key=b.dataset.calDate, s=S.currentSeason;
      if(!S.seasons[s]) S.seasons[s]=[];
      var idx=S.seasons[s].indexOf(key);
      if(idx>=0) S.seasons[s].splice(idx,1); else S.seasons[s].push(key);
      save(); render();
    });
  });
  document.querySelectorAll('[data-cal-nav]').forEach(function(b){
    b.addEventListener('click',function(){
      var parts=b.dataset.calNav.split('-');
      S._calYear=parseInt(parts[0]); S._calMonth=parseInt(parts[1]);
      render();
    });
  });
  document.querySelectorAll('[data-cal-remove]').forEach(function(b){
    b.addEventListener('click',function(){
      var key=b.dataset.calRemove, s=S.currentSeason;
      if(!S.seasons[s]) return;
      var idx=S.seasons[s].indexOf(key);
      if(idx>=0){ S.seasons[s].splice(idx,1); save(); render(); }
    });
  });
  var dateSel=byId('session-date-sel');
  if(dateSel) dateSel.addEventListener('change',function(){ S.selectedDate=dateSel.value; saveLocalPrefs(); render(); });
  ['s-type','s-rotate','s-courts','s-matches'].forEach(function(id){
    var el=byId(id); if(el) el.addEventListener('change',saveSessionSettings);
  });
  var genBtn=byId('gen-btn'); if(genBtn) genBtn.addEventListener('click',generateAssignments);
  var clearAssignBtn=byId('clear-assign-btn'); if(clearAssignBtn) clearAssignBtn.addEventListener('click',function(){
    var date=S.selectedDate; if(!date) return;
    var sess=getSession(date);
    sess.assignments=null; sess.scores={}; sess.posted=false;
    S.sessions[date]=sess; save(); showToast('Court assignment cleared.'); render();
  });
  var lockScoresBtn=byId('lock-scores-btn');
  if(lockScoresBtn) lockScoresBtn.addEventListener('click',function(){
    var date=S.selectedDate; if(!date) return;
    var sess=getSession(date);
    sess.scoresLocked=!sess.scoresLocked;
    S.sessions[date]=sess; save();
    showToast(sess.scoresLocked?'Scores locked.':'Scores unlocked.');
    render();
  });
  var mpBtn=byId('manual-partners-btn'); if(mpBtn) mpBtn.addEventListener('click',openManualPartnersModal);
  var aaOptBtn=byId('aa-options-btn'); if(aaOptBtn) aaOptBtn.addEventListener('click',openAutoAssignOptions);
  var tbBtn=byId('team-battle-btn'); if(tbBtn) tbBtn.addEventListener('click',openTeamBattleSetup);
  var pcaBtn=byId('players-choice-admin-btn'); if(pcaBtn) pcaBtn.addEventListener('click',openPlayersChoiceAdmin);
  var postBtn=byId('post-btn');
  if(postBtn) postBtn.addEventListener('click',function(){
    var date=S.selectedDate; if(!date) return;
    var sess=getSession(date); sess.posted=!sess.posted;
    S.sessions[date]=sess; save();
  });
  document.querySelectorAll('[data-rsvp-pid]').forEach(function(b){
    b.addEventListener('click',function(){
      var pid=parseInt(b.dataset.rsvpPid), status=b.dataset.rsvpStatus;
      if(!S.selectedDate) return;
      var sess=getSession(S.selectedDate);
      sess.rsvps[pid]=status;
      S.sessions[S.selectedDate]=sess; save();
    });
  });
  bindScoreButtons(); bindHighlightSelect(); bindStatsControls();
}

// â”€â”€ ROSTER HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rosterHTML(){
  var h='<div class="card"><h2>ğŸ‘¥ Player Roster</h2>'
    +'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">'
    +'<button class="btn btn-primary" id="add-player-btn">+ Add Player</button>'
    +'<button class="btn btn-secondary" id="sync-btn">Copy from .CSV</button>'
    +'<button class="btn btn-secondary" id="export-btn">Export .CSV</button>'
    +'</div>';
  if(!S.players.length){
    h+='<div class="alert alert-info">No players yet. Add players or import from CSV.</div>';
  } else {
    h+='<table><tr><th>ID</th><th>Name</th><th>USTA</th><th>Member Status</th><th>Fee Paid</th><th>Actions</th></tr>';
    for(var i=0;i<S.players.length;i++){
      var p=S.players[i];
      var ms=p.memberStatus||'Active';
      var msBadge=ms==='Active'?'badge-in':ms==='Inactive'?'badge-out':'';
      h+='<tr><td>'+fmtId(p.id)+'</td><td>'+esc(p.name)+'</td><td>'+esc(p.usta)+'</td>'
        +'<td><span class="badge '+msBadge+'">'+esc(ms)+'</span></td>'
        +'<td>$'+(p.fees||0)+'</td>'
        +'<td style="white-space:nowrap">'
        +'<button class="btn btn-secondary btn-sm" data-edit-pid="'+p.id+'">Edit</button> '
        +'<button class="btn btn-danger btn-sm" data-del-pid="'+p.id+'">Del</button>'
        +'</td></tr>';
    }
    h+='</table>';
  }
  return h+'</div>';
}

// â”€â”€ CALENDAR HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calendarHTML(){
  var s=S.currentSeason, activeArr=S.seasons[s]||[], activeSet={};
  for(var i=0;i<activeArr.length;i++) activeSet[activeArr[i]]=true;
  var now=new Date();
  if(S._calYear===undefined||S._calYear===null) S._calYear=now.getFullYear();
  if(S._calMonth===undefined||S._calMonth===null) S._calMonth=now.getMonth();
  var yr=S._calYear, mo=S._calMonth;
  var prevYr=mo===0?yr-1:yr, prevMo=mo===0?11:mo-1;
  var nextYr=mo===11?yr+1:yr, nextMo=mo===11?0:mo+1;
  var monthLabel=new Date(yr,mo,1).toLocaleString('en-US',{month:'long',year:'numeric'});
  var h='<div class="card"><h2>ğŸ“† Season Calendar</h2>';
  h+='<div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">';
  for(var si=0;si<SEASONS.length;si++) h+='<button class="season-btn'+(SEASONS[si]===s?' active':'')+'" data-season-btn="'+SEASONS[si]+'">'+SEASONS[si]+'</button>';
  h+='</div>';
  h+='<div class="alert alert-info" style="margin-bottom:12px">Click any date to add/remove it from the <strong>'+s+'</strong> season. Saturdays are highlighted.</div>';
  h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">'
    +'<button class="btn btn-secondary btn-sm" data-cal-nav="'+prevYr+'-'+prevMo+'">&#9664; Prev</button>'
    +'<strong style="font-size:1rem;color:#1a5c2a">'+monthLabel+'</strong>'
    +'<button class="btn btn-secondary btn-sm" data-cal-nav="'+nextYr+'-'+nextMo+'">Next &#9654;</button>'
    +'</div>';
  h+='<div class="calendar-grid">';
  var dayLabels=['Su','Mo','Tu','We','Th','Fr','Sa'];
  for(var dl=0;dl<7;dl++) h+='<div class="cal-day cal-hdr">'+dayLabels[dl]+'</div>';
  var first=new Date(yr,mo,1).getDay();
  for(var fi=0;fi<first;fi++) h+='<div class="cal-day"></div>';
  var dim=new Date(yr,mo+1,0).getDate();
  for(var d=1;d<=dim;d++){
    var isSat=new Date(yr,mo,d).getDay()===6;
    var moStr=mo+1<10?'0'+(mo+1):''+(mo+1), dStr=d<10?'0'+d:''+d, key=yr+'-'+moStr+'-'+dStr;
    var isActive=activeSet[key];
    h+='<div class="cal-day cal-sat'+(isActive?' active':'')+(isSat?' cal-sat-hl':'')+'" data-cal-date="'+key+'">'+d+'</div>';
  }
  h+='</div>';
  var seasonDates=(S.seasons[s]||[]).slice().sort();
  if(seasonDates.length){
    h+='<div style="margin-top:14px;border-top:2px solid #e8f5e9;padding-top:10px">'
      +'<div style="font-weight:700;font-size:.85rem;color:#1a5c2a;margin-bottom:6px">&#128197; '+s+' Season Dates ('+seasonDates.length+')</div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:6px">';
    for(var di=0;di<seasonDates.length;di++){
      h+='<span style="background:#e8f5e9;color:#1a5c2a;border-radius:14px;padding:3px 10px;font-size:.82rem;font-weight:600;display:inline-flex;align-items:center;gap:4px">'
        +esc(fmtDate(seasonDates[di]))
        +' <button data-cal-remove="'+seasonDates[di]+'" style="background:none;border:none;cursor:pointer;color:#721c24;font-size:.85rem;padding:0;line-height:1" title="Remove">&#x2715;</button>'
        +'</span>';
    }
    h+='</div></div>';
  } else {
    h+='<div style="margin-top:10px;color:#aaa;font-size:.85rem">No dates selected for '+esc(s)+' season yet.</div>';
  }
  return h+'</div>';
}

// â”€â”€ SESSION HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sessionHTML(){
  var dates=(S.seasons[S.currentSeason]||[]).slice().sort();
  if(!dates.length) return '<div class="card"><h2>âš™ï¸ Session Setup</h2><div class="alert alert-info">No dates scheduled. Add dates in the Calendar tab.</div></div>';
  if(!S.selectedDate||dates.indexOf(S.selectedDate)<0) S.selectedDate=dates[0];
  var date=S.selectedDate, sess=getSession(date), inP=getInPlayers(date), allR=sess.rsvps;
  var ppCourt=sess.type==='singles'?2:4;
  var playPerRound=Math.min(inP.length,sess.courts*ppCourt);
  var activeCourts=Math.floor(playPerRound/ppCourt);
  var rounds=inP.length>=ppCourt?Math.ceil((inP.length*sess.matchesPerPlayer)/Math.max(1,playPerRound)):0;
  var dateOpts='';
  for(var i=0;i<dates.length;i++) dateOpts+='<option value="'+dates[i]+'"'+(dates[i]===date?' selected':'')+'>'+fmtDate(dates[i])+'</option>';
  var rsvpRows='';
  for(var i=0;i<S.players.length;i++){
    var p=S.players[i], st=allR[p.id]||'â€”';
    rsvpRows+='<tr><td>'+fmtId(p.id)+'</td><td>'+esc(p.name)+'</td><td>'+esc(p.usta)+'</td>'
      +'<td><span class="badge '+(st==='IN'?'badge-in':st==='OUT'?'badge-out':'')+'">'+( st==='â€”'?'Not Submitted':st)+'</span></td>'
      +'<td style="white-space:nowrap">'
      +'<button class="btn btn-primary btn-sm" data-rsvp-pid="'+p.id+'" data-rsvp-status="IN">IN</button> '
      +'<button class="btn btn-danger btn-sm" data-rsvp-pid="'+p.id+'" data-rsvp-status="OUT">OUT</button>'
      +'</td></tr>';
  }
  var infoBar=inP.length>=ppCourt
    ?'<div class="alert alert-info">ğŸ“Š <strong>'+inP.length+'</strong> players IN â†’ <strong>'+rounds+'</strong> rounds on <strong>'+activeCourts+'</strong> courts</div>'
    :'<div class="alert alert-warn">Need at least '+ppCourt+' players marked IN to generate assignments.</div>';
  var postBtnHTML=sess.assignments
    ?'<button class="btn '+(sess.posted?'btn-danger':'btn-green')+'" id="post-btn">'+(sess.posted?'Unpost from Users':'Post to Users')+'</button>':'';
  var tbRosterAlert='';
  if(sess.teamBattle&&sess.captainA&&sess.captainB){
    var rA=sess.teamA&&sess.teamA.length>0, rB=sess.teamB&&sess.teamB.length>0;
    if(rA&&rB&&!sess.assignments){
      tbRosterAlert='<div style="background:#d4edda;border:2px solid #1a5c2a;border-radius:8px;padding:10px 14px;margin-bottom:12px">'
        +'<div style="font-weight:700;color:#155724;margin-bottom:4px">ğŸ‰ Both team rosters submitted!</div>'
        +'<div style="font-size:.85rem;color:#155724">Team A: '+sess.teamA.length+' players Â· Team B: '+sess.teamB.length+' players. Click <strong>Generate Court Assignment</strong> to create the schedule.</div>'
        +'</div>';
    } else if(!rA||!rB){
      tbRosterAlert='<div style="background:#fff3cd;border:1.5px solid #e6ac00;border-radius:8px;padding:8px 12px;margin-bottom:12px;font-size:.85rem">'
        +'â³ Waiting for captain rosters: '+(rA?'âœ… Team A':'âŒ Team A')+' Â· '+(rB?'âœ… Team B':'âŒ Team B')
        +'</div>';
    }
  }
  var h='<div class="card"><h2>âš™ï¸ Session Setup</h2>'
    +'<label>Select Date</label><select id="session-date-sel">'+dateOpts+'</select>'
    +tbRosterAlert
    +'<div class="card" style="border:1.5px solid #e8f5e9"><h2>RSVP List</h2>'
    +(S.players.length
      ?'<table><tr><th>ID</th><th>Name</th><th>USTA</th><th>Status</th><th>Set</th></tr>'+rsvpRows+'</table>'
       +'<div style="margin-top:8px;font-weight:700;color:#1a5c2a">IN: '+inP.length+' players</div>'
      :'<div class="alert alert-info">No players in roster.</div>')
    +'</div>'
    +'<div class="card" style="border:1.5px solid #e8f5e9"><h2>Settings</h2>'
    +'<div class="form-row">'
    +'<div><label>Match Type</label><select id="s-type"><option value="singles"'+(sess.type==='singles'?' selected':'')+'>Singles</option><option value="doubles"'+(sess.type==='doubles'?' selected':'')+'>Doubles</option></select></div>'
    +'<div id="rot-wrap"'+(sess.type==='singles'?' style="display:none"':'')+'><label>Mode</label><select id="s-rotate">'+'<option value="0"'+(!sess.rotatePartners&&!sess.manualPartners&&!sess.teamBattle&&!sess.playersChoice?' selected':'')+'>AutoAssign: pair with same partner</option>'+'<option value="1"'+(sess.rotatePartners&&!sess.teamBattle&&!sess.playersChoice?' selected':'')+'>AutoAssign: pair with different partners</option>'+'<option value="manual"'+(sess.manualPartners&&!sess.teamBattle&&!sess.playersChoice?' selected':'')+'>Manual (Admin assigns)</option>'+'<option value="teamBattle"'+(sess.teamBattle?' selected':'')+'>Team Battle (A vs B)</option>'+'<option value="playersChoice"'+(sess.playersChoice?' selected':'')+'>Players Choice</option>'+'</select></div>'
    +'</div><div class="form-row">'
    +'<div><label>Courts Available</label><input id="s-courts" type="number" min="1" max="20" value="'+sess.courts+'"></div>'
    +'<div><label>Matches per Player (1â€“8)</label><input id="s-matches" type="number" min="1" max="8" value="'+sess.matchesPerPlayer+'"></div>'
    +'</div>'+infoBar+'</div>'
    +'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">'
    +'<button class="btn btn-primary" id="gen-btn">ğŸ¾ Generate Court Assignment</button>'
    +(sess.assignments?'<button class="btn btn-danger" id="clear-assign-btn">ğŸ—‘ Clear Assignment</button>':'')
    +(sess.assignments?'<button class="btn '+(sess.scoresLocked?'btn-danger':'btn-secondary')+'" id="lock-scores-btn">'+(sess.scoresLocked?'ğŸ”’ Scores Locked':'ğŸ”“ Lock Scores')+'</button>':'')
    +(!sess.teamBattle&&!sess.playersChoice&&sess.type!=='singles'?'<button class="btn btn-secondary" id="aa-options-btn">âš™ï¸ AutoAssign Options</button>':'')
    +(sess.type!=='singles'?'<button class="btn btn-secondary" id="manual-partners-btn">âœ‹ Manually Assign Partners</button>':'')
    +(sess.teamBattle?'<button class="btn btn-secondary" id="team-battle-btn">âš”ï¸ Setup Team Battle</button>':'')
    +(sess.playersChoice?'<button class="btn btn-secondary" id="players-choice-admin-btn">ğŸ“‹ Submissions</button>':'')
    +postBtnHTML+'</div>';
  if(sess.assignments && !sess.playersChoice){
    var inp2=getInPlayers(date), hlOpts='<option value="">-- Select your name --</option>';
    for(var i=0;i<inp2.length;i++) hlOpts+='<option value="'+inp2[i].id+'">'+fmtId(inp2[i].id)+' - '+esc(inp2[i].name)+'</option>';
    h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">'
      +'<strong style="color:#1a5c2a">Assignment Preview</strong>'
      +'<span class="badge '+(sess.posted?'badge-in':'badge-out')+'">'+(sess.posted?'POSTED':'NOT POSTED')+'</span></div>'
      +'<div style="background:#fffde7;border:1.5px solid #f5a623;border-radius:8px;padding:8px 12px;margin-bottom:12px">'
      +'<label>ğŸ” Highlight My Matches</label><select id="hl-sel">'+hlOpts+'</select></div>'
      +matchCountsSummaryHTML(sess,inp2)
      +(sess.teamBattle?teamBattleWinnerHTML(sess):'')
      +'<div id="rounds-display">'+roundsHTML(sess,date,null)+'</div>';
  }
  if(sess.playersChoice){
    // Check if enough players submitted to show generate reminder
    var pcSubs=sess.pcSubmissions||{};
    var pcSubCount=Object.keys(pcSubs).length;
    var inPcount=getInPlayers(date).length;
    // Check if this is round 1 (no assignments yet)
    var currentRoundIdx=sess.assignments&&sess.assignments.rounds?sess.assignments.rounds.length:0;
    if(currentRoundIdx===0){
      // Round 1: need to auto-generate
      var pcReady=pcSubCount>0&&pcSubCount>=Math.max(1,Math.floor(inPcount*0.5));
      if(pcReady||inPcount>0){
        h+='<div style="background:#d4edda;border:2px solid #1a5c2a;border-radius:8px;padding:10px 14px;margin-bottom:10px">';
        h+='<div style="font-weight:700;color:#155724">ğŸ¾ Ready to generate Round 1</div>';
        h+='<div style="font-size:.83rem;color:#155724;margin-top:2px">Round 1 will be auto-assigned with different partners. Click <strong>Generate Court Assignment</strong> to create it.</div>';
        h+='</div>';
      }
    } else {
      // Round 2+: check if players have submitted for next round
      var nextRoundSubs=Object.keys(pcSubs).filter(function(pid){ var pr=pcSubs[pid]; return pr&&pr[currentRoundIdx]&&!pr[currentRoundIdx].auto; });
      var allSubmitted=nextRoundSubs.length>=inPcount;
      if(nextRoundSubs.length>0&&currentRoundIdx<(sess.matchesPerPlayer||4)){
        h+='<div style="background:'+(allSubmitted?'#d4edda':'#fff3cd')+';border:2px solid '+(allSubmitted?'#1a5c2a':'#e6ac00')+';border-radius:8px;padding:10px 14px;margin-bottom:10px">';
        h+='<div style="font-weight:700;color:'+(allSubmitted?'#155724':'#856404')+'">ğŸ“‹ Round '+(currentRoundIdx+1)+' Submissions: '+nextRoundSubs.length+'/'+inPcount+'</div>';
        if(allSubmitted){
          h+='<div style="font-size:.83rem;color:#155724;margin-top:2px">All players submitted! Click <strong>Generate Court Assignment</strong> to add Round '+(currentRoundIdx+1)+'.</div>';
        } else {
          h+='<div style="font-size:.83rem;color:#856404;margin-top:2px">Waiting for more submissions before generating Round '+(currentRoundIdx+1)+'.</div>';
        }
        h+='</div>';
      }
    }
    h+='<div id="pc-court-grid">'+playersChoiceCourtGrid(sess,date,true)+'</div>';
  }
  return h+'</div>';
}
function saveSessionSettings(){
  var date=S.selectedDate; if(!date) return;
  var sess=getSession(date);
  var t=byId('s-type'),r=byId('s-rotate'),c=byId('s-courts'),m=byId('s-matches');
  if(t) sess.type=t.value;
  if(r){
    var prevTeamBattle=sess.teamBattle;
    var prevMode=[sess.rotatePartners,sess.manualPartners,sess.teamBattle,sess.playersChoice].join(',');
    sess.rotatePartners=(r.value==='1');
    sess.manualPartners=(r.value==='manual');
    sess.teamBattle=(r.value==='teamBattle');
    sess.playersChoice=(r.value==='playersChoice');
    var newMode=[sess.rotatePartners,sess.manualPartners,sess.teamBattle,sess.playersChoice].join(',');
    if(prevMode!==newMode && sess.assignments){
      sess.assignments=null; sess.scores={}; sess.posted=false;
      showToast('Mode changed â€” court assignment cleared.');
    }
    // When switching INTO teamBattle, always reset teams so captains start fresh
    if(!prevTeamBattle && sess.teamBattle){
      sess.teamA=[]; sess.teamB=[]; sess.captainA=null; sess.captainB=null;
    }
    // When switching INTO playersChoice, clear all previous court info so users see a blank slate
    var prevPlayersChoice=(prevMode.split(',')[3]==='true');
    if(!prevPlayersChoice && sess.playersChoice){
      sess.assignments=null; sess.scores={}; sess.posted=false; sess.pcSubmissions={};
    }
  }
  if(c) sess.courts=Math.max(1,parseInt(c.value)||4);
  if(m) sess.matchesPerPlayer=Math.min(8,Math.max(1,parseInt(m.value)||4));
  var wrap=byId('rot-wrap'); if(wrap) wrap.style.display=(sess.type==='singles'?'none':'block');
  // Block same-partner mode when player count is odd (doubles only)
  if(r && r.value==='0' && sess.type!=='singles'){
    var inPcount=getInPlayers(date).length;
    if(inPcount%2!==0){
      r.value='1';
      sess.rotatePartners=true;
      showModal('<h3>âš ï¸ Cannot Use Same-Partner Mode</h3>'
        +'<div class="alert alert-info" style="margin-bottom:12px">'
        +'<strong>Pair Same Partner</strong> requires an even number of available (IN) players.<br><br>'
        +'Currently <strong>'+inPcount+' player'+(inPcount!==1?'s are':' is')+' marked IN</strong>. '
        +'Please add or remove a player\'s RSVP to make it even, then try again.'
        +'</div>'
        +'<div class="modal-btns"><button class="btn btn-primary" id="m-ok">OK</button></div>');
      byId('m-ok').addEventListener('click', closeModal);
      S.sessions[date]=sess; save(); return;
    }
  }
  S.sessions[date]=sess; save();
}

// â”€â”€ SESSION STATS BUILDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns {pid: {wins, losses, gamesWon, gamesLost, byes}} for one session date
function buildSessionStats(date, sess){
  var result={};
  if(!sess||!sess.assignments) return result;
  var scores=sess.scores||{};
  var rounds=sess.assignments.rounds||[];

  // Init all IN players
  var rsvps=sess.rsvps||{};
  for(var pid in rsvps){
    if(rsvps[pid]==='IN') result[pid]={wins:0,losses:0,gamesWon:0,gamesLost:0,byes:0};
  }

  // Byes
  for(var ri=0;ri<rounds.length;ri++){
    var round=rounds[ri]; if(!round) continue;
    var byes=round.byes||[];
    for(var bi=0;bi<byes.length;bi++){
      var bpid=String(byes[bi]);
      if(!result[bpid]) result[bpid]={wins:0,losses:0,gamesWon:0,gamesLost:0,byes:0};
      result[bpid].byes++;
    }
    // Match stats
    var courts=round.courts||[];
    for(var ci=0;ci<courts.length;ci++){
      var court=courts[ci]; if(!court||!court.teams||court.teams.length<2) continue;
      var key=ri+'_'+ci, sc=scores[key];
      if(!sc||sc.t1===''||sc.t2==='') continue;
      var s1=parseInt(sc.t1), s2=parseInt(sc.t2);
      if(isNaN(s1)||isNaN(s2)) continue;
      var team1=court.teams[0]||[], team2=court.teams[1]||[];
      var t1wins=s1>s2, t2wins=s2>s1;
      for(var pi=0;pi<team1.length;pi++){
        var pid2=String(team1[pi]);
        if(!result[pid2]) result[pid2]={wins:0,losses:0,gamesWon:0,gamesLost:0,byes:0};
        if(t1wins) result[pid2].wins++; else if(t2wins) result[pid2].losses++;
        result[pid2].gamesWon+=s1; result[pid2].gamesLost+=s2;
      }
      for(var pi=0;pi<team2.length;pi++){
        var pid3=String(team2[pi]);
        if(!result[pid3]) result[pid3]={wins:0,losses:0,gamesWon:0,gamesLost:0,byes:0};
        if(t2wins) result[pid3].wins++; else if(t1wins) result[pid3].losses++;
        result[pid3].gamesWon+=s2; result[pid3].gamesLost+=s1;
      }
    }
  }
  return result;
}

// â”€â”€ PARTNER STATS BUILDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns {partnerId: {matchWins, matchLosses, gamesWon, gamesLost, matches}} for a player across dates
function buildPartnerStats(focusPid, dates){
  var result={};
  var focusStr=String(focusPid);
  for(var di=0;di<dates.length;di++){
    var date=dates[di];
    var sess=S.sessions[date]; if(!sess||!sess.assignments) continue;
    var scores=sess.scores||{};
    var rounds=sess.assignments.rounds||[];
    for(var ri=0;ri<rounds.length;ri++){
      var round=rounds[ri]; if(!round) continue;
      var courts=round.courts||[];
      for(var ci=0;ci<courts.length;ci++){
        var court=courts[ci]; if(!court||!court.teams||court.teams.length<2) continue;
        var key=ri+'_'+ci, sc=scores[key];
        // Find which team focusPid is on (compare as strings to handle Firebase coercion)
        var myTeamIdx=-1;
        for(var ti=0;ti<court.teams.length;ti++){
          var team=court.teams[ti]||[];
          for(var pi=0;pi<team.length;pi++){
            if(String(team[pi])===focusStr){ myTeamIdx=ti; break; }
          }
          if(myTeamIdx>=0) break;
        }
        if(myTeamIdx<0) continue;
        var myTeam=court.teams[myTeamIdx]||[];
        var otherTeam=court.teams[1-myTeamIdx]||[];
        var s1=sc&&sc.t1!==''?parseInt(sc.t1):null;
        var s2=sc&&sc.t2!==''?parseInt(sc.t2):null;
        var myScore=sc?(myTeamIdx===0?s1:s2):null;
        var oppScore=sc?(myTeamIdx===0?s2:s1):null;
        var matchWin=myScore!==null&&oppScore!==null&&myScore>oppScore;
        var matchLoss=myScore!==null&&oppScore!==null&&myScore<oppScore;
        for(var pi=0;pi<myTeam.length;pi++){
          var partPid=myTeam[pi];
          if(String(partPid)===focusStr) continue;
          var pk=String(partPid);
          if(!result[pk]) result[pk]={matchWins:0,matchLosses:0,gamesWon:0,gamesLost:0,matches:0};
          result[pk].matches++;
          if(matchWin) result[pk].matchWins++;
          if(matchLoss) result[pk].matchLosses++;
          if(myScore!==null) result[pk].gamesWon+=myScore;
          if(oppScore!==null) result[pk].gamesLost+=oppScore;
        }
      }
    }
  }
  return result;
}

// â”€â”€ STATS HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPlayerStats(pid, season){
  if(!S.playerStats) S.playerStats={};
  if(!S.playerStats[pid]) S.playerStats[pid]={};
  if(!S.playerStats[pid][season]) S.playerStats[pid][season]={wins:0,losses:0,gamesWon:0,gamesLost:0};
  return S.playerStats[pid][season];
}

// Rebuild all stats for a season from scratch based on all saved scores
function rebuildSeasonStats(season){
  if(!S.playerStats) S.playerStats={};

  // Clear existing match stats AND attendance for this season
  for(var pid in S.playerStats){
    if(!S.playerStats[pid]||typeof S.playerStats[pid]!=='object') continue;
    if(S.playerStats[pid][season]) delete S.playerStats[pid][season];
    if(S.playerStats[pid][season+'_att'] !== undefined) S.playerStats[pid][season+'_att']=0;
  }

  var dates = S.seasons[season] || [];
  for(var di=0; di<dates.length; di++){
    var date = dates[di];
    var sess = S.sessions[date];
    if(!sess || !sess.assignments) continue;

    // Attendance: count each IN player once per session IF any score exists for that date
    var scores = sess.scores || {};
    var hasAnyScore = false;
    var scoreKeys = Object.keys(scores);
    for(var ski=0; ski<scoreKeys.length; ski++){
      var skv = scores[scoreKeys[ski]];
      if(skv && skv.t1!=='' && skv.t2!=='') { hasAnyScore=true; break; }
    }
    if(hasAnyScore){
      var rsvps = sess.rsvps || {};
      for(var rpid in rsvps){
        if(rsvps[rpid]==='IN'){
          var rpidInt = parseInt(rpid);
          if(!S.playerStats[rpidInt]) S.playerStats[rpidInt]={};
          S.playerStats[rpidInt][season+'_att'] = (S.playerStats[rpidInt][season+'_att']||0) + 1;
        }
      }
    }

    // Match/game stats from scores
    if(!sess.scores) continue;
    var rounds = sess.assignments.rounds || [];
    for(var ri=0; ri<rounds.length; ri++){
      var round = rounds[ri];
      if(!round || !round.courts) continue;
      for(var ci=0; ci<round.courts.length; ci++){
        var court = round.courts[ci];
        if(!court || !court.teams || court.teams.length < 2) continue;
        var key = ri+'_'+ci;
        var sc = sess.scores[key];
        if(!sc || sc.t1==='' || sc.t2==='') continue;
        var s1=parseInt(sc.t1), s2=parseInt(sc.t2);
        if(isNaN(s1)||isNaN(s2)) continue;
        var team1 = court.teams[0] || [], team2 = court.teams[1] || [];
        var t1wins = s1 > s2, t2wins = s2 > s1;
        for(var pi=0; pi<team1.length; pi++){
          var st = getPlayerStats(team1[pi], season);
          if(t1wins) st.wins++; else if(t2wins) st.losses++;
          st.gamesWon += s1; st.gamesLost += s2;
          if(!st.matchScores) st.matchScores=[];
          st.matchScores.push(s1);
        }
        for(var pi2=0; pi2<team2.length; pi2++){
          var st2 = getPlayerStats(team2[pi2], season);
          if(t2wins) st2.wins++; else if(t1wins) st2.losses++;
          st2.gamesWon += s2; st2.gamesLost += s1;
          if(!st2.matchScores) st2.matchScores=[];
          st2.matchScores.push(s2);
        }
      }
    }
  }
}

function calcTotalPoints(pid, season){
  if(!S.pointsConfig) S.pointsConfig={matchWin:3,gameWin:1,attendance:1};
  var cfg=S.pointsConfig;
  var st=getPlayerStats(pid,season);
  var att=(S.playerStats[pid]||{})[season+'_att']||0;
  var bonus=(S.playerStats[pid]||{})[season+'_bonus']||0;
  var wins=st.wins, gamesWon=st.gamesWon;
  // excludeOutliers: remove best and worst match scores from games-won calculation
  if(cfg.excludeOutliers&&cfg.gameWin>0&&st.matchScores&&st.matchScores.length>=3){
    var sorted=st.matchScores.slice().sort(function(a,b){ return a-b; });
    sorted.splice(0,1); // remove worst
    sorted.splice(sorted.length-1,1); // remove best
    gamesWon=sorted.reduce(function(acc,v){ return acc+v; },0);
  }
  return wins*cfg.matchWin + gamesWon*cfg.gameWin + att*cfg.attendance + bonus;
}

function byesHTML(){
  var season=S.currentSeason;
  if(!S.playerStats) S.playerStats={};
  if(!S.pointsConfig) S.pointsConfig={matchWin:3,gameWin:1,attendance:1};
  var cfg=S.pointsConfig;
  var isAdmin=S.isAdmin;

  // Stats view mode: 'yearly' | 'season_total' | 'per_session' | 'partners'
  var viewMode=S._statsView||'season_total';

  var h='<div class="card"><h2>ğŸ“Š Stats</h2>';

  // Points config (admin only)
  if(isAdmin){
    h+='<div class="card" style="border:1.5px solid #e8f5e9;margin-bottom:12px">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px">'
      +'<h2 style="margin:0">âš™ï¸ Points Configuration</h2>'
      +'<button class="btn btn-green btn-sm" id="cfg-save-btn">Save Points Config</button>'
      +'</div>'
      +'<div class="form-row">'
      +'<div><label>Points per Match Win</label><input id="cfg-match-win" type="number" min="0" value="'+cfg.matchWin+'"></div>'
      +'<div><label>Points per Game Won</label><input id="cfg-game-win" type="number" min="0" value="'+cfg.gameWin+'"></div>'
      +'<div><label>Points per Session Attended</label><input id="cfg-att" type="number" min="0" value="'+cfg.attendance+'"></div>'
      +'</div>'
      +'<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">'
      +'<button id="cfg-exclude-outliers-btn" type="button" class="btn btn-sm" style="border:2px solid '+(cfg.excludeOutliers?'#1a5c2a':'#ccc')+';background:'+(cfg.excludeOutliers?'#d4edda':'#fff')+';color:'+(cfg.excludeOutliers?'#155724':'#555')+';font-weight:'+(cfg.excludeOutliers?'700':'400')+'">'
          +(cfg.excludeOutliers?'âœ…':'â¬œ')+' Exclude Best &amp; Worst Match Scores</button>'
      +'<button class="btn btn-secondary btn-sm" id="bonus-pts-btn">ğŸ Award Bonus Points</button>'
      +'</div>'
      +'</div>';
  }

  if(isAdmin){
    h+='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">'
      +'<button class="btn btn-secondary" id="clear-stats-btn">ğŸ—‘ Clear Stats</button>'
      +'<button class="btn btn-secondary" id="export-stats-btn">Export Stats .CSV</button>'
      +'<button class="btn btn-secondary" id="import-stats-btn">ğŸ“¥ Import Stats</button>'
      +'<button class="btn btn-secondary" id="att-btn">Mark Attendance</button>'
      +'</div>';
  }

  if(!S.players.length){
    return h+'<div class="alert alert-info">No players in roster.</div></div>';
  }

  // View selector: Year | Season | Session | Partner Stats
  var partSubView=S._partnerSubView||'season_total';
  var allSeasons=Object.keys(S.seasons||{});
  var selYear=S._statsYear||season;
  var selSeasonForSession=S._statsSeasonForSession||season;
  h+='<div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;justify-content:space-between;align-items:flex-start">'
    +'<div style="display:flex;gap:8px;flex-wrap:wrap">'
    +'<button class="btn '+(viewMode==='custom_range'?'btn-green':'btn-secondary')+' btn-sm" data-stats-view="custom_range">ğŸ“… Custom Range</button>'
    +'<button class="btn '+(viewMode==='season_total'?'btn-green':'btn-secondary')+' btn-sm" data-stats-view="season_total">Season</button>'
    +'<button class="btn '+(viewMode==='per_session'?'btn-green':'btn-secondary')+' btn-sm" data-stats-view="per_session">Session</button>'
    +'</div>'
    +'<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">'
    +'<button class="btn '+(viewMode==='partners'?'btn-green':'btn-secondary')+' btn-sm" data-stats-view="partners">Partner Stats</button>'
    +(viewMode==='partners'?'<button class="btn '+(partSubView==='season_total'?'btn-primary':'btn-secondary')+' btn-sm" data-partner-sub="season_total" style="border:2px solid #1a5c2a">Season</button><button class="btn '+(partSubView==='per_session'?'btn-primary':'btn-secondary')+' btn-sm" data-partner-sub="per_session" style="border:2px solid #1a5c2a">Session</button><button class="btn '+(partSubView==='custom_range'?'btn-primary':'btn-secondary')+' btn-sm" data-partner-sub="custom_range" style="border:2px solid #1a5c2a">Range</button>':'')
    +'</div>'
    +'</div>';

  // Season/year selector (per_session has its own inline selector)
  // Helper: get season display label with start date
  function seasonLabel(s){
    var dates=(S.seasons[s]||[]).slice().sort();
    return s+(dates.length?' ('+dates[0]+')':'');
  }

  if(viewMode==='custom_range'){
    var crFrom=S._crFrom||'', crTo=S._crTo||'';
    h+='<div style="border:1.5px solid #c8e6c9;border-radius:10px;padding:12px;margin-bottom:12px">'
      +'<div style="font-weight:700;font-size:.85rem;margin-bottom:8px;color:#1a5c2a">ğŸ“… Custom Date Range</div>'
      +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">'
      +'<div><label style="font-size:.78rem;font-weight:600">From Date</label>'
      +'<input type="date" id="cr-from" value="'+crFrom+'" style="width:100%;padding:6px;border-radius:6px;border:1.5px solid #ccc"></div>'
      +'<div><label style="font-size:.78rem;font-weight:600">To Date</label>'
      +'<input type="date" id="cr-to" value="'+crTo+'" style="width:100%;padding:6px;border-radius:6px;border:1.5px solid #ccc"></div>'
      +'</div>'
      +'<button class="btn btn-green btn-sm" id="cr-apply-btn">Apply</button>'
      +'<button class="btn btn-secondary btn-sm" style="margin-left:6px" id="cr-clear-btn">Clear</button>'
      +'</div>';
  } else if(viewMode==='season_total'||viewMode==='partners'){
    h+='<div style="margin-bottom:12px"><label style="font-size:.85rem;font-weight:700">Select Season</label>'
      +'<select id="stats-season-for-view-sel" style="padding:8px;border-radius:6px;border:1.5px solid #ccc;width:100%">';
    allSeasons.forEach(function(s){ h+='<option value="'+s+'"'+(s===selSeasonForSession?' selected':'')+'>'+seasonLabel(s)+'</option>'; });
    h+='</select></div>';
  }

  // For custom_range view: aggregate across filtered dates
  if(viewMode==='custom_range'){
    // Collect matching dates based on filter settings
    var crFrom=S._crFrom||'', crTo=S._crTo||'';
    var crDates=[];
    var crSeasonSet={}; // which seasons contributed
    allSeasons.forEach(function(s){
      (S.seasons[s]||[]).forEach(function(d){
        var passes=(!crFrom||d>=crFrom)&&(!crTo||d<=crTo);
        if(passes){ crDates.push({date:d,season:s}); crSeasonSet[s]=true; }
      });
    });
    var crSeasonKeys=Object.keys(crSeasonSet);
    var crLabel=crDates.length===0?'No data for selected range':crDates.length+' session'+(crDates.length!==1?'s':'');
    h+='<div style="font-size:.8rem;color:#555;margin-bottom:8px">'+crLabel+'</div>';

    var crRows=S.players.map(function(p){
      var wins=0,losses=0,gw=0,gl=0,att=0,byes=0;
      crSeasonKeys.forEach(function(s){
        var st=getPlayerStats(p.id,s);
        // Scale down stats proportionally if only partial season in range
        var seasonTotal=(S.seasons[s]||[]).length;
        var seasonInRange=crDates.filter(function(x){ return x.season===s; }).length;
        var scale=seasonTotal>0?seasonInRange/seasonTotal:1;
        wins+=Math.round(st.wins*scale);
        losses+=Math.round(st.losses*scale);
        gw+=Math.round(st.gamesWon*scale);
        gl+=Math.round(st.gamesLost*scale);
        att+=Math.round(((S.playerStats[p.id]||{})[s+'_att']||0)*scale);
        byes+=Math.round(((S.byeCounts[p.id]||{})[s]||0)*scale);
      });
      var total=wins+losses;
      var winPct=total>0?Math.round((wins/total)*100):null;
      var pts=wins*cfg.matchWin+gw*cfg.gameWin+att*cfg.attendance;
      return{p:p,wins:wins,losses:losses,gamesWon:gw,gamesLost:gl,winPct:winPct,total:total,att:att,byes:byes,pts:pts};
    });
    crRows.sort(function(a,b){ return b.pts!==a.pts?b.pts-a.pts:b.wins!==a.wins?b.wins-a.wins:b.gamesWon-a.gamesWon; });
    h+='<div class="sticky-table-wrap">';
    h+='<table><tr><th>#</th><th>Name</th><th>Pts</th><th>M Won</th><th>M Lost</th><th>Win%</th><th>G Won</th><th>G Lost</th><th>Att</th>'+(isAdmin?'<th>Byes</th>':'')+'</tr>';
    for(var i=0;i<crRows.length;i++){
      var r=crRows[i];
      var wstr=r.winPct!==null?r.winPct+'%':'â€”';
      var medal=i===0&&r.total>0?'ğŸ¥‡ ':i===1&&r.total>0?'ğŸ¥ˆ ':i===2&&r.total>0?'ğŸ¥‰ ':'';
      h+='<tr><td style="color:#888;font-size:.8rem">'+(i+1)+'</td>'
        +'<td><strong>'+medal+esc(r.p.name)+'</strong></td>'
        +'<td><span class="pts-badge">'+r.pts+'</span></td>'
        +'<td style="color:#155724;font-weight:700">'+r.wins+'</td>'
        +'<td style="color:#721c24">'+r.losses+'</td>'
        +'<td><span style="background:'+(r.winPct===null?'#eee':r.winPct>=50?'#d4edda':'#f8d7da')+';padding:2px 7px;border-radius:10px;font-size:.8rem;font-weight:700">'+wstr+'</span></td>'
        +'<td>'+r.gamesWon+'</td><td>'+r.gamesLost+'</td><td>'+r.att+'</td>'
        +(isAdmin?'<td style="color:#856404">'+r.byes+'</td>':'')
        +'</tr>';
    }
    h+='</table></div>';
  }

  // â”€â”€ SEASON TOTAL VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  else if(viewMode==='season_total'){
    var viewSeason=selSeasonForSession||season;
    var rows=S.players.map(function(p){
      var bc=(S.byeCounts[p.id]||{})[viewSeason]||0;
      var st=getPlayerStats(p.id,viewSeason);
      var att=(S.playerStats[p.id]||{})[viewSeason+'_att']||0;
      var total=st.wins+st.losses;
      var winPct=total>0?Math.round((st.wins/total)*100):null;
      var pts=calcTotalPoints(p.id,viewSeason);
      return{p:p,byes:bc,wins:st.wins,losses:st.losses,gamesWon:st.gamesWon,gamesLost:st.gamesLost,winPct:winPct,total:total,att:att,pts:pts};
    });
    rows.sort(function(a,b){
      if(b.pts!==a.pts) return b.pts-a.pts;
      if(b.wins!==a.wins) return b.wins-a.wins;
      return b.gamesWon-a.gamesWon;
    });
    h+='<div class="sticky-table-wrap">';
    h+='<table><tr><th>#</th><th>Name</th><th>Pts</th><th>M Won</th><th>M Lost</th><th>Win%</th><th>G Won</th><th>G Lost</th><th>Att</th>'+(isAdmin?'<th>Byes</th>':'')+'</tr>';
    for(var i=0;i<rows.length;i++){
      var r=rows[i];
      var winPctStr=r.winPct!==null?r.winPct+'%':'â€”';
      var medal=i===0&&r.total>0?'ğŸ¥‡ ':i===1&&r.total>0?'ğŸ¥ˆ ':i===2&&r.total>0?'ğŸ¥‰ ':'';
      h+='<tr>'
        +'<td style="color:#888;font-size:.8rem">'+(i+1)+'</td>'
        +'<td><strong>'+medal+esc(r.p.name)+'</strong></td>'
        +'<td><span class="pts-badge">'+r.pts+'</span></td>'
        +'<td style="color:#155724;font-weight:700">'+r.wins+'</td>'
        +'<td style="color:#721c24">'+r.losses+'</td>'
        +'<td><span style="background:'+(r.winPct===null?'#eee':r.winPct>=50?'#d4edda':'#f8d7da')+';padding:2px 7px;border-radius:10px;font-size:.8rem;font-weight:700">'+winPctStr+'</span></td>'
        +'<td>'+r.gamesWon+'</td>'
        +'<td>'+r.gamesLost+'</td>'
        +'<td>'+r.att+'</td>'
        +(isAdmin?'<td style="color:#856404">'+r.byes+'</td>':'')
        +'</tr>';
    }
    h+='</table></div>';
    var totalMatches=0,totalScored=0;
    rows.forEach(function(r){ totalMatches+=r.total; totalScored+=r.gamesWon; });
    if(totalMatches>0){
      h+='<div style="margin-top:10px;font-size:.82rem;color:#666">'+Math.round(totalMatches/2)+' matches recorded Â· '+totalScored+' total games this season</div>';
    }
  }

  // â”€â”€ PER SESSION VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  else if(viewMode==='per_session'){
    // Collect all dates across ALL seasons that have assignments
    var sessionDates=[];
    allSeasons.forEach(function(s2){
      (S.seasons[s2]||[]).forEach(function(d){
        var se=S.sessions[d]; if(se&&se.assignments) sessionDates.push(d);
      });
    });
    sessionDates.sort();
    if(!sessionDates.length){
      h+='<div class="alert alert-info">No sessions with recorded data yet.</div>';
    } else {
      var selDate=S._statsSessionDate&&sessionDates.indexOf(S._statsSessionDate)>=0?S._statsSessionDate:sessionDates[sessionDates.length-1];
      S._statsSessionDate=selDate;
      h+='<div style="margin-bottom:12px"><label style="font-size:.85rem;font-weight:700">Select Session</label>'        +'<select id="stats-session-sel" style="padding:8px;border-radius:6px;border:1.5px solid #ccc;width:100%">';
      for(var di=sessionDates.length-1;di>=0;di--){
        h+='<option value="'+sessionDates[di]+'"'+(sessionDates[di]===selDate?' selected':'')+'>'+fmtDate(sessionDates[di])+'</option>';
      }
      h+='</select></div>';

      var sessSel=S.sessions[selDate];
      var sessionStats=buildSessionStats(selDate, sessSel);

      var sRows=S.players.map(function(p){
        var ss=sessionStats[String(p.id)]||{wins:0,losses:0,gamesWon:0,gamesLost:0,byes:0};
        var total=ss.wins+ss.losses;
        var winPct=total>0?Math.round((ss.wins/total)*100):null;
        var pts=calcTotalPoints(p.id, selDate);
        return{p:p,wins:ss.wins,losses:ss.losses,gamesWon:ss.gamesWon,gamesLost:ss.gamesLost,byes:ss.byes,total:total,winPct:winPct,pts:pts};
      });
      sRows.sort(function(a,b){ return b.pts!==a.pts?b.pts-a.pts:b.wins!==a.wins?b.wins-a.wins:b.gamesWon-a.gamesWon; });
      h+='<div class="sticky-table-wrap">'        +'<table><tr><th>#</th><th>Name</th><th>Pts</th><th>M Won</th><th>M Lost</th><th>Win%</th><th>G Won</th><th>G Lost</th>'+(isAdmin?'<th>Byes</th>':'')+'</tr>';
      for(var i=0;i<sRows.length;i++){
        var r=sRows[i];
        var winPctStr=r.winPct!==null?r.winPct+'%':'â€”';
        h+='<tr>'          +'<td style="color:#888;font-size:.8rem">'+(i+1)+'</td>'          +'<td><strong>'+esc(r.p.name)+'</strong></td>'          +'<td><span class="pts-badge">'+r.pts+'</span></td>'          +'<td style="color:#155724;font-weight:700">'+r.wins+'</td>'          +'<td style="color:#721c24">'+r.losses+'</td>'          +'<td><span style="background:'+(r.winPct===null?'#eee':r.winPct>=50?'#d4edda':'#f8d7da')+';padding:2px 7px;border-radius:10px;font-size:.8rem;font-weight:700">'+winPctStr+'</span></td>'          +'<td>'+r.gamesWon+'</td>'          +'<td>'+r.gamesLost+'</td>'          +(isAdmin?'<td style="color:#856404">'+r.byes+'</td>':'')          +'</tr>';
      }
      h+='</table></div>';
    }
  }

  // â”€â”€ PARTNER STATS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  else if(viewMode==='partners'){
    // For partner custom_range, use the global custom range filter dates
    var pDates;
    if(partSubView==='custom_range'){
      var crFrom2=S._crFrom||'', crTo2=S._crTo||'';
      pDates=[];
      Object.keys(S.seasons||{}).forEach(function(s){
        (S.seasons[s]||[]).forEach(function(d){
          if((!crFrom2||d>=crFrom2)&&(!crTo2||d<=crTo2)) pDates.push(d);
        });
      });
    } else {
      pDates=(S.seasons[selSeasonForSession||season]||[]).slice().sort();
    }
    var pOpts='<option value="">â€” select player â€”</option>';
    for(var i=0;i<S.players.length;i++) pOpts+='<option value="'+S.players[i].id+'"'+(S._partnerFocusPid===S.players[i].id?' selected':'')+'>'+fmtId(S.players[i].id)+' '+esc(S.players[i].name)+'</option>';
    h+='<div style="margin-bottom:12px"><label style="font-size:.85rem;font-weight:700">Select Player</label>'
      +'<select id="partner-focus-sel" style="padding:8px;border-radius:6px;border:1.5px solid #ccc;width:100%">'+pOpts+'</select></div>';

    // Show calendar UI when custom_range sub-view selected
    if(partSubView==='custom_range'){
      var crFrom2=S._crFrom||'', crTo2=S._crTo||'';
      h+='<div style="border:1.5px solid #c8e6c9;border-radius:10px;padding:12px;margin-bottom:12px">'
        +'<div style="font-weight:700;font-size:.85rem;margin-bottom:8px;color:#1a5c2a">ğŸ“… Custom Date Range</div>'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">'
        +'<div><label style="font-size:.78rem;font-weight:600">From Date</label>'
        +'<input type="date" id="cr-from" value="'+crFrom2+'" style="width:100%;padding:6px;border-radius:6px;border:1.5px solid #ccc"></div>'
        +'<div><label style="font-size:.78rem;font-weight:600">To Date</label>'
        +'<input type="date" id="cr-to" value="'+crTo2+'" style="width:100%;padding:6px;border-radius:6px;border:1.5px solid #ccc"></div>'
        +'</div>'
        +'<button class="btn btn-green btn-sm" id="cr-apply-btn">Apply</button>'
        +' <button class="btn btn-secondary btn-sm" id="cr-clear-btn">Clear</button>'
        +'</div>';
    }
    var focusPid=S._partnerFocusPid||null;
    if(!focusPid){
      h+='<div class="alert alert-info">Select a player to view their partner stats.</div>';
    } else {
      var focusPlayer=getPlayer(focusPid);
      var datesForPartner=pDates;
      if(partSubView==='per_session'){
        var sessionDates2=pDates.filter(function(d){ var se=S.sessions[d]; return se&&se.assignments; });
        var selDate2=S._partnerSessionDate&&sessionDates2.indexOf(S._partnerSessionDate)>=0?S._partnerSessionDate:sessionDates2[sessionDates2.length-1];
        S._partnerSessionDate=selDate2;
        if(sessionDates2.length){
          h+='<div style="margin-bottom:12px"><label style="font-size:.85rem;font-weight:700">Select Session</label>'
            +'<select id="partner-session-sel" style="padding:8px;border-radius:6px;border:1.5px solid #ccc;width:100%">';
          for(var di2=sessionDates2.length-1;di2>=0;di2--){
            h+='<option value="'+sessionDates2[di2]+'"'+(sessionDates2[di2]===selDate2?' selected':'')+'>'+fmtDate(sessionDates2[di2])+'</option>';
          }
          h+='</select></div>';
          datesForPartner=[selDate2];
        }
      }
      var partnerStats=buildPartnerStats(focusPid, datesForPartner);
      var partnerKeys=Object.keys(partnerStats);
      h+='<div style="font-weight:700;color:#1a5c2a;margin-bottom:10px">ğŸ¤ '+(focusPlayer?esc(focusPlayer.name):'Player')+' with each partner'+(partSubView==='per_session'&&S._partnerSessionDate?' â€” '+fmtDate(S._partnerSessionDate):'')+':</div>';
      if(!partnerKeys.length){
        h+='<div class="alert alert-info">No partner data found for this player.</div>';
      } else {
        var pRows=partnerKeys.map(function(pk){
          var ps=partnerStats[pk];
          var partP=getPlayer(parseInt(pk));
          var winPct=ps.matches>0?Math.round((ps.matchWins/ps.matches)*100):null;
          var gameTotal=ps.gamesWon+ps.gamesLost;
          var gamePct=gameTotal>0?Math.round((ps.gamesWon/gameTotal)*100):null;
          return{pk:pk,p:partP,ps:ps,winPct:winPct,gamePct:gamePct};
        });
        pRows.sort(function(a,b){ return b.ps.matches-a.ps.matches; });
        h+='<div class="sticky-table-wrap">'
          +'<table><tr><th>Partner</th><th>Matches</th><th>M Won</th><th>M Lost</th><th>M Win%</th><th>G Won</th><th>G Lost</th><th>G Win%</th></tr>';
        for(var i=0;i<pRows.length;i++){
          var r=pRows[i], ps=r.ps;
          var mWinStr=r.winPct!==null?r.winPct+'%':'â€”';
          var gWinStr=r.gamePct!==null?r.gamePct+'%':'â€”';
          h+='<tr>'
            +'<td><strong>'+esc(r.p?r.p.name:fmtId(parseInt(r.pk)))+'</strong></td>'
            +'<td>'+ps.matches+'</td>'
            +'<td style="color:#155724;font-weight:700">'+ps.matchWins+'</td>'
            +'<td style="color:#721c24">'+ps.matchLosses+'</td>'
            +'<td><span style="background:'+(r.winPct===null?'#eee':r.winPct>=50?'#d4edda':'#f8d7da')+';padding:2px 7px;border-radius:10px;font-size:.8rem;font-weight:700">'+mWinStr+'</span></td>'
            +'<td>'+ps.gamesWon+'</td>'
            +'<td>'+ps.gamesLost+'</td>'
            +'<td><span style="background:'+(r.gamePct===null?'#eee':r.gamePct>=50?'#d4edda':'#f8d7da')+';padding:2px 7px;border-radius:10px;font-size:.8rem;font-weight:700">'+gWinStr+'</span></td>'
            +'</tr>';
        }
        h+='</table></div>';
      }
    }
  }

  return h+'</div>';
}



// â”€â”€ AUTOASSIGN OPTIONS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAutoAssignOptions(){
  var date=S.selectedDate; if(!date){ showToast('No date selected.'); return; }
  var sess=getSession(date);
  var inP=getInPlayers(date);
  if(!inP.length){ showToast('No players marked IN.'); return; }
  var lockedTeams=(sess.lockedTeams||[]).map(function(t){ return t.map(function(id){ return parseInt(id); }); });
  var noByePids=(sess.noByePids||[]).map(function(id){ return parseInt(id); });
  var ppCourt=sess.type==='singles'?2:4;
  var half=ppCourt/2;

  // Build set of already-locked player IDs
  function lockedPidSet(){
    var s={};
    for(var li=0;li<lockedTeams.length;li++)
      for(var lj=0;lj<lockedTeams[li].length;lj++) s[lockedTeams[li][lj]]=true;
    return s;
  }

  // Build player options, excluding already-locked players
  function buildPOpts(){
    var locked=lockedPidSet();
    var o='<option value="">â€” select â€”</option>';
    for(var i=0;i<inP.length;i++){
      if(!locked[inP[i].id])
        o+='<option value="'+inP[i].id+'">'+fmtId(inP[i].id)+' '+esc(inP[i].name)+'</option>';
    }
    return o;
  }

  // Render locked teams rows
  function lockedRows(){
    var h='';
    for(var li=0;li<lockedTeams.length;li++){
      var lt=lockedTeams[li];
      var names=lt.map(function(id){ var p=getPlayer(id); return p?esc(p.name):fmtId(id); }).join(' & ');
      h+='<div class="locked-row" style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid #eee">'+
        '<span style="flex:1;font-size:.88rem">ğŸ”’ '+names+'</span>'+
        '<button class="btn btn-danger btn-sm locked-del-btn" data-li="'+li+'">âœ•</button>'+
        '</div>';
    }
    return h||'<div style="color:#aaa;font-size:.82rem;padding:4px 0">No locked teams yet.</div>';
  }

  // Build add-locked-team selects (one per slot)
  function addLockedSelects(){
    var hh='<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">';
    for(var si2=0;si2<half;si2++){
      hh+='<select id="lt-p'+si2+'" style="padding:6px;flex:1;border-radius:6px;border:1.5px solid #ccc">'+buildPOpts()+'</select>';
    }
    hh+='<button class="btn btn-green btn-sm" id="lt-add-btn">+ Add</button></div>';
    return hh;
  }

  function renderLocked(){
    var w=byId('locked-rows-wrap');
    if(w){
      w.innerHTML=lockedRows();
      // Re-bind delete buttons each time rows are re-rendered
      w.querySelectorAll('.locked-del-btn').forEach(function(btn){
        btn.addEventListener('click',function(){
          lockedTeams.splice(parseInt(btn.dataset.li),1);
          renderLocked();
        });
      });
    }
    var sw=byId('lt-selects-wrap'); if(sw){ sw.innerHTML=addLockedSelects(); bindAddBtn(); }
  }

  function bindAddBtn(){
    var addBtn=byId('lt-add-btn');
    if(!addBtn) return;
    addBtn.addEventListener('click',function(){
      var ids=[];
      for(var si3=0;si3<half;si3++){
        var selEl=byId('lt-p'+si3);
        if(selEl&&parseInt(selEl.value)) ids.push(parseInt(selEl.value));
      }
      if(ids.length<2){ showToast('Select '+half+' different players.'); return; }
      if(new Set(ids).size!==ids.length){ showToast('Please select different players.'); return; }
      var locked=lockedPidSet();
      for(var ci=0;ci<ids.length;ci++){
        if(locked[ids[ci]]){ showToast(getPlayer(ids[ci]).name+' is already in a locked team.'); return; }
      }
      lockedTeams.push(ids);
      renderLocked();
    });
  }

  var body='<h3>âš™ï¸ AutoAssign Options</h3>';

  // Locked teams section
  body+='<div style="margin-bottom:16px">'+
    '<div style="font-weight:700;margin-bottom:6px">ğŸ”’ Locked Teams (stay together all rounds)</div>'+
    '<div id="locked-rows-wrap">'+lockedRows()+'</div>'+
    '<div style="margin-top:8px"><label style="font-size:.8rem">Add locked team ('+half+' players):</label>'+
    '<div id="lt-selects-wrap">'+addLockedSelects()+'</div></div>'+
    '</div>';

  // No-bye section
  body+='<div style="margin-bottom:16px">'+
    '<div style="font-weight:700;margin-bottom:4px">âš¡ Early Leave Protection</div>'+
    '<div style="font-size:.8rem;color:#555;margin-bottom:8px">Selected players will never sit out a round.</div>'+
    '<div id="no-bye-btns" style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;border:1px solid #eee;border-radius:8px">';
  for(var i=0;i<inP.length;i++){
    var checked=noByePids.indexOf(inP[i].id)>=0;
    body+='<button type="button" class="no-bye-toggle-btn" data-pid="'+inP[i].id+'" style="padding:5px 12px;border-radius:20px;border:2px solid '+(checked?'#e67e00':'#ccc')+';background:'+(checked?'#fff3cd':'#fff')+';color:'+(checked?'#7d4a00':'#444')+';font-weight:'+(checked?'700':'400')+';font-size:.82rem;cursor:pointer;transition:all .15s">'+
      (checked?'âš¡ ':'')+fmtId(inP[i].id)+' '+esc(inP[i].name)+
      '</button>';
  }
  body+='</div></div>';

  body+='<div class="modal-btns">'+
    '<button class="btn btn-secondary" id="m-cancel">Cancel</button>'+
    '<button class="btn btn-primary" id="aa-opts-save">Save Options</button>'+
    '</div>';

  showModal(body,true);
  byId('m-cancel').addEventListener('click',closeModal);

  // Use event delegation on the container so listeners never stack on re-render
  var noByeContainer=byId('no-bye-btns');
  if(noByeContainer) noByeContainer.addEventListener('click',function(e){
    var btn=e.target.closest('.no-bye-toggle-btn');
    if(!btn) return;
    var pid=parseInt(btn.dataset.pid);
    var idx=noByePids.indexOf(pid);
    if(idx>=0) noByePids.splice(idx,1); else noByePids.push(pid);
    var active=noByePids.indexOf(pid)>=0;
    btn.style.border='2px solid '+(active?'#e67e00':'#ccc');
    btn.style.background=active?'#fff3cd':'#fff';
    btn.style.color=active?'#7d4a00':'#444';
    btn.style.fontWeight=active?'700':'400';
    btn.textContent=(active?'âš¡ ':'')+fmtId(pid)+' '+(getPlayer(pid)?esc(getPlayer(pid).name):fmtId(pid));
  });

  // Initial bind
  byId('locked-rows-wrap').querySelectorAll('.locked-del-btn').forEach(function(btn){
    btn.addEventListener('click',function(){
      lockedTeams.splice(parseInt(btn.dataset.li),1);
      renderLocked();
    });
  });
  bindAddBtn();

  // Save both locked teams and no-bye pids together
  byId('aa-opts-save').addEventListener('click',function(){
    sess.lockedTeams=lockedTeams;
    sess.noByePids=noByePids;
    S.sessions[date]=sess; save(); closeModal(); showToast('AutoAssign options saved!');
  });
}

// â”€â”€ ASSIGNMENT ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateAssignments(){
  var date=S.selectedDate; if(!date){ showToast('No date selected.'); return; }
  var sess=getSession(date);
  // Dispatch to mode-specific generators
  if(sess.playersChoice){
    generatePlayersChoiceAssignments(date, sess, sess.pcSubmissions||{});
    var nr=sess.assignments&&sess.assignments.rounds?sess.assignments.rounds.length:1;
    showToast('Round '+nr+' generated!');
    render();
    return;
  }
  if(sess.teamBattle){
    if(!(sess.teamA&&sess.teamA.length)&&!(sess.teamB&&sess.teamB.length)){
      showToast('Set up teams first using the âš”ï¸ Setup Team Battle button.');
      return;
    }
    generateTeamBattleAssignments(date, sess);
    showToast('Team Battle assignments generated!');
    render();
    return;
  }
  if(sess.manualPartners){
    var manualData=sess.manualAssignments||{};
    generateAssignmentsWithManual(date,sess,manualData);
    render();
    return;
  }
  var inP=getInPlayers(date), ppCourt=sess.type==='singles'?2:4;
  if(inP.length<ppCourt){ showToast('Need at least '+ppCourt+' players marked IN.'); return; }
  // Same-partner mode requires even number of players so every player gets a fixed partner
  if(sess.rotatePartners===false&&ppCourt===4&&(inP.length%2!==0)){
    showToast('âš ï¸ Pair Same Partner mode requires an even number of players. Currently '+inP.length+' players are IN. Please mark one more player IN (or OUT) before generating.');
    return;
  }
  var numCourts=sess.courts, mpp=sess.matchesPerPlayer;
  var rotate=sess.rotatePartners;         // true = new partners each round
  var playPerRound=Math.min(inP.length,numCourts*ppCourt), activeCourts=Math.floor(playPerRound/ppCourt);
  var actualPlayPerRound=activeCourts*ppCourt; // real players per round (after floor)
  // Same-partner: totalRounds must ensure every PAIR reaches mpp plays despite bye rotation.
  // Formula: ceil(mpp * numPairs / playingPairsPerRound) where playingPairs = activeCourts*2.
  var totalRounds;
  if(rotate===false&&ppCourt===4){
    var _numPairs=Math.floor(inP.length/2);
    var _activeCourts=Math.min(numCourts, Math.floor(_numPairs/2));
    var _playingPairs=_activeCourts*2;
    totalRounds=(_playingPairs>0)?Math.ceil(mpp*_numPairs/_playingPairs):mpp;
  } else {
    // Use actualPlayPerRound (not playPerRound) so byes are correctly accounted for
    totalRounds=Math.ceil((inP.length*mpp)/Math.max(1,actualPlayPerRound));
  }

  // Session options
  var lockedTeams=sess.lockedTeams||[];   // array of [pid,pid] pairs
  var noByePids=sess.noByePids||[];       // array of pids that must never sit out

  // Validate noByePids don't conflict with bye math
  var need=inP.length-activeCourts*ppCourt;
  if(need>0){
    showToast('Note: '+need+' player'+(need>1?'s':'')+' will sit out each round (byes needed due to player count).');
  }

  // Build sorted pool; locked-team members stay as units
  var sorted=inP.slice().sort(function(a,b){ return parseFloat(b.usta)-parseFloat(a.usta); });
  if(!S.byeCounts) S.byeCounts={};
  for(var i=0;i<sorted.length;i++) if(!S.byeCounts[sorted[i].id]) S.byeCounts[sorted[i].id]={};
  var seasonByes={};
  for(var i=0;i<sorted.length;i++) seasonByes[sorted[i].id]=(S.byeCounts[sorted[i].id][S.currentSeason])||0;
  var playCounts={}, todayByes={};
  for(var i=0;i<sorted.length;i++){ playCounts[sorted[i].id]=0; todayByes[sorted[i].id]=0; }

  // Build set of locked-team members (for rotation logic)
  var lockedMemberOf={};
  for(var li=0;li<lockedTeams.length;li++){
    var lt=lockedTeams[li];
    for(var lj=0;lj<lt.length;lj++) lockedMemberOf[lt[lj]]=li;
  }

  var allRounds=[];
  // Track opponent history for vary-opponent logic
  var lastPartner={};
  var opponentHistory={}; // opponentHistory[pid][oppPid] = number of times faced
  var partnerHistory={};  // partnerHistory[pid][partPid] = number of times partnered
  for(var i=0;i<sorted.length;i++){
    opponentHistory[sorted[i].id]={};
    partnerHistory[sorted[i].id]={};
  }

  // SAME-PARTNER MODE: build fixed pairs ONCE before round 1
  // Partners never change â€” only opponents rotate each round.
  // Byes rotate fairly at the pair level (both partners sit together).
  var fixedPairs = null; // [{ids:[pid,pid], avgUsta:float}]
  if(!rotate && ppCourt===4){
    fixedPairs = [];
    var usedInFixed = {};

    // 1. Locked teams (use == for Firebase string/int coercion)
    for(var li=0;li<lockedTeams.length;li++){
      var lt=lockedTeams[li];
      if(lt.length!==2) continue;
      var p0=null, p1=null;
      for(var si=0;si<sorted.length;si++){
        if(sorted[si].id==lt[0]) p0=sorted[si];
        if(sorted[si].id==lt[1]) p1=sorted[si];
      }
      if(!p0||!p1) continue; // one not IN
      if(usedInFixed[p0.id]||usedInFixed[p1.id]) continue;
      fixedPairs.push({ids:[p0.id,p1.id], avgUsta:((parseFloat(p0.usta)||3.0)+(parseFloat(p1.usta)||3.0))/2, locked:true});
      usedInFixed[p0.id]=true; usedInFixed[p1.id]=true;
    }

    // 2. Free players: snake pair by USTA (highest+lowest, 2nd+2nd-lowest â€¦)
    var free=sorted.filter(function(p){ return !usedInFixed[p.id]; });
    var fTop=free.slice(0, Math.floor(free.length/2));
    var fBot=free.slice(Math.floor(free.length/2)).reverse();
    for(var fi=0;fi<fTop.length&&fi<fBot.length;fi++){
      fixedPairs.push({ids:[fTop[fi].id,fBot[fi].id], avgUsta:((parseFloat(fTop[fi].usta)||3.0)+(parseFloat(fBot[fi].usta)||3.0))/2, locked:false});
      usedInFixed[fTop[fi].id]=true; usedInFixed[fBot[fi].id]=true;
    }
    // Any remaining player (odd count after locked pairs) will be on bye every round
    var fixedPairMemberSet={};
    if(fixedPairs){ fixedPairs.forEach(function(fp){ fp.ids.forEach(function(id){ fixedPairMemberSet[id]=true; }); }); }
    var alwaysByePlayers=sorted.filter(function(p){ return !fixedPairMemberSet[p.id]; });
  }

  // Track bye count per pair for fair rotation
  var pairByeCounts = {};
  var maxRounds = totalRounds + 4; // safety cap: at most totalRounds+4 to cover uneven byes

  for(var r=0; r<maxRounds; r++){
    // Stop once all players have reached mpp (or no eligible players remain)
    var allDone = sorted.every(function(p){ return playCounts[p.id]>=mpp; });
    if(allDone) break;
    if(r>=totalRounds){
      // Extra rounds only for players still short â€” skip if the remaining shortfall
      // can't be fixed (e.g. all remaining eligible players already at mpp)
      var stillNeed=sorted.filter(function(p){ return playCounts[p.id]<mpp; });
      if(stillNeed.length<ppCourt) break;
    }
    var byes=[], roundCourts=[];

    if(!rotate && ppCourt===4 && fixedPairs && fixedPairs.length>0){
      // â”€â”€ SAME-PARTNER PATH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      var numPairs=fixedPairs.length;
      var courtsNeeded=Math.min(activeCourts, Math.floor(numPairs/2));
      var playingCount=courtsNeeded*2;

      // Sort pairs: protected (noByePids) always play first, then most-byes first among the rest
      var noByeSet={};
      noByePids.forEach(function(id){ noByeSet[String(id)]=true; });
      function pairHasNoBye(pair){ return pair.ids.some(function(id){ return noByeSet[String(id)]; }); }

      // If all pairs done (mpp reached), end generation
      var anyPairActive=fixedPairs.some(function(pair){
        return !pair.ids.every(function(id){ return playCounts[id]>=mpp; });
      });
      if(!anyPairActive){ allRounds.push({courts:[],byes:sorted.map(function(p){return p.id;})}); break; }

      var pairOrder=fixedPairs.slice().sort(function(a,b){
        var aProtected=pairHasNoBye(a)?1:0, bProtected=pairHasNoBye(b)?1:0;
        if(aProtected!==bProtected) return bProtected-aProtected; // protected pairs first
        var ka=a.ids.join('-'), kb=b.ids.join('-');
        var d=(pairByeCounts[kb]||0)-(pairByeCounts[ka]||0); // descending: most byes â†’ play first
        return d!==0?d:(Math.random()-0.5);
      });

      // Separate out pairs that have reached mpp â€” they must sit out regardless of protection
      var donePairs=pairOrder.filter(function(pair){
        return pair.ids.every(function(id){ return playCounts[id]>=mpp; });
      });
      var activePairs=pairOrder.filter(function(pair){
        return !pair.ids.every(function(id){ return playCounts[id]>=mpp; });
      });

      // Re-calculate available courts based on active pairs
      var numActivePairs=activePairs.length;
      courtsNeeded=Math.min(activeCourts, Math.floor(numActivePairs/2));
      playingCount=courtsNeeded*2;

      var playingPairs=activePairs.slice(0,playingCount);
      var byePairs=activePairs.slice(playingCount).concat(donePairs);

      byePairs.forEach(function(pair){
        pair.ids.forEach(function(id){ byes.push(id); });
        var k=pair.ids.join('-'); pairByeCounts[k]=(pairByeCounts[k]||0)+1;
      });
      // Also add always-bye players (odd leftover not in any pair)
      alwaysByePlayers.forEach(function(p){ if(byes.indexOf(p.id)<0) byes.push(p.id); });

      // Match pairs against each other: top half vs bottom half by USTA,
      // varying opponents across rounds using opponentHistory
      var sortedPP=playingPairs.slice().sort(function(a,b){ return b.avgUsta-a.avgUsta; });
      var halfPP=Math.floor(sortedPP.length/2);
      var topPP=sortedPP.slice(0,halfPP), botPP=sortedPP.slice(halfPP).reverse();
      var usedBot={};
      for(var pi2=0;pi2<topPP.length&&roundCourts.length<courtsNeeded;pi2++){
        var tPair=topPP[pi2];
        var bestBot=-1, bestScore=Infinity;
        for(var bj=0;bj<botPP.length;bj++){
          if(usedBot[bj]) continue;
          var oppScore=0;
          tPair.ids.forEach(function(ta){ botPP[bj].ids.forEach(function(tb){
            oppScore+=(opponentHistory[ta]||{})[tb]||0;
          }); });
          if(oppScore<bestScore){ bestScore=oppScore; bestBot=bj; }
        }
        if(bestBot<0) break;
        usedBot[bestBot]=true;
        roundCourts.push({teams:[tPair.ids.slice(), botPP[bestBot].ids.slice()]});
      }

    } else {
      // â”€â”€ ROTATE / SINGLES PATH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      var eligible=sorted.filter(function(p){ return playCounts[p.id]<mpp; });
      if(eligible.length<ppCourt) break;
      var roundActiveCourts=Math.min(activeCourts, Math.floor(eligible.length/ppCourt));
      var byeCount=eligible.length-roundActiveCourts*ppCourt;
      if(byeCount>0){
        // Build string set for fast protected-player lookup
        var noByeIdSet={};
        noByePids.forEach(function(id){ noByeIdSet[String(id)]=true; });
        function isProtected(pid){ return noByeIdSet[String(pid)]===true; }

        var byeCandidates=eligible.slice().sort(function(a,b){
          var aNoBye=isProtected(a.id)?1:0;
          var bNoBye=isProtected(b.id)?1:0;
          if(aNoBye!==bNoBye) return aNoBye-bNoBye; // unprotected first
          var d=(seasonByes[a.id]||0)-(seasonByes[b.id]||0);
          return d!==0?d:playCounts[b.id]-playCounts[a.id];
        });
        var byeSet={};
        for(var bi=0;bi<byeCandidates.length&&Object.keys(byeSet).length<byeCount;bi++){
          var cid=byeCandidates[bi].id;
          if(byeSet[cid]) continue;
          if(isProtected(cid)) continue; // never force a protected player to bye
          var ltIdx=lockedMemberOf[cid];
          if(ltIdx!==undefined){
            var lt2=lockedTeams[ltIdx];
            // Skip if any team member is protected
            var teamHasProtected=lt2.some(function(tid){ return isProtected(tid); });
            if(teamHasProtected) continue;
            var wouldBye=Object.keys(byeSet).length+lt2.length;
            if(wouldBye<=byeCount){ for(var lj=0;lj<lt2.length;lj++) byeSet[lt2[lj]]=true; }
          } else { byeSet[cid]=true; }
        }
        // If byeSet is still smaller than needed (all remaining are protected), fill with least-bye protected
        if(Object.keys(byeSet).length<byeCount){
          var stillNeedBye=byeCount-Object.keys(byeSet).length;
          var protectedEligible=eligible.filter(function(p){ return isProtected(p.id)&&!byeSet[p.id]; });
          protectedEligible.sort(function(a,b){ return (seasonByes[a.id]||0)-(seasonByes[b.id]||0); });
          for(var pi3=0;pi3<protectedEligible.length&&stillNeedBye>0;pi3++){
            byeSet[protectedEligible[pi3].id]=true; stillNeedBye--;
          }
        }
        byes=Object.keys(byeSet).map(Number);
      }
      var playing=eligible.filter(function(p){ return byes.indexOf(p.id)<0; });
      roundCourts=assignCourtsWithLocked(playing, roundActiveCourts, ppCourt, lockedTeams, lastPartner, opponentHistory, partnerHistory);
    }

    // Update history tracking for next round
    for(var ci=0;ci<roundCourts.length;ci++){
      var ct=roundCourts[ci];
      var t0=ct.teams[0]||[], t1=ct.teams[1]||[];
      // Partner history
      for(var pi=0;pi<t0.length;pi++) for(var pi2=0;pi2<t0.length;pi2++){
        if(pi!==pi2){ partnerHistory[t0[pi]][t0[pi2]]=(partnerHistory[t0[pi]][t0[pi2]]||0)+1; }
      }
      for(var pi=0;pi<t1.length;pi++) for(var pi2=0;pi2<t1.length;pi2++){
        if(pi!==pi2){ partnerHistory[t1[pi]][t1[pi2]]=(partnerHistory[t1[pi]][t1[pi2]]||0)+1; }
      }
      // Opponent history
      for(var pi=0;pi<t0.length;pi++) for(var pi2=0;pi2<t1.length;pi2++){
        opponentHistory[t0[pi]][t1[pi2]]=(opponentHistory[t0[pi]][t1[pi2]]||0)+1;
        opponentHistory[t1[pi2]][t0[pi]]=(opponentHistory[t1[pi2]][t0[pi]]||0)+1;
      }
      // Update lastPartner for rotate mode
      if(rotate){
        for(var pi=0;pi<t0.length;pi++) for(var pi2=0;pi2<t0.length;pi2++){
          if(pi!==pi2) lastPartner[t0[pi]]=t0[pi2];
        }
        for(var pi=0;pi<t1.length;pi++) for(var pi2=0;pi2<t1.length;pi2++){
          if(pi!==pi2) lastPartner[t1[pi]]=t1[pi2];
        }
      }
    }

    allRounds.push({courts:roundCourts, byes:byes});
    for(var bi=0;bi<byes.length;bi++){ todayByes[byes[bi]]++; seasonByes[byes[bi]]=(seasonByes[byes[bi]]||0)+1; }
    // Count plays: all players on courts this round
    for(var ci=0;ci<roundCourts.length;ci++){
      roundCourts[ci].teams.forEach(function(team){ team.forEach(function(pid){ playCounts[pid]++; }); });
    }
  }

  for(var i=0;i<sorted.length;i++){
    S.byeCounts[sorted[i].id][S.currentSeason]=seasonByes[sorted[i].id]||0;
  }
  sess.assignments={rounds:allRounds}; sess.scores={}; sess.posted=false;
  S.sessions[date]=sess; save(); showToast('Assignments generated!');
}

function assignCourtsWithLocked(playing, numCourts, ppCourt, lockedTeams, lastPartner, opponentHistory, partnerHistory){
  opponentHistory = opponentHistory || {};
  partnerHistory = partnerHistory || {};
  var teamSize = ppCourt / 2; // 2 for doubles, 1 for singles

  // Step 1: Locked teams that are exactly teamSize and all playing become pre-formed teams
  var usedInLocked = {};
  var lockedFullTeams = [];
  for(var li=0;li<lockedTeams.length;li++){
    var lt = lockedTeams[li];
    if(lt.length !== teamSize) continue;
    var allPlaying = true;
    for(var lj=0;lj<lt.length;lj++) if(!playing.some(function(p){ return p.id===lt[lj]; })){ allPlaying=false; break; }
    if(!allPlaying) continue;
    var avgUsta = 0;
    for(var lj=0;lj<lt.length;lj++){ var lp=playing.find(function(p){ return p.id===lt[lj]; }); avgUsta+=lp?parseFloat(lp.usta)||3.0:3.0; }
    avgUsta/=lt.length;
    lockedFullTeams.push({ids:lt.slice(), avgUsta:avgUsta, locked:true});
    for(var lj=0;lj<lt.length;lj++) usedInLocked[lt[lj]]=true;
  }

  // Step 2: Remaining free players
  var freePlayers = playing.filter(function(p){ return !usedInLocked[p.id]; });

  // Shuffle free players for variety, then re-sort by usta
  for(var i=freePlayers.length-1;i>0;i--){
    var j=Math.floor(Math.random()*(i+1));
    var tmp=freePlayers[i]; freePlayers[i]=freePlayers[j]; freePlayers[j]=tmp;
  }
  freePlayers.sort(function(a,b){ return parseFloat(b.usta)-parseFloat(a.usta); });

  // Step 3: Form free player teams
  var freeTeams = [];
  if(teamSize===1){
    for(var i=0;i<freePlayers.length;i++)
      freeTeams.push({ids:[freePlayers[i].id], avgUsta:parseFloat(freePlayers[i].usta)||3.0, locked:false});
  } else {
    // Pair free players into teams of teamSize, minimising partner repeats
    var usedFree={};
    for(var i=0;i<freePlayers.length;i++){
      if(usedFree[freePlayers[i].id]) continue;
      var bestJ=-1, bestScore=Infinity;
      for(var j=i+1;j<freePlayers.length;j++){
        if(usedFree[freePlayers[j].id]) continue;
        var ps=(partnerHistory[freePlayers[i].id]||{})[freePlayers[j].id]||0;
        if(ps<bestScore){ bestScore=ps; bestJ=j; }
      }
      if(bestJ<0) continue; // odd player out â€” becomes bye
      var ids=[freePlayers[i].id, freePlayers[bestJ].id];
      var avg=(parseFloat(freePlayers[i].usta)+parseFloat(freePlayers[bestJ].usta))/2;
      freeTeams.push({ids:ids, avgUsta:avg, locked:false});
      usedFree[freePlayers[i].id]=true;
      usedFree[freePlayers[bestJ].id]=true;
    }
  }

  // Step 4: All teams sorted by avgUsta, then pair top vs bottom minimising opponent repeats
  var allTeams = lockedFullTeams.concat(freeTeams);
  allTeams.sort(function(a,b){ return b.avgUsta-a.avgUsta; });

  var n=allTeams.length, half=Math.floor(n/2);
  var topTeams=allTeams.slice(0,half);
  var botTeams=allTeams.slice(half).reverse();

  var courts=[], usedBot={};
  for(var i=0;i<numCourts&&i<topTeams.length&&i<botTeams.length;i++){
    var tTeam=topTeams[i];
    var bestBot=-1, bestScore=Infinity;
    for(var j=0;j<botTeams.length;j++){
      if(usedBot[j]) continue;
      var oppScore=0;
      for(var a=0;a<tTeam.ids.length;a++) for(var b=0;b<botTeams[j].ids.length;b++)
        oppScore+=(opponentHistory[tTeam.ids[a]]||{})[botTeams[j].ids[b]]||0;
      if(oppScore<bestScore){ bestScore=oppScore; bestBot=j; }
    }
    if(bestBot<0) break;
    usedBot[bestBot]=true;
    if(tTeam.ids.length>0&&botTeams[bestBot].ids.length>0)
      courts.push({teams:[tTeam.ids.slice(), botTeams[bestBot].ids.slice()]});
  }
  return courts;
}
function assignCourts(players,numCourts,ppCourt){
  var sorted=players.slice().sort(function(a,b){ return parseFloat(b.usta)-parseFloat(a.usta); }), courts=[];
  if(ppCourt===2){
    for(var i=0;i<numCourts&&i<Math.floor(sorted.length/2);i++)
      courts.push({teams:[[sorted[i].id],[sorted[sorted.length-1-i].id]]});
  } else {
    var half=Math.floor(sorted.length/2), top=sorted.slice(0,half), bot=sorted.slice(half).reverse(), teams=[];
    for(var i=0;i<Math.min(top.length,bot.length);i++) teams.push([top[i].id,bot[i].id]);
    var n=teams.length;
    for(var i=0;i<numCourts&&i<Math.floor(n/2);i++) courts.push({teams:[teams[i],teams[n-1-i]]});
  }
  return courts;
}

// â”€â”€ PLAYER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPlayerModal(id){
  var p=(id!==null)?getPlayer(id):null, ratings=['2.0','2.5','3.0','3.5','4.0','4.5','5.0'], ustaOpts='';
  for(var i=0;i<ratings.length;i++) ustaOpts+='<option'+(p&&p.usta===ratings[i]?' selected':'')+'>'+ratings[i]+'</option>';
  var curStatus=p?(p.memberStatus||'Active'):'Active';
  var statusOpts=['Active','Inactive','Guest'].map(function(s){ return '<option'+(curStatus===s?' selected':'')+'>'+s+'</option>'; }).join('');
  showModal('<h3>'+(p?'Edit':'Add')+' Player</h3>'
    +'<label>Name</label><input id="m-name" value="'+(p?esc(p.name):'')+'" placeholder="Full name">'
    +'<label>USTA Rating</label><select id="m-usta">'+ustaOpts+'</select>'
    +'<label>Member Status</label><select id="m-status">'+statusOpts+'</select>'
    +'<label>Fee Paid ($)</label><input id="m-fees" type="number" min="0" value="'+(p?p.fees||0:0)+'">'
    +'<div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Cancel</button><button class="btn btn-primary" id="m-save">'+(p?'Save':'Add')+'</button></div>');
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-save').addEventListener('click',function(){
    var name=byId('m-name').value.trim(), usta=byId('m-usta').value, fees=parseFloat(byId('m-fees').value)||0, memberStatus=byId('m-status').value||'Active';
    if(!name){ showToast('Name is required.'); return; }
    if(id!==null){ var px=getPlayer(id); if(px){ px.name=name; px.usta=usta; px.fees=fees; px.memberStatus=memberStatus; } }
    else {
      var used={};
      for(var i=0;i<S.players.length;i++) used[S.players[i].id]=true;
      var nid=1; while(used[nid]&&nid<1000) nid++;
      S.players.push({id:nid,name:name,usta:usta,fees:fees,memberStatus:memberStatus});
    }
    save(); closeModal();
  });
}

// â”€â”€ CSV IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSheetSync(){
  showModal('<h3>ğŸ“‹ Copy from .CSV</h3>'
    +'<div class="alert alert-info" style="margin-bottom:10px">'
    +'<strong>How to import:</strong><br>1. Open your CSV file in Excel or Google Sheets<br>2. Select all data including header row (Ctrl+A)<br>3. Copy (Ctrl+C)<br>4. Paste below and click Import<br><br>'
    +'Column order: <strong>Player ID, Name, USTA Rating, Member Status, Fee Paid</strong></div>'
    +'<label>Paste CSV Data</label>'
    +'<textarea id="m-csv" rows="10" placeholder="Player ID&#9;Name&#9;USTA Rating&#9;Member Status&#9;Fee Paid&#10;1&#9;John Smith&#9;3.5&#9;Active&#9;150"></textarea>'
    +'<div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Cancel</button><button class="btn btn-primary" id="m-sync">Import</button></div>');
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-sync').addEventListener('click',function(){
    var raw=byId('m-csv').value.trim();
    if(!raw){ showToast('Please paste your CSV data.'); return; }
    var delim=raw.split('\n')[0].indexOf('\t')>=0?'\t':',';
    var rows=parseDelimited(raw,delim);
    if(!rows.length){ showToast('No data rows found. Make sure you included a header row.'); return; }
    var result=importRows(rows);
    save(); closeModal();
    showToast('Import complete! Added: '+result.added+'  Updated: '+result.updated+'  Skipped: '+result.skipped);
  });
}
function parseDelimited(text,delim){
  var lines=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').trim().split('\n'), rows=[];
  for(var i=1;i<lines.length;i++){
    var line=lines[i].trim(); if(!line) continue;
    var cols=line.split(delim);
    for(var j=0;j<cols.length;j++) cols[j]=cols[j].trim().replace(/^"|"$/g,'');
    rows.push(cols);
  }
  return rows;
}
function importRows(rows){
  var added=0,updated=0,skipped=0;
  for(var i=0;i<rows.length;i++){
    var row=rows[i]; if(row.length<2){ skipped++; continue; }
    var pid=parseInt(row[0]),name=(row[1]||'').trim(),usta=(row[2]||'3.0').trim();
    var memberStatus=(row[3]||'Active').trim()||'Active';
    var fees=parseFloat(row[4])||0;
    if(!pid||!name){ skipped++; continue; }
    var ex=getPlayer(pid);
    if(ex){ ex.name=name; ex.usta=usta; ex.memberStatus=memberStatus; ex.fees=fees; updated++; }
    else { S.players.push({id:pid,name:name,usta:usta,memberStatus:memberStatus,fees:fees}); added++; }
  }
  return{added:added,updated:updated,skipped:skipped};
}

// â”€â”€ CSV EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV(){
  if(!S.players.length){ showToast('No players to export.'); return; }
  var rows=[['Player ID','Name','USTA Rating','Member Status','Fee Paid']];
  for(var i=0;i<S.players.length;i++){ var p=S.players[i]; rows.push([fmtId(p.id),p.name,p.usta,p.memberStatus||'Active',p.fees||0]); }
  var csv='';
  for(var i=0;i<rows.length;i++){
    var cols=[]; for(var j=0;j<rows[i].length;j++) cols.push('"'+String(rows[i][j]).replace(/"/g,'""')+'"');
    csv+=cols.join(',')+'\r\n';
  }
  try{
    var blob=new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob), a=document.createElement('a');
    a.href=url; a.download='dmv_tennis_roster.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    showToast('Roster exported!');
  }catch(e){ showToast('Export not supported in this browser.'); }
}


// â”€â”€ STATS CSV EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadCSV(csv, filename){
  try{
    var blob=new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob), a=document.createElement('a');
    a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  }catch(e){ showToast('Export not supported in this browser.'); }
}
function rowsToCsv(rows){
  var csv='';
  for(var i=0;i<rows.length;i++){
    var cols=[]; for(var j=0;j<rows[i].length;j++) cols.push('"'+String(rows[i][j]).replace(/"/g,'""')+'"');
    csv+=cols.join(',')+'\r\n';
  }
  return csv;
}
function exportStats(){
  var season=S.currentSeason;
  if(!S.players.length){ showToast('No players to export.'); return; }
  var today=new Date().toISOString().slice(0,10);

  // â”€â”€ Season Total CSV â”€â”€
  var seasonRows=[['Player ID','Name','Season','Matches Won','Matches Lost','Games Won','Games Lost','Attendance','Byes','Total Points']];
  for(var i=0;i<S.players.length;i++){
    var p=S.players[i];
    var st=getPlayerStats(p.id,season);
    var bc=(S.byeCounts[p.id]||{})[season]||0;
    var att=(S.playerStats[p.id]||{})[season+'_att']||0;
    var pts=calcTotalPoints(p.id,season);
    seasonRows.push([fmtId(p.id),p.name,season,st.wins,st.losses,st.gamesWon,st.gamesLost,att,bc,pts]);
  }
  downloadCSV(rowsToCsv(seasonRows), 'dmv_stats_season_total_'+season.toLowerCase()+'_'+today+'.csv');

  // â”€â”€ Per Session CSV â”€â”€
  var dates=(S.seasons[season]||[]).slice().sort();
  var perRows=[['Player ID','Name','Session Date','Matches Won','Matches Lost','Games Won','Games Lost','Byes','Points']];
  for(var di=0;di<dates.length;di++){
    var date=dates[di];
    var sess=S.sessions[date]; if(!sess||!sess.assignments) continue;
    var sessionStats=buildSessionStats(date, sess);
    for(var i=0;i<S.players.length;i++){
      var p=S.players[i];
      var ss=sessionStats[p.id]||{wins:0,losses:0,gamesWon:0,gamesLost:0,byes:0};
      var ssPts=calcTotalPoints(p.id,S.currentSeason);
      perRows.push([fmtId(p.id),p.name,date,ss.wins,ss.losses,ss.gamesWon,ss.gamesLost,ss.byes,ssPts]);
    }
  }
  setTimeout(function(){
    downloadCSV(rowsToCsv(perRows), 'dmv_stats_per_session_'+season.toLowerCase()+'_'+today+'.csv');
    showToast('Exported 2 CSV files: season total + per session!');
  }, 300);
}

// â”€â”€ STATS CSV IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openImportStats(){
  var allSeasonKeys=Object.keys(S.seasons||{});
  var season=S.currentSeason;

  var sessOpts='<option value="">-- Select Session --</option>';
  allSeasonKeys.forEach(function(s){
    var dates=(S.seasons[s]||[]).slice().sort().reverse();
    dates.forEach(function(d){
      var parts=d.split('-'), label=parts.length===3?parts[1]+'/'+parts[2]+'/'+parts[0]:d;
      sessOpts+='<option value="'+d+'|'+s+'">'+label+'</option>';
    });
  });

  var seasonOpts='';
  allSeasonKeys.forEach(function(s){ seasonOpts+='<option value="'+s+'">'+s+'</option>'; });

  var html='<h3>ğŸ“¥ Import Stats from CSV</h3>';
  html+='<div class="alert alert-info" style="margin-bottom:12px">Import will <strong>merge</strong> stats into existing data. Player matching is by Player ID.</div>';
  html+='<div style="display:flex;flex-direction:column;gap:14px">';
  html+='<div style="border:1.5px solid #e8f5e9;border-radius:8px;padding:14px">';
  html+='<div style="font-weight:700;margin-bottom:4px">Option 1 â€” Season Total</div>';
  html+='<div style="font-size:.8rem;color:#555;margin-bottom:8px">CSV columns: <code>Player ID, Name, Season, Matches Won, Matches Lost, Games Won, Games Lost, Attendance, Byes, Total Points</code></div>';
  html+='<label style="font-size:.82rem;font-weight:600">Target Season</label>';
  html+='<select id="is-season-sel" style="width:100%;padding:7px;border-radius:6px;border:1.5px solid #ccc;margin-bottom:8px">'+seasonOpts+'</select>';
  html+='<label style="font-size:.82rem;font-weight:600">CSV File</label>';
  html+='<input type="file" id="is-season-file" accept=".csv" style="width:100%;margin-bottom:8px">';
  html+='<button class="btn btn-green btn-sm" id="is-season-btn">Import Season Stats</button>';
  html+='</div>';
  html+='<div style="border:1.5px solid #e8f5e9;border-radius:8px;padding:14px">';
  html+='<div style="font-weight:700;margin-bottom:4px">Option 2 â€” Single Session</div>';
  html+='<div style="font-size:.8rem;color:#555;margin-bottom:8px">CSV columns: <code>Player ID, Name, Session Date, Matches Won, Matches Lost, Games Won, Games Lost, Byes, Points</code></div>';
  html+='<label style="font-size:.82rem;font-weight:600">Target Session</label>';
  html+='<select id="is-sess-sel" style="width:100%;padding:7px;border-radius:6px;border:1.5px solid #ccc;margin-bottom:8px">'+sessOpts+'</select>';
  html+='<label style="font-size:.82rem;font-weight:600">CSV File</label>';
  html+='<input type="file" id="is-sess-file" accept=".csv" style="width:100%;margin-bottom:8px">';
  html+='<button class="btn btn-green btn-sm" id="is-sess-btn">Import Session Stats</button>';
  html+='</div>';
  html+='</div>';
  html+='<div id="is-result" style="margin-top:10px;font-size:.85rem"></div>';
  html+='<div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Close</button></div>';
  showModal(html);
  byId('m-cancel').addEventListener('click',closeModal);

  function parseCsvText(text){
    var rows=[];
    var lines=text.split(/\r\n|\r|\n/);
    for(var i=0;i<lines.length;i++){
      var line=lines[i].trim();
      if(!line) continue;
      var cols=[], cur='', inQ=false;
      for(var j=0;j<line.length;j++){
        var ch=line[j];
        if(ch==='"'){ if(inQ&&line[j+1]==='"'){ cur+='"'; j++; } else inQ=!inQ; }
        else if(ch===','&&!inQ){ cols.push(cur); cur=''; }
        else cur+=ch;
      }
      cols.push(cur);
      rows.push(cols.map(function(v){ return v.trim(); }));
    }
    return rows;
  }

  function showResult(msg, ok){
    var el=byId('is-result');
    if(el) el.innerHTML='<div style="padding:8px 12px;border-radius:6px;background:'+(ok?'#d4edda':'#f8d7da')+';color:'+(ok?'#155724':'#721c24')+'">'+msg+'</div>';
  }

  byId('is-season-btn').addEventListener('click',function(){
    var selSeason=byId('is-season-sel').value;
    var file=byId('is-season-file').files[0];
    if(!selSeason){ showResult('Select a target season.', false); return; }
    if(!file){ showResult('Choose a CSV file.', false); return; }
    var reader=new FileReader();
    reader.onload=function(e){
      try{
        var rows=parseCsvText(e.target.result);
        var dataRows=rows.filter(function(r){ return r.length>=8 && !isNaN(parseInt(r[0])); });
        if(!dataRows.length){ showResult('No valid data rows found. Check CSV format.', false); return; }
        if(!S.playerStats) S.playerStats={};
        if(!S.byeCounts) S.byeCounts={};
        var imported=0, skipped=0;
        dataRows.forEach(function(r){
          var pid=parseInt(r[0]);
          if(!pid){ skipped++; return; }
          var mWon=parseInt(r[3])||0, mLost=parseInt(r[4])||0;
          var gWon=parseInt(r[5])||0, gLost=parseInt(r[6])||0;
          var att=parseInt(r[7])||0, byes=parseInt(r[8])||0;
          if(!S.playerStats[pid]) S.playerStats[pid]={};
          var st=S.playerStats[pid][selSeason]||{wins:0,losses:0,gamesWon:0,gamesLost:0};
          st.wins+=mWon; st.losses+=mLost; st.gamesWon+=gWon; st.gamesLost+=gLost;
          S.playerStats[pid][selSeason]=st;
          S.playerStats[pid][selSeason+'_att']=(S.playerStats[pid][selSeason+'_att']||0)+att;
          if(!S.byeCounts[pid]) S.byeCounts[pid]={};
          S.byeCounts[pid][selSeason]=(S.byeCounts[pid][selSeason]||0)+byes;
          imported++;
        });
        save(); render();
        showResult('Imported '+imported+' player rows into season "'+selSeason+'".'+(skipped?' Skipped '+skipped+' rows.':''), true);
      }catch(err){ showResult('Error parsing CSV: '+err.message, false); }
    };
    reader.readAsText(file);
  });

  byId('is-sess-btn').addEventListener('click',function(){
    var val=byId('is-sess-sel').value;
    if(!val){ showResult('Select a target session.', false); return; }
    var parts=val.split('|'), selDate=parts[0], selSeason=parts[1];
    var file=byId('is-sess-file').files[0];
    if(!file){ showResult('Choose a CSV file.', false); return; }
    var reader=new FileReader();
    reader.onload=function(e){
      try{
        var rows=parseCsvText(e.target.result);
        var dataRows=rows.filter(function(r){ return r.length>=7 && !isNaN(parseInt(r[0])); });
        if(!dataRows.length){ showResult('No valid data rows found. Check CSV format.', false); return; }
        if(!S.playerStats) S.playerStats={};
        if(!S.byeCounts) S.byeCounts={};
        var imported=0, skipped=0;
        dataRows.forEach(function(r){
          var pid=parseInt(r[0]);
          if(!pid){ skipped++; return; }
          var rowDate=r[2]||'';
          // Normalize CSV date: accept yyyy-mm-dd or mm/dd/yyyy
          if(rowDate){
            var mmddyyyy=rowDate.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if(mmddyyyy) rowDate=mmddyyyy[3]+'-'+('0'+mmddyyyy[1]).slice(-2)+'-'+('0'+mmddyyyy[2]).slice(-2);
          }
          if(rowDate && rowDate!==selDate){ skipped++; return; }
          var mWon=parseInt(r[3])||0, mLost=parseInt(r[4])||0;
          var gWon=parseInt(r[5])||0, gLost=parseInt(r[6])||0;
          var byes=parseInt(r[7])||0;
          if(!S.playerStats[pid]) S.playerStats[pid]={};
          var st=S.playerStats[pid][selSeason]||{wins:0,losses:0,gamesWon:0,gamesLost:0};
          st.wins+=mWon; st.losses+=mLost; st.gamesWon+=gWon; st.gamesLost+=gLost;
          S.playerStats[pid][selSeason]=st;
          if(!S.byeCounts[pid]) S.byeCounts[pid]={};
          S.byeCounts[pid][selSeason]=(S.byeCounts[pid][selSeason]||0)+byes;
          imported++;
        });
        save(); render();
        showResult('Imported '+imported+' player rows for '+fmtDate(selDate)+' into "'+selSeason+'".'+(skipped?' Skipped '+skipped+'.':''), true);
      }catch(err){ showResult('Error parsing CSV: '+err.message, false); }
    };
    reader.readAsText(file);
  });
}


// â”€â”€ STATS CSV IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openClearStats(){
  var season=S.currentSeason;
  var allSeasonKeys=Object.keys(S.seasons||{});

  // Build session options for this season
  var sessOpts='<option value="">-- Select Session --</option>';
  var sessDates=(S.seasons[season]||[]).slice().sort().reverse();
  sessDates.forEach(function(d){ sessOpts+='<option value="'+d+'">'+fmtDate(d)+'</option>'; });

  // Build season options
  var seasonOpts='';
  allSeasonKeys.forEach(function(s){ seasonOpts+='<option value="'+s+'">'+s+'</option>'; });

  showModal('<h3>ğŸ—‘ Clear Stats</h3>'
    +'<div class="alert alert-info" style="margin-bottom:12px">Choose what to clear. This cannot be undone.</div>'
    +'<div style="display:flex;flex-direction:column;gap:10px">'
    +'<div style="border:1.5px solid #e8f5e9;border-radius:8px;padding:12px">'
    +'<div style="font-weight:700;margin-bottom:6px">1. Clear a Single Session</div>'
    +'<select id="cs-session-sel" style="width:100%;padding:8px;border-radius:6px;border:1.5px solid #ccc;margin-bottom:8px">'+sessOpts+'</select>'
    +'<button class="btn btn-danger btn-sm" id="cs-session-btn">Clear This Session Stats</button>'
    +'</div>'
    +'<div style="border:1.5px solid #e8f5e9;border-radius:8px;padding:12px">'
    +'<div style="font-weight:700;margin-bottom:6px">2. Clear All Stats for a Season</div>'
    +'<select id="cs-season-sel" style="width:100%;padding:8px;border-radius:6px;border:1.5px solid #ccc;margin-bottom:8px">'+seasonOpts+'</select>'
    +'<button class="btn btn-danger btn-sm" id="cs-season-btn">Clear Season Stats</button>'
    +'</div>'
    +'<div style="border:1.5px solid #fee2e2;border-radius:8px;padding:12px;background:#fff5f5">'
    +'<div style="font-weight:700;color:#991b1b;margin-bottom:6px">3. Clear ALL Stats (All Seasons)</div>'
    +'<button class="btn btn-danger btn-sm" id="cs-all-btn">Clear All Stats</button>'
    +'</div>'
    +'</div>'
    +'<div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Close</button></div>');

  byId('m-cancel').addEventListener('click',closeModal);

  byId('cs-session-btn').addEventListener('click',function(){
    var d=byId('cs-session-sel').value;
    if(!d){ showToast('Select a session first.'); return; }
    // Clear only scores for this session then rebuild stats from remaining scores
    if(S.sessions[d]){
      S.sessions[d].scores={};
    }
    // Rebuild all season stats from scratch (re-tallies everything except cleared session)
    Object.keys(S.seasons||{}).forEach(function(s){
      rebuildSeasonStats(s);
    });
    save(); closeModal(); render();
    showToast('Session scores cleared for '+fmtDate(d)+'. Stats recalculated.');
  });

  byId('cs-season-btn').addEventListener('click',function(){
    var s=byId('cs-season-sel').value;
    if(!s){ showToast('Select a season first.'); return; }
    // Clear all scores for every session in this season
    var dates=(S.seasons[s]||[]);
    dates.forEach(function(d){
      if(S.sessions[d]) S.sessions[d].scores={};
    });
    // Clear bye counts for this season
    if(S.byeCounts){
      Object.keys(S.byeCounts).forEach(function(pid){
        if(S.byeCounts[pid]) delete S.byeCounts[pid][s];
      });
    }
    // Rebuild season stats (will be empty now)
    rebuildSeasonStats(s);
    save(); closeModal(); render();
    showToast('All scores and stats cleared for season: '+s+'.');
  });

  byId('cs-all-btn').addEventListener('click',function(){
    if(!confirm('Clear ALL scores and stats for ALL seasons? This cannot be undone.')) return;
    // Clear all session scores
    Object.keys(S.sessions||{}).forEach(function(d){
      if(S.sessions[d]) S.sessions[d].scores={};
    });
    S.playerStats={};
    S.byeCounts={};
    save(); closeModal(); render();
    showToast('All stats cleared.');
  });
}


// â”€â”€ POINTS CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function savePointsConfig(){
  var mw=byId('cfg-match-win'), gw=byId('cfg-game-win'), att=byId('cfg-att');
  if(!mw||!gw||!att) return;
  if(!S.pointsConfig) S.pointsConfig={};
  S.pointsConfig.matchWin=Math.max(0,parseInt(mw.value)||0);
  S.pointsConfig.gameWin=Math.max(0,parseInt(gw.value)||0);
  S.pointsConfig.attendance=Math.max(0,parseInt(att.value)||0);
  // excludeOutliers state managed by toggle button (already saved on click)
  save(); render();
  showToast('Points config saved!');
}

// â”€â”€ BONUS POINTS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openBonusPointsModal(){
  var season=S.currentSeason;
  if(!S.players.length){ showToast('No players in roster.'); return; }
  var pOpts='<option value="ALL">All Players</option>';
  for(var i=0;i<S.players.length;i++) pOpts+='<option value="'+S.players[i].id+'">'+fmtId(S.players[i].id)+' '+esc(S.players[i].name)+'</option>';
  showModal('<h3>ğŸ Award Bonus Points</h3>'
    +'<div class="alert alert-info" style="margin-bottom:10px">Award or deduct points for this season. Use negative values to deduct.</div>'
    +'<label>Player</label><select id="bonus-pid-sel" style="padding:8px;border-radius:6px;border:1.5px solid #ccc;width:100%;margin-bottom:8px">'+pOpts+'</select>'
    +'<label>Points (negative to deduct)</label><input id="bonus-pts-val" type="number" value="1" style="margin-bottom:8px">'
    +'<label>Description (optional)</label><input id="bonus-desc" type="text" placeholder="e.g. Most improved, late cancel, no-show..." style="margin-bottom:8px">'
    +'<div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Cancel</button><button class="btn btn-primary" id="m-bonus-save">Award Points</button></div>');
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-bonus-save').addEventListener('click',function(){
    var pidVal=byId('bonus-pid-sel').value;
    var pts=parseInt(byId('bonus-pts-val').value)||0;
    var desc=(byId('bonus-desc').value||'').trim();
    if(!S.playerStats) S.playerStats={};
    if(!S.pointsConfig) S.pointsConfig={matchWin:3,gameWin:1,attendance:1};
    if(!S.pointsConfig.bonusPoints) S.pointsConfig.bonusPoints=[];
    var targets=pidVal==='ALL'?S.players.map(function(p){ return p.id; }):[parseInt(pidVal)];
    targets.forEach(function(pid){
      if(!S.playerStats[pid]) S.playerStats[pid]={};
      var key=season+'_bonus';
      S.playerStats[pid][key]=(S.playerStats[pid][key]||0)+pts;
    });
    // Log bonus award
    S.pointsConfig.bonusPoints.push({season:season,pids:targets,pts:pts,desc:desc,ts:Date.now()});
    save(); closeModal(); render();
    showToast('Awarded '+pts+' bonus point'+(pts!==1?'s':'')+' to '+(pidVal==='ALL'?'all players':getPlayer(parseInt(pidVal))&&getPlayer(parseInt(pidVal)).name||'player')+'!');
  });
}

// â”€â”€ TEAM BATTLE WINNER SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function teamBattleWinnerHTML(sess){
  if(!sess||!sess.teamBattle||!sess.assignments||!sess.assignments.rounds) return '';
  var teamA=sess.teamA||[], teamB=sess.teamB||[];
  if(!teamA.length||!teamB.length) return '';
  var scores=sess.scores||{};
  var aWins=0, bWins=0, aGames=0, bGames=0, matchesScored=0;
  var rounds=sess.assignments.rounds;
  for(var ri=0;ri<rounds.length;ri++){
    var round=rounds[ri]; if(!round||!round.courts) continue;
    for(var ci=0;ci<round.courts.length;ci++){
      var court=round.courts[ci]; if(!court||!court.teams||court.teams.length<2) continue;
      var key=ri+'_'+ci, sc=scores[key];
      if(!sc||sc.t1===''||sc.t2==='') continue;
      var s1=parseInt(sc.t1), s2=parseInt(sc.t2);
      if(isNaN(s1)||isNaN(s2)) continue;
      matchesScored++;
      var t0=court.teams[0]||[], t1=court.teams[1]||[];
      var t0isA=t0.some(function(pid){ return teamA.some(function(id){ return id==pid; }); });
      var aScore=t0isA?s1:s2, bScore=t0isA?s2:s1;
      if(aScore>bScore) aWins++; else if(bScore>aScore) bWins++;
      aGames+=aScore; bGames+=bScore;
    }
  }
  if(matchesScored===0) return '';
  // Check all matches scored (complete)
  var totalCourts=0;
  for(var ri=0;ri<rounds.length;ri++){
    if(rounds[ri]&&rounds[ri].courts) totalCourts+=rounds[ri].courts.length;
  }
  var allDone=matchesScored>=totalCourts;
  var winner=aWins>bWins?'A':bWins>aWins?'B':aGames>bGames?'A':bGames>aGames?'B':'TIE';
  var h='<div style="background:'+(allDone?'#e8f5e9':'#fffde7')+';border:2px solid '+(allDone?'#1a5c2a':'#f5a623')+';border-radius:10px;padding:12px 16px;margin-bottom:12px">';
  h+='<div style="font-weight:700;font-size:.95rem;color:#1a5c2a;margin-bottom:8px">'+(allDone?'ğŸ† Final Result':'ğŸ“Š Running Score')+'</div>';
  h+='<div style="display:flex;gap:12px;flex-wrap:wrap">';
  // Team A
  var aIsWinner=allDone&&winner==='A';
  h+='<div style="flex:1;min-width:120px;background:'+(aIsWinner?'#1e40af':'#dbeafe')+';color:'+(aIsWinner?'#fff':'#1e40af')+';border-radius:8px;padding:10px;text-align:center">';
  if(aIsWinner) h+='<div style="font-size:1.2rem">ğŸ†</div>';
  h+='<div style="font-weight:700;font-size:.95rem">ğŸ”µ Team A</div>';
  h+='<div style="font-size:1.4rem;font-weight:700">'+aWins+'</div>';
  h+='<div style="font-size:.75rem;opacity:.85">wins Â· '+aGames+' games</div>';
  h+='</div>';
  // VS
  h+='<div style="display:flex;align-items:center;font-weight:700;color:#888;font-size:1rem">VS</div>';
  // Team B
  var bIsWinner=allDone&&winner==='B';
  h+='<div style="flex:1;min-width:120px;background:'+(bIsWinner?'#991b1b':'#fee2e2')+';color:'+(bIsWinner?'#fff':'#991b1b')+';border-radius:8px;padding:10px;text-align:center">';
  if(bIsWinner) h+='<div style="font-size:1.2rem">ğŸ†</div>';
  h+='<div style="font-weight:700;font-size:.95rem">ğŸ”´ Team B</div>';
  h+='<div style="font-size:1.4rem;font-weight:700">'+bWins+'</div>';
  h+='<div style="font-size:.75rem;opacity:.85">wins Â· '+bGames+' games</div>';
  h+='</div>';
  h+='</div>';
  if(allDone){
    if(winner==='TIE') h+='<div style="margin-top:8px;font-size:.85rem;font-weight:700;color:#856404;text-align:center">ğŸ¤ It\'s a tie!</div>';
    else h+='<div style="margin-top:8px;font-size:.85rem;font-weight:700;color:#1a5c2a;text-align:center">Team '+(winner==='A'?'A':'B')+' wins'+(aWins===bWins?' (tiebreaker: most games)':'')+'!</div>';
  } else {
    h+='<div style="margin-top:6px;font-size:.75rem;color:#888">'+matchesScored+' of '+totalCourts+' matches scored</div>';
  }
  h+='</div>';
  return h;
}

// â”€â”€ ATTENDANCE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAttendanceModal(){
  var season=S.currentSeason;
  if(!S.players.length){ showToast('No players in roster.'); return; }
  var rows='';
  for(var i=0;i<S.players.length;i++){
    var p=S.players[i];
    var att=(S.playerStats[p.id]||{})[season+'_att']||0;
    rows+='<tr>'
    +'<td>'+fmtId(p.id)+'</td>'
    +'<td>'+esc(p.name)+'</td>'
    +'<td><input class="att-input" type="number" min="0" data-pid="'+p.id+'" value="'+att+'" style="width:70px;padding:6px;border:1.5px solid #ccc;border-radius:6px;font-size:.9rem;margin:0"></td>'
    +'</tr>';
  }
  showModal('<h3>ğŸ“… Session Attendance â€” '+esc(season)+'</h3>'
    +'<div class="alert alert-info" style="margin-bottom:10px">Enter total sessions attended this season per player.</div>'
    +'<div style="overflow-y:auto;max-height:50vh">'
    +'<table><tr><th>ID</th><th>Name</th><th>Sessions</th></tr>'+rows+'</table>'
    +'</div>'
    +'<div class="modal-btns">'
    +'<button class="btn btn-secondary" id="m-cancel">Cancel</button>'
    +'<button class="btn btn-primary" id="m-att-save">Save</button>'
    +'</div>');
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-att-save').addEventListener('click',function(){
    if(!S.playerStats) S.playerStats={};
    var inputs=document.querySelectorAll('.att-input');
    inputs.forEach(function(inp){
      var pid=parseInt(inp.dataset.pid), val=Math.max(0,parseInt(inp.value)||0);
      if(!S.playerStats[pid]) S.playerStats[pid]={};
      S.playerStats[pid][season+'_att']=val;
    });
    save(); closeModal(); showToast('Attendance saved!');
  });
}

// â”€â”€ MANUAL PARTNERS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openManualPartnersModal(){
  var date=S.selectedDate; if(!date){ showToast('No date selected.'); return; }
  var sess=getSession(date);
  var inP=getInPlayers(date);
  if(inP.length<2){ showToast('Need at least 2 players marked IN.'); return; }

  // Build rounds (use existing assignment count or default from settings)
  var ppCourt=sess.type==='singles'?2:4;
  var playPerRound=Math.min(inP.length,sess.courts*ppCourt);
  var activeCourts=Math.floor(playPerRound/ppCourt);
  var totalRounds=Math.ceil((inP.length*(sess.matchesPerPlayer||4))/Math.max(1,playPerRound));
  if(totalRounds<1) totalRounds=1;
  if(totalRounds>8) totalRounds=8;

  // Load existing manual assignments if any
  var manual=sess.manualAssignments||{};

  var pOpts='<option value="">â€” unassigned â€”</option>';
  for(var i=0;i<inP.length;i++) pOpts+='<option value="'+inP[i].id+'">'+fmtId(inP[i].id)+' '+esc(inP[i].name)+'</option>';

  // Build pOpts with â˜… marker for already-assigned players in a given round
  function buildPOptsForRound(r, currentSlotPid){
    var assigned={};
    for(var ci=0;ci<activeCourts;ci++){
      var s=manual['r'+r+'c'+ci]||{};
      [s.t1p1,s.t1p2,s.t2p1,s.t2p2].forEach(function(pid){ if(pid) assigned[pid]=true; });
    }
    var o='<option value="">â€” unassigned â€”</option>';
    for(var i=0;i<inP.length;i++){
      var pid=inP[i].id;
      var isCurr=pid==currentSlotPid;
      var isAssigned=assigned[pid]&&!isCurr;
      o+='<option value="'+pid+'"'+(isCurr?' selected':'')+'>'
        +(isAssigned?'â˜… ':'')+fmtId(pid)+' '+esc(inP[i].name)+(isAssigned?' (assigned)':'')
        +'</option>';
    }
    return o;
  }

  // Rebuild all select options in a round to reflect current assignments (live â˜… update)
  function refreshRoundStars(r){
    document.querySelectorAll('.mp-sel[data-round="'+r+'"]').forEach(function(sel){
      var currentVal=sel.value?parseInt(sel.value):null;
      sel.innerHTML=buildPOptsForRound(r, currentVal);
    });
  }

  // Read current DOM values for a round into manual object
  function readRoundFromDOM(r){
    document.querySelectorAll('.mp-sel[data-round="'+r+'"]').forEach(function(s){
      if(!manual[s.dataset.key]) manual[s.dataset.key]={};
      manual[s.dataset.key][s.dataset.slot]=s.value?parseInt(s.value):null;
    });
  }

  // Clear all slots for a round
  function clearRound(r){
    for(var c=0;c<activeCourts;c++){
      var key='r'+r+'c'+c;
      manual[key]={t1p1:null,t1p2:null,t2p1:null,t2p2:null};
    }
    document.querySelectorAll('.mp-sel[data-round="'+r+'"]').forEach(function(s){ s.value=''; });
    refreshRoundStars(r);
  }

  var isSingles=sess.type==='singles';
  var body='<h3>ğŸ¾ Manual Partner Assignment</h3>'
    +'<div class="alert alert-info" style="margin-bottom:10px">â˜… = already assigned this round. Use <strong>Save</strong> per round or <strong>Save All</strong> at bottom. Click <strong>Generate Court Assignments</strong> on the session page to apply.</div>';

  for(var r=0;r<totalRounds;r++){
    body+='<div class="mp-round-block" data-r="'+r+'" style="margin-bottom:18px;border:1.5px solid #c8e6c9;border-radius:10px;padding:10px">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">'
      +'<strong style="color:#1a5c2a;font-size:.95rem">Round '+(r+1)+'</strong>'
      +'<div style="display:flex;gap:6px">'
      +'<button class="btn btn-green btn-sm mp-round-save" data-r="'+r+'">ğŸ’¾ Save Round</button>'
      +'<button class="btn btn-danger btn-sm mp-round-clear" data-r="'+r+'">âœ• Clear</button>'
      +'</div></div>';
    for(var c=0;c<activeCourts;c++){
      var key='r'+r+'c'+c;
      var slot=manual[key]||{t1p1:'',t1p2:'',t2p1:'',t2p2:''};
      body+='<div style="border:1.5px solid #eee;border-radius:8px;padding:8px;margin-top:6px">'
        +'<div style="font-size:.78rem;color:#888;margin-bottom:4px">Court '+(c+1)+'</div>'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
      if(isSingles){
        body+='<div><div style="font-size:.7rem;font-weight:700;color:#1e40af;margin-bottom:2px">ğŸ”µ Team 1</div>'
          +'<select class="mp-sel" data-round="'+r+'" data-key="'+key+'" data-slot="t1p1" style="width:100%;font-size:.82rem">'+buildPOptsForRound(r,slot.t1p1)+'</select></div>'
          +'<div><div style="font-size:.7rem;font-weight:700;color:#991b1b;margin-bottom:2px">ğŸ”´ Team 2</div>'
          +'<select class="mp-sel" data-round="'+r+'" data-key="'+key+'" data-slot="t2p1" style="width:100%;font-size:.82rem">'+buildPOptsForRound(r,slot.t2p1)+'</select></div>';
      } else {
        body+='<div><div style="font-size:.7rem;font-weight:700;color:#1e40af;margin-bottom:2px">ğŸ”µ Team 1</div>'
          +'<select class="mp-sel" data-round="'+r+'" data-key="'+key+'" data-slot="t1p1" style="width:100%;font-size:.8rem;margin-bottom:3px">'+buildPOptsForRound(r,slot.t1p1)+'</select>'
          +'<select class="mp-sel" data-round="'+r+'" data-key="'+key+'" data-slot="t1p2" style="width:100%;font-size:.8rem">'+buildPOptsForRound(r,slot.t1p2)+'</select></div>'
          +'<div><div style="font-size:.7rem;font-weight:700;color:#991b1b;margin-bottom:2px">ğŸ”´ Team 2</div>'
          +'<select class="mp-sel" data-round="'+r+'" data-key="'+key+'" data-slot="t2p1" style="width:100%;font-size:.8rem;margin-bottom:3px">'+buildPOptsForRound(r,slot.t2p1)+'</select>'
          +'<select class="mp-sel" data-round="'+r+'" data-key="'+key+'" data-slot="t2p2" style="width:100%;font-size:.8rem">'+buildPOptsForRound(r,slot.t2p2)+'</select></div>';
      }
      body+='</div></div>';
    }
    body+='</div>';
  }

  body+='<div style="border-top:2px solid #e8f5e9;padding-top:12px;margin-top:4px;display:flex;gap:8px;flex-wrap:wrap">'
    +'<button class="btn btn-secondary" id="m-mp-exit">âœ• Exit</button>'
    +'<button class="btn btn-danger" id="m-mp-clear-all">ğŸ—‘ Clear All</button>'
    +'<button class="btn btn-green" id="m-mp-save-all" style="flex:1">ğŸ’¾ Save All Rounds</button>'
    +'</div>';

  showModal(body);

  // Live â˜… on change
  document.querySelectorAll('.mp-sel').forEach(function(sel){
    sel.addEventListener('change',function(){
      var r=parseInt(sel.dataset.round);
      readRoundFromDOM(r);
      refreshRoundStars(r);
    });
  });

  // Per-round save
  document.querySelectorAll('.mp-round-save').forEach(function(btn){
    btn.addEventListener('click',function(){
      var r=parseInt(btn.dataset.r);
      readRoundFromDOM(r);
      sess.manualAssignments=manual; S.sessions[date]=sess; save();
      showToast('Round '+(r+1)+' saved!');
    });
  });

  // Per-round clear
  document.querySelectorAll('.mp-round-clear').forEach(function(btn){
    btn.addEventListener('click',function(){ clearRound(parseInt(btn.dataset.r)); });
  });

  byId('m-mp-exit').addEventListener('click',closeModal);

  byId('m-mp-clear-all').addEventListener('click',function(){
    for(var r2=0;r2<totalRounds;r2++) clearRound(r2);
    sess.manualAssignments={}; S.sessions[date]=sess; save();
    showToast('All rounds cleared!');
  });

  byId('m-mp-save-all').addEventListener('click',function(){
    for(var r2=0;r2<totalRounds;r2++) readRoundFromDOM(r2);
    sess.manualAssignments=manual; S.sessions[date]=sess; save();
    showToast('All rounds saved! Use Generate Court Assignments to apply.');
  });
}

function buildOptGroup(label, selectedVal, pOpts){
  return '<option value="" style="color:#aaa">'+label+'</option>'
    +pOpts.replace('value="'+selectedVal+'"','value="'+selectedVal+'" selected');
}

function generateAssignmentsWithManual(date, sess, manual){
  var inP=getInPlayers(date);
  var ppCourt=sess.type==='singles'?2:4;
  var playPerRound=Math.min(inP.length,sess.courts*ppCourt);
  var activeCourts=Math.floor(playPerRound/ppCourt);
  var totalRounds=Math.ceil((inP.length*(sess.matchesPerPlayer||4))/Math.max(1,playPerRound));
  if(totalRounds<1) totalRounds=1; if(totalRounds>8) totalRounds=8;

  var usedSet={};
  var allRounds=[];

  if(!S.byeCounts) S.byeCounts={};
  for(var i=0;i<inP.length;i++) if(!S.byeCounts[inP[i].id]) S.byeCounts[inP[i].id]={};
  var seasonByes={};
  for(var i=0;i<inP.length;i++) seasonByes[inP[i].id]=(S.byeCounts[inP[i].id][S.currentSeason])||0;

  for(var r=0;r<totalRounds;r++){
    var assigned={};
    var roundCourts=[];

    // First pass: apply manual assignments
    for(var c=0;c<activeCourts;c++){
      var key='r'+r+'c'+c;
      var slot=manual[key];
      var teams=[[],[]];
      if(slot){
        var slots=[slot.t1p1,slot.t1p2,slot.t2p1,slot.t2p2];
        var si=0;
        for(var ti=0;ti<2;ti++){
          var count=ppCourt/2;
          for(var pi=0;pi<count;pi++){
            var pid=slots[si++];
            if(pid){ teams[ti].push(pid); assigned[pid]=true; }
          }
        }
      }
      roundCourts.push({teams:teams, key:key});
    }

    // Second pass: auto-fill remaining players using USTA sort
    var unassigned=inP.filter(function(p){ return !assigned[p.id]; });
    unassigned.sort(function(a,b){ return parseFloat(b.usta)-parseFloat(a.usta); });

    // Determine byes from unassigned excess
    var slotsNeeded=activeCourts*ppCourt;
    var alreadyAssignedCount=Object.keys(assigned).length;
    var slotsLeft=slotsNeeded-alreadyAssignedCount;
    var byes=[];
    if(unassigned.length>slotsLeft){
      var byeCount=unassigned.length-slotsLeft;
      // pick byes from least-bye players
      var byeCandidates=unassigned.slice().sort(function(a,b){
        return (seasonByes[a.id]||0)-(seasonByes[b.id]||0);
      });
      for(var bi=0;bi<byeCount;bi++){
        byes.push(byeCandidates[bi].id);
        seasonByes[byeCandidates[bi].id]=(seasonByes[byeCandidates[bi].id]||0)+1;
      }
      unassigned=unassigned.filter(function(p){ return byes.indexOf(p.id)<0; });
    }

    // Fill open slots with unassigned players
    var ui=0;
    for(var c2=0;c2<roundCourts.length;c2++){
      var ct=roundCourts[c2];
      for(var ti=0;ti<2;ti++){
        var target=ppCourt/2;
        while(ct.teams[ti].length<target && ui<unassigned.length){
          ct.teams[ti].push(unassigned[ui++].id);
        }
      }
      // Only include court if both teams have players
      if(ct.teams[0].length>0&&ct.teams[1].length>0){
        // no-op, already structured
      }
    }

    // Filter out empty courts
    var validCourts=roundCourts.filter(function(ct){
      return ct.teams[0].length>0&&ct.teams[1].length>0;
    });

    allRounds.push({courts:validCourts,byes:byes});
  }

  // Save bye counts
  for(var i=0;i<inP.length;i++){
    if(!S.byeCounts[inP[i].id]) S.byeCounts[inP[i].id]={};
    S.byeCounts[inP[i].id][S.currentSeason]=seasonByes[inP[i].id]||0;
  }

  sess.assignments={rounds:allRounds}; sess.scores={}; sess.posted=false;
  S.sessions[date]=sess; save(); showToast('Manual assignments generated!');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEAM BATTLE â€” ADMIN SETUP (assigns captains only)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openTeamBattleSetup(){
  var date=S.selectedDate; if(!date){ showToast('No date selected.'); return; }
  var sess=getSession(date);
  var inP=getInPlayers(date);
  if(inP.length<4){ showToast('Need at least 4 players marked IN.'); return; }

  var captainA=sess.captainA||null, captainB=sess.captainB||null;

  function playerOpts(selected){
    var o='<option value="">â€” none â€”</option>';
    for(var i=0;i<inP.length;i++){
      o+='<option value="'+inP[i].id+'"'+(inP[i].id==selected?' selected':'')+'>'+fmtId(inP[i].id)+' '+esc(inP[i].name)+'</option>';
    }
    return o;
  }

  var rosterStatusA=sess.teamA&&sess.teamA.length?'<span class="badge badge-in">âœ… Submitted ('+sess.teamA.length+' players)</span>':'<span style="background:#fff3cd;color:#856404;border-radius:12px;padding:2px 8px;font-size:.75rem;font-weight:700">Waiting...</span>';
  var rosterStatusB=sess.teamB&&sess.teamB.length?'<span class="badge badge-in">âœ… Submitted ('+sess.teamB.length+' players)</span>':'<span style="background:#fff3cd;color:#856404;border-radius:12px;padding:2px 8px;font-size:.75rem;font-weight:700">Waiting...</span>';

  var body='<h3>âš”ï¸ Team Battle â€” Assign Captains</h3>'
    +'<div class="alert alert-info" style="font-size:.82rem;margin-bottom:12px">Assign captains here. Captains will then select their players from the user view (Court Assignments tab â†’ Captain Login).</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">'
    +'<div style="border:2px solid #1e40af;border-radius:8px;padding:10px">'
    +'<div style="font-weight:700;color:#1e40af;margin-bottom:6px">ğŸ”µ Team A Captain</div>'
    +'<select id="cap-a-sel" style="width:100%;padding:6px;border-radius:6px;border:1.5px solid #1e40af">'+playerOpts(captainA)+'</select>'
    +'<div style="margin-top:8px;font-size:.8rem">Roster: '+rosterStatusA+'</div>'
    +'</div>'
    +'<div style="border:2px solid #991b1b;border-radius:8px;padding:10px">'
    +'<div style="font-weight:700;color:#991b1b;margin-bottom:6px">ğŸ”´ Team B Captain</div>'
    +'<select id="cap-b-sel" style="width:100%;padding:6px;border-radius:6px;border:1.5px solid #991b1b">'+playerOpts(captainB)+'</select>'
    +'<div style="margin-top:8px;font-size:.8rem">Roster: '+rosterStatusB+'</div>'
    +'</div>'
    +'</div>';

  // Show current rosters if submitted
  if(sess.teamA&&sess.teamA.length){
    body+='<div style="background:#dbeafe;border-radius:8px;padding:8px 12px;margin-bottom:8px">'
      +'<div style="font-size:.8rem;font-weight:700;color:#1e40af;margin-bottom:4px">ğŸ”µ Team A Roster</div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:4px">';
    sess.teamA.forEach(function(pid){ var p=getPlayer(pid); body+='<span style="background:#fff;border:1.5px solid #1e40af;border-radius:14px;padding:2px 8px;font-size:.8rem">'+esc(p?p.name:fmtId(pid))+'</span>'; });
    body+='</div></div>';
  }
  if(sess.teamB&&sess.teamB.length){
    body+='<div style="background:#fee2e2;border-radius:8px;padding:8px 12px;margin-bottom:8px">'
      +'<div style="font-size:.8rem;font-weight:700;color:#991b1b;margin-bottom:4px">ğŸ”´ Team B Roster</div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:4px">';
    sess.teamB.forEach(function(pid){ var p=getPlayer(pid); body+='<span style="background:#fff;border:1.5px solid #991b1b;border-radius:14px;padding:2px 8px;font-size:.8rem">'+esc(p?p.name:fmtId(pid))+'</span>'; });
    body+='</div></div>';
  }

  if(sess.teamA&&sess.teamA.length&&sess.teamB&&sess.teamB.length){
    body+='<div class="alert alert-info" style="margin-bottom:10px">Both rosters submitted! You can now Generate Court Assignment.</div>';
  }

  body+='<div class="modal-btns">'
    +'<button class="btn btn-secondary" id="m-cancel">Cancel</button>'
    +(sess.teamA&&sess.teamA.length?'<button class="btn btn-danger btn-sm" id="tb-reset-btn">Reset Rosters</button>':'')
    +'<button class="btn btn-primary" id="m-tb-save">ğŸ’¾ Save Captains</button>'
    +'</div>';

  showModal(body, true);
  byId('m-cancel').addEventListener('click',closeModal);
  var resetBtn=byId('tb-reset-btn');
  if(resetBtn) resetBtn.addEventListener('click',function(){
    sess.teamA=[]; sess.teamB=[];
    S.sessions[date]=sess; save(); closeModal();
    showToast('Rosters reset. Captains can re-submit.'); render();
  });
  byId('m-tb-save').addEventListener('click',function(){
    var newCapA=parseInt(byId('cap-a-sel').value)||null;
    var newCapB=parseInt(byId('cap-b-sel').value)||null;
    if(newCapA&&newCapA===newCapB){ showToast('Captain A and B must be different players.'); return; }
    sess.captainA=newCapA; sess.captainB=newCapB;
    // Reset teams if captains changed
    sess.teamA=[]; sess.teamB=[];
    S.sessions[date]=sess; save(); closeModal();
    showToast('Captains saved! They can now select their teams from the user view.');
    render();
  });
}

function generateTeamBattleAssignments(date, sess){
  var teamA=sess.teamA||[], teamB=sess.teamB||[];
  var ppCourt=sess.type==='singles'?2:4;
  var half=ppCourt/2;
  var courts=sess.courts||4;
  var mpp=sess.matchesPerPlayer||4;
  // Combine captain-specified pairs into lockedTeams
  var captainPairs=sess.captainPairs||{};
  var tbLockedTeams=[];
  (captainPairs.A||[]).forEach(function(pair){ if(pair&&pair.length>=2) tbLockedTeams.push(pair); });
  (captainPairs.B||[]).forEach(function(pair){ if(pair&&pair.length>=2) tbLockedTeams.push(pair); });

  // How many courts can run each round (limited by smaller team size and court count)
  var matchesPerRound=Math.min(Math.floor(teamA.length/half), Math.floor(teamB.length/half), courts);
  if(matchesPerRound<1) matchesPerRound=1;

  // Get player objects for each team (sorted by USTA for stable ordering)
  function getTeamPlayers(ids){
    return ids.map(function(id){ return getPlayer(id); }).filter(Boolean)
              .sort(function(a,b){ return parseFloat(b.usta)-parseFloat(a.usta); });
  }
  var aPlayers=getTeamPlayers(teamA);
  var bPlayers=getTeamPlayers(teamB);

  // Track how many matches each player has played
  var playCounts={};
  aPlayers.forEach(function(p){ playCounts[p.id]=0; });
  bPlayers.forEach(function(p){ playCounts[p.id]=0; });

  // Keep generating rounds until every player has reached mpp
  // (cap at 20 rounds to prevent infinite loop)
  var allRounds=[], maxRounds=20;

  while(allRounds.length<maxRounds){
    // Check if everyone has reached mpp â€” stop if so
    var allDone=true;
    for(var i=0;i<aPlayers.length;i++) if(playCounts[aPlayers[i].id]<mpp){ allDone=false; break; }
    if(allDone){
      for(var i=0;i<bPlayers.length;i++) if(playCounts[bPlayers[i].id]<mpp){ allDone=false; break; }
    }
    if(allDone) break;

    var roundCourts=[], usedA={}, usedB={};

    // For each court: pick A players with fewest plays, then B players with fewest plays.
    // This guarantees every court is strictly A vs B.
    for(var c=0;c<matchesPerRound;c++){
      // Pick `half` A-team players with lowest playCounts not yet used this round
      var aEligible=aPlayers.filter(function(p){ return !usedA[p.id]&&playCounts[p.id]<mpp; });
      aEligible.sort(function(a,b){
        var d=playCounts[a.id]-playCounts[b.id];
        return d!==0?d:parseFloat(b.usta)-parseFloat(a.usta);
      });
      var aTeam=[];
      for(var i=0;i<aEligible.length&&aTeam.length<half;i++){
        aTeam.push(aEligible[i].id); usedA[aEligible[i].id]=true;
      }

      // Pick `half` B-team players with lowest playCounts not yet used this round
      var bEligible=bPlayers.filter(function(p){ return !usedB[p.id]&&playCounts[p.id]<mpp; });
      bEligible.sort(function(a,b){
        var d=playCounts[a.id]-playCounts[b.id];
        return d!==0?d:parseFloat(b.usta)-parseFloat(a.usta);
      });
      var bTeam=[];
      for(var i=0;i<bEligible.length&&bTeam.length<half;i++){
        bTeam.push(bEligible[i].id); usedB[bEligible[i].id]=true;
      }

      // Only add court if both sides have enough players â€” always A vs B
      if(aTeam.length===half&&bTeam.length===half){
        roundCourts.push({teams:[aTeam,bTeam]});
        aTeam.forEach(function(id){ playCounts[id]++; });
        bTeam.forEach(function(id){ playCounts[id]++; });
      }
    }

    // If no courts were filled this round, all remaining players have hit mpp â€” done
    if(roundCourts.length===0) break;

    // Byes = players who haven't hit mpp but aren't playing this round
    var byes=[];
    aPlayers.forEach(function(p){ if(!usedA[p.id]&&playCounts[p.id]<mpp) byes.push(p.id); });
    bPlayers.forEach(function(p){ if(!usedB[p.id]&&playCounts[p.id]<mpp) byes.push(p.id); });

    allRounds.push({courts:roundCourts, byes:byes});
  }

  sess.assignments={rounds:allRounds, mode:'teamBattle'};
  sess.scores={};
  sess.posted=false;
  S.sessions[date]=sess;
  save();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEAM BATTLE â€” CAPTAIN VIEW (user-facing)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCaptainLogin(){
  var _capDts=(S.seasons[S.currentSeason]||[]).slice().sort();var _capTd=new Date();_capTd.setHours(0,0,0,0);var date=null;for(var _ci=0;_ci<_capDts.length;_ci++){var _cd=_capDts[_ci],_cds=S.sessions[_cd];if(_cds&&_cds.teamBattle){if(new Date(_cd+'T12:00:00')>=_capTd){date=_cd;break;}else date=_cd;}} if(!date){showToast('No Team Battle session found.');return;}
  var sess=getSession(date);
  if(!sess.teamBattle){ showToast('No Team Battle active for this session.'); return; }
  var capA=parseInt(sess.captainA)||null, capB=parseInt(sess.captainB)||null;
  var pOpts='<option value="">-- Select your name --</option>';
  for(var i=0;i<S.players.length;i++){
    var isCap=(S.players[i].id===capA||S.players[i].id===capB);
    if(isCap) pOpts+='<option value="'+S.players[i].id+'">'+fmtId(S.players[i].id)+' '+esc(S.players[i].name)+' ğŸ‘‘</option>';
  }
  showModal('<h3>ğŸ‘‘ Captain Login</h3>'
    +'<div class="alert alert-info" style="margin-bottom:10px">Only assigned captains can access this view.</div>'
    +'<label>Select Your Name</label>'
    +'<select id="cap-login-sel" style="padding:10px;width:100%">'+pOpts+'</select>'
    +'<div class="modal-btns">'
    +'<button class="btn btn-secondary" id="m-cancel">Cancel</button>'
    +'<button class="btn btn-primary" id="m-cap-confirm">Enter My Team</button>'
    +'</div>');
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-cap-confirm').addEventListener('click',function(){
    var pid=parseInt(byId('cap-login-sel').value);
    if(!pid){ showToast('Please select your name.'); return; }
    if(pid!==parseInt(sess.captainA)&&pid!==parseInt(sess.captainB)){ showToast('You are not listed as a captain.'); return; }
    S.captainPid=pid; saveLocalPrefs(); closeModal(); render();
  });
}

function captainTeamHTML(){
  // Find the team battle session (prefer upcoming, else most recent past)
  var _tbDates=(S.seasons[S.currentSeason]||[]).slice().sort();
  var _today=new Date(); _today.setHours(0,0,0,0);
  var date=null;
  for(var _tbi=0;_tbi<_tbDates.length;_tbi++){
    var _tbd=_tbDates[_tbi],_tbds=S.sessions[_tbd];
    if(_tbds&&_tbds.teamBattle){
      if(new Date(_tbd+'T12:00:00')>=_today){ date=_tbd; break; }
      else date=_tbd;
    }
  }
  if(!date) return '<div class="card"><div class="alert alert-info">No active session.</div></div>';
  var sess=getSession(date);
  if(!sess||!sess.teamBattle) return '<div class="card"><div class="alert alert-info">No Team Battle mode active.</div></div>';

  var teamA=sess.teamA||[], teamB=sess.teamB||[];
  var myPid=S.captainPid||null;
  var isCapA=myPid&&myPid==sess.captainA;
  var isCapB=myPid&&myPid==sess.captainB;
  var isCaptain=isCapA||isCapB;
  var myTeam=isCapA?teamA:teamB;
  var myColor=isCapA?'#1e40af':'#991b1b';
  var myLabel=isCapA?'ğŸ”µ Team A':'ğŸ”´ Team B';
  var mySubmitted=isCapA?(teamA.length>0):(teamB.length>0);

  function rosterCard(team, capId, label, borderColor, bgHighlight){
    var h='<div style="border:2px solid '+borderColor+';border-radius:10px;padding:12px;flex:1;min-width:140px">';
    h+='<div style="font-weight:700;color:'+borderColor+';font-size:.95rem;margin-bottom:6px">'+label+' ('+team.length+')</div>';
    if(capId){ var cp=getPlayer(capId); h+='<div style="font-size:.8rem;color:#555;margin-bottom:8px">ğŸ‘‘ '+esc(cp?cp.name:fmtId(capId))+'</div>'; }
    if(!team.length){
      h+='<div style="color:#aaa;font-size:.82rem">Roster not submitted yet.</div>';
    } else {
      h+='<div style="display:flex;flex-direction:column;gap:3px">';
      for(var i=0;i<team.length;i++){
        var mp=getPlayer(team[i]); var isCap2=(team[i]==capId);
        h+='<div style="background:'+bgHighlight+';border-radius:6px;padding:5px 10px;font-size:.88rem;font-weight:'+(isCap2?'700':'500')+'">'+(isCap2?'ğŸ‘‘ ':'')+esc(mp?mp.name:fmtId(team[i]))+'</div>';
      }
      h+='</div>';
    }
    h+='</div>';
    return h;
  }

  var h='<div class="card"><h2>âš”ï¸ Team Battle</h2>';

  // Captain roster-building UI â€” always shown when logged in (submitted or not)
  if(isCaptain){
    var inP=getInPlayers(date);
    var otherTeam=isCapA?teamB:teamA;
    var otherSet={};
    otherTeam.forEach(function(id){ otherSet[parseInt(id)]=true; });
    // Build status map: pid -> 'team_A' | 'team_B' | 'not_assigned'
    var teamASet={}, teamBSet={};
    teamA.forEach(function(id){ teamASet[parseInt(id)]=true; });
    teamB.forEach(function(id){ teamBSet[parseInt(id)]=true; });

    h+='<div style="background:'+myColor+';color:#fff;border-radius:8px;padding:10px 14px;margin-bottom:14px">';
    h+='<div style="font-weight:700;font-size:1rem">ğŸ‘‘ You are Captain of '+myLabel+'</div>';
    if(mySubmitted){
      h+='<div style="font-size:.82rem;opacity:.9;margin-top:2px">âœ… Roster submitted. You can edit and resubmit below.</div>';
    } else {
      h+='<div style="font-size:.82rem;opacity:.9;margin-top:2px">Select your team players below, then submit.</div>';
    }
    h+='</div>';

    // Player toggle grid â€” show all IN players with status
    var curSel=myTeam.slice().map(function(id){ return parseInt(id); });
    if(curSel.indexOf(parseInt(myPid))<0) curSel.push(parseInt(myPid));

    h+='<div style="margin-bottom:12px">';
    h+='<div style="font-weight:700;font-size:.85rem;margin-bottom:8px;color:'+myColor+'">Select Players for '+myLabel+':</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:6px" id="cap-roster-btns">';
    for(var i=0;i<inP.length;i++){
      var p=inP[i];
      var pid2=parseInt(p.id);
      var isMe=pid2===parseInt(myPid);
      var inOther=otherSet[pid2];
      var sel=curSel.indexOf(pid2)>=0;
      // Status label
      var statusLabel, statusColor;
      if(teamASet[pid2]){ statusLabel='Team A'; statusColor='#1e40af'; }
      else if(teamBSet[pid2]){ statusLabel='Team B'; statusColor='#991b1b'; }
      else { statusLabel='unassigned'; statusColor='#888'; }
      if(inOther){
        h+='<button type="button" disabled style="padding:5px 12px;border-radius:20px;border:2px solid #ccc;background:#f5f5f5;color:#bbb;font-size:.82rem;cursor:not-allowed;display:flex;flex-direction:column;align-items:center;gap:1px">';
        h+=fmtId(pid2)+' '+esc(p.name);
        h+='<span style="font-size:.68rem;color:'+statusColor+';font-weight:700">'+statusLabel+'</span>';
        h+='</button>';
      } else {
        h+='<button type="button" class="cap-roster-toggle" data-pid="'+pid2+'" '+(isMe?'disabled':'')+' style="padding:5px 12px;border-radius:20px;border:2px solid '+(sel?myColor:'#ccc')+';background:'+(sel?myColor:'#fff')+';color:'+(sel?'#fff':'#444')+';font-weight:'+(sel?'700':'400')+';font-size:.82rem;cursor:'+(isMe?'not-allowed':'pointer')+';display:flex;flex-direction:column;align-items:center;gap:1px">';
        h+=(isMe?'ğŸ‘‘ ':sel?'âœ“ ':'')+fmtId(pid2)+' '+esc(p.name);
        h+='<span style="font-size:.68rem;color:'+(sel?'rgba(255,255,255,.8)':statusColor)+';font-weight:700">'+statusLabel+'</span>';
        h+='</button>';
      }
    }
    h+='</div></div>';

    h+='<div style="margin-top:4px;font-size:.8rem;color:#888">Selected: <span id="cap-sel-count">'+curSel.length+'</span> players</div>';

    // Pair groupings â€” only show own-team players
    h+='<div style="margin-top:12px;border:1.5px solid #ddd;border-radius:8px;padding:10px">';
    h+='<div style="font-weight:700;font-size:.85rem;margin-bottom:6px;color:'+myColor+'">ğŸ”’ Optional: Pair Groupings</div>';
    h+='<div style="font-size:.78rem;color:#666;margin-bottom:8px">Specify partners from your team. Leave blank to auto-pair.</div>';
    var existPairs=isCapA?(sess.captainPairs&&sess.captainPairs.A||[]):(sess.captainPairs&&sess.captainPairs.B||[]);
    // Only own-team players in pair dropdowns
    var pairOpts2='<option value="">â€” none â€”</option>';
    for(var pi2=0;pi2<inP.length;pi2++){
      var pp2=inP[pi2], pid3=parseInt(pp2.id);
      if(isCapA&&teamASet[pid3]) pairOpts2+='<option value="'+pid3+'">'+fmtId(pid3)+' '+esc(pp2.name)+'</option>';
      else if(!isCapA&&teamBSet[pid3]) pairOpts2+='<option value="'+pid3+'">'+fmtId(pid3)+' '+esc(pp2.name)+'</option>';
    }
    // If no team submitted yet, show all unassigned players as options
    if(pairOpts2==='<option value="">â€” none â€”</option>'){
      for(var pi2=0;pi2<inP.length;pi2++){
        var pp2=inP[pi2], pid3=parseInt(pp2.id);
        if(!otherSet[pid3]) pairOpts2+='<option value="'+pid3+'">'+fmtId(pid3)+' '+esc(pp2.name)+'</option>';
      }
    }
    var numPairSlots=Math.max(2, existPairs.length+1);
    h+='<div id="cap-pairs-list">';
    for(var psi=0;psi<numPairSlots;psi++){
      var ep=existPairs[psi]||[null,null];
      var ep0=ep[0]?String(ep[0]):'', ep1=ep[1]?String(ep[1]):'';
      h+='<div style="display:flex;gap:6px;margin-bottom:6px;align-items:center">';
      h+='<span style="font-size:.78rem;color:#888;min-width:16px">'+(psi+1)+'.</span>';
      h+='<select class="cap-pair-sel" style="flex:1;padding:5px;border-radius:6px;border:1.5px solid #ccc;font-size:.8rem">'+pairOpts2.replace('value="'+ep0+'"','value="'+ep0+'" selected')+'</select>';
      h+='<span style="font-size:.78rem;color:#888">+</span>';
      h+='<select class="cap-pair-sel" style="flex:1;padding:5px;border-radius:6px;border:1.5px solid #ccc;font-size:.8rem">'+pairOpts2.replace('value="'+ep1+'"','value="'+ep1+'" selected')+'</select>';
      h+='</div>';
    }
    h+='</div>';
    h+='<button class="btn btn-secondary btn-sm" id="cap-add-pair-btn" style="margin-top:4px">+ Add Pair</button>';
    h+='</div>';
    h+='<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">';
    h+='<button class="btn btn-secondary" id="cap-cancel-btn">â† Back</button>';
    if(mySubmitted){
      h+='<button class="btn btn-danger btn-sm" id="cap-unsubmit-btn" style="flex:0">Unsubmit Roster</button>';
    }
    h+='<button class="btn btn-green" id="cap-submit-roster-btn" style="flex:1">'+(mySubmitted?'Resubmit':'Submit')+' '+myLabel+' Roster âœ“</button>';
    h+='</div>';

  } else {
    // Read-only roster display (non-captain)
    h+='<div style="background:#fff3cd;border:1.5px solid #e6ac00;border-radius:8px;padding:8px 12px;margin-bottom:12px;font-size:.85rem">';
    h+='<button class="btn btn-secondary btn-sm" id="captain-login-btn" style="margin-right:8px">ğŸ‘‘ Captain Login</button>';
    h+='<span style="color:#856404">Are you a captain? Log in to select your team.</span>';
    h+='</div>';
    h+='<div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">';
    h+=rosterCard(teamA, sess.captainA, 'ğŸ”µ Team A', '#1e40af', '#dbeafe');
    h+=rosterCard(teamB, sess.captainB, 'ğŸ”´ Team B', '#991b1b', '#fee2e2');
    h+='</div>';
    h+=teamBattleWinnerHTML(sess);
  }

  // Match display (when assignments exist)
  if(!isCaptain && sess.assignments&&sess.assignments.rounds){
    h+='<div style="font-weight:700;margin-bottom:8px;border-top:1px solid #eee;padding-top:12px">ğŸ“‹ Today\'s Matches</div>';
    var rounds=sess.assignments.rounds;
    for(var ri=0;ri<rounds.length;ri++){
      var round=rounds[ri]; if(!round||!round.courts) continue;
      h+='<div style="font-size:.85rem;font-weight:600;color:#555;margin-top:10px">Round '+(ri+1)+'</div>';
      for(var ci2=0;ci2<round.courts.length;ci2++){
        var court=round.courts[ci2];
        var sc=sess.scores?sess.scores[ri+'_'+ci2]:null;
        h+='<div style="border:1.5px solid #ddd;border-radius:8px;overflow:hidden;margin-top:4px">';
        h+='<div style="font-size:.78rem;color:#888;padding:4px 10px;background:#fafafa;border-bottom:1px solid #eee">Court '+(ci2+1)+'</div>';
        for(var ti=0;ti<court.teams.length;ti++){
          var teamPids=court.teams[ti];
          var isA=teamPids.some(function(pid3){ return teamA.some(function(id){ return id==pid3; }); });
          var bgColor=isA?'#dbeafe':'#fee2e2';
          var labelColor=isA?'#1e40af':'#991b1b';
          var tScore=sc?(ti===0?sc.t1:sc.t2):null;
          h+='<div style="background:'+bgColor+';padding:5px 10px;display:flex;justify-content:space-between;align-items:center">';
          h+='<div><span style="font-size:.78rem;font-weight:700;color:'+labelColor+'">'+(isA?'ğŸ”µ A':'ğŸ”´ B')+'</span> ';
          for(var pi=0;pi<teamPids.length;pi++){
            var pp=getPlayer(teamPids[pi]);
            h+='<span style="font-size:.85rem">'+esc(pp?pp.name:fmtId(teamPids[pi]))+(pi<teamPids.length-1?' & ':'')+'</span>';
          }
          h+='</div>';
          if(tScore!==null&&tScore!=='') h+='<strong style="font-size:.9rem">'+esc(tScore)+'</strong>';
          h+='</div>';
          if(ti===0&&court.teams.length>1) h+='<div style="text-align:center;font-size:.72rem;color:#aaa;padding:1px 0;background:#f9f9f9;border-top:1px solid #eee;border-bottom:1px solid #eee">vs</div>';
        }
        h+='</div>';
      }
      if(Array.isArray(round.byes)&&round.byes.length){
        h+='<div style="font-size:.82rem;color:#856404;margin-top:6px;padding:4px 0">â¸ Sitting out: ';
        for(var bi=0;bi<round.byes.length;bi++){ var bp=getPlayer(round.byes[bi]); h+='<span class="player-chip bye-chip">'+esc(bp?bp.name:fmtId(round.byes[bi]))+'</span>'; }
        h+='</div>';
      }
    }
  } else if(!isCaptain) {
    h+='<div class="alert alert-info" style="margin-top:8px">Court assignments will appear here once generated by admin.</div>';
  }

  h+='</div>';
  return h;
}


// â”€â”€ PLAYERS CHOICE LIVE COURT GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playersChoiceCourtGrid(sess, date, isAdmin){
  var pcData=sess.pcSubmissions||{};
  var courts=sess.courts||4;
  var mpp=sess.matchesPerPlayer||4;
  var ppCourt=sess.type==='singles'?2:4;
  var generatedRounds=sess.assignments&&sess.assignments.rounds?sess.assignments.rounds:[];
  var scores=sess.scores||{};

  var h='<div class="card"><h2>ğŸ¾ Court Assignments &amp; Scores â€” Players Choice</h2>';

  for(var r=0;r<mpp;r++){
    h+='<div class="round-block"><div class="round-title">Round '+(r+1)+'</div><div class="courts-row">';
    var anyP=false;

    if(r<generatedRounds.length){
      // Generated round â€” show actual assignments with scores
      var rnd=generatedRounds[r];
      var rndCourts=rnd&&rnd.courts?rnd.courts:[];
      for(var ci=0;ci<rndCourts.length;ci++){
        var court=rndCourts[ci];
        if(!court||!court.teams||court.teams.length<2) continue;
        anyP=true;
        var scKey=r+'_'+ci;
        var sc=scores[scKey]||null;
        var t0=court.teams[0]||[], t1=court.teams[1]||[];
        var s0=sc&&sc.t1!==''?sc.t1:null;
        var s1v=sc&&sc.t2!==''?sc.t2:null;
        var t0w=s0!==null&&s1v!==null&&parseInt(s0)>parseInt(s1v);
        var t1w=s0!==null&&s1v!==null&&parseInt(s1v)>parseInt(s0);
        h+='<div class="court-card"><div class="court-header">Court '+(ci+1)+'</div><div class="court-body">';
        var teams=[[t0,s0,t0w],[t1,s1v,t1w]];
        for(var ti=0;ti<2;ti++){
          var tPids=teams[ti][0], tScore=teams[ti][1], isWin=teams[ti][2];
          h+='<div class="team"><div class="team-row"><div class="team-label">Team '+(ti+1)+'</div>';
          h+='<span class="team-score'+(sc?(isWin?' winner':''):' empty')+'">'+(tScore!==null?tScore:'â€”')+'</span>';
          h+='</div><div style="margin-top:4px">';
          for(var pi=0;pi<tPids.length;pi++){
            var pp=getPlayer(tPids[pi]);
            h+='<span class="player-chip">'+esc(pp?pp.name:fmtId(tPids[pi]))+'</span>';
          }
          h+='</div></div>';
          if(ti===0) h+='<div class="vs">VS</div>';
        }
        if(isAdmin) h+='<div class="score-row"><button class="btn btn-secondary btn-sm" data-score-btn data-date="'+esc(date)+'" data-round="'+r+'" data-court="'+ci+'">'+((sc&&sc.t1!=='')?'âœï¸ Edit Score':'+ Score')+'</button></div>';
        h+='</div></div>';
      }
      if(!anyP) h+='<div style="color:#aaa;font-size:.85rem;padding:8px">No courts assigned.</div>';
    } else {
      // Not yet generated â€” live preference preview
      var prefGrid={};
      for(var c=1;c<=courts;c++) prefGrid[c]={team1:[],team2:[]};
      var pids=Object.keys(pcData);
      for(var i=0;i<pids.length;i++){
        var pid=parseInt(pids[i]);
        var prefs=pcData[pids[i]];
        if(!prefs||!prefs[r]) continue;
        var pref=prefs[r];
        var ct=pref.court||1;
        if(ct<1||ct>courts) continue;
        var grid=prefGrid[ct];
        var partner=pref.partner;
        if(ppCourt===4&&partner){
          var alreadyPlaced=false;
          for(var c2=1;c2<=courts;c2++){
            if(prefGrid[c2].team1.indexOf(partner)>=0||prefGrid[c2].team2.indexOf(partner)>=0){ alreadyPlaced=true; break; }
          }
          if(!alreadyPlaced&&grid.team1.indexOf(pid)<0&&grid.team2.indexOf(pid)<0){
            if(grid.team1.length<ppCourt/2){ grid.team1.push(pid); grid.team1.push(partner); continue; }
            else if(grid.team2.length<ppCourt/2){ grid.team2.push(pid); grid.team2.push(partner); continue; }
          }
        }
        if(grid.team1.indexOf(pid)<0&&grid.team2.indexOf(pid)<0){
          if(grid.team1.length<ppCourt/2) grid.team1.push(pid);
          else if(grid.team2.length<ppCourt/2) grid.team2.push(pid);
          else grid.team1.push(pid);
        }
      }
      for(var c=1;c<=courts;c++){
        var grid=prefGrid[c];
        if(!grid.team1.length&&!grid.team2.length) continue;
        anyP=true;
        h+='<div class="court-card"><div class="court-header">Court '+c+' <span style="font-size:.7rem;color:#888">(preferences)</span></div><div class="court-body">';
        for(var ti=0;ti<2;ti++){
          var tPids=ti===0?grid.team1:grid.team2;
          h+='<div class="team"><div class="team-row"><div class="team-label">Team '+(ti+1)+'</div><span class="team-score empty">â€”</span></div><div style="margin-top:4px">';
          for(var pi=0;pi<tPids.length;pi++){
            var pp=getPlayer(tPids[pi]);
            h+='<span class="player-chip">'+esc(pp?pp.name:fmtId(tPids[pi]))+'</span>';
          }
          if(!tPids.length) h+='<span style="color:#aaa;font-size:.8rem">waiting...</span>';
          h+='</div></div>';
          if(ti===0) h+='<div class="vs">VS</div>';
        }
        h+='</div></div>';
      }
      if(!anyP) h+='<div style="color:#aaa;font-size:.85rem;padding:8px">Waiting for player preferences...</div>';
    }
    h+='</div></div>';
  }

  var pids=Object.keys(pcData);
  if(pids.length){
    h+='<div style="margin-top:8px"><span style="font-size:.82rem;font-weight:700;color:#1a5c2a">âœ… '+pids.length+' submitted: </span>';
    for(var i=0;i<pids.length;i++){
      var spp=getPlayer(parseInt(pids[i]));
      h+='<span style="background:#d4edda;color:#155724;border-radius:14px;padding:2px 9px;font-size:.8rem;margin:2px;display:inline-block">'+esc(spp?spp.name:pids[i])+'</span>';
    }
    h+='</div>';
  }
  h+='</div>';
  return h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYERS CHOICE â€” USER VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function playersChoiceUserHTML(){
  // (date found below via playersChoice scan)
  // Find the players choice session (prefer upcoming, else most recent past)
  var _pcDates=(S.seasons[S.currentSeason]||[]).slice().sort();
  var _pcToday=new Date(); _pcToday.setHours(0,0,0,0);
  var date=null;
  for(var _pci=0;_pci<_pcDates.length;_pci++){
    var _pcd=_pcDates[_pci],_pcds=S.sessions[_pcd];
    if(_pcds&&_pcds.playersChoice){
      if(new Date(_pcd+'T12:00:00')>=_pcToday){ date=_pcd; break; }
      else date=_pcd;
    }
  }
  if(!date) return '<div class="card"><div class="alert alert-info">No Players Choice session found.</div></div>';
  var sess=getSession(date);
  if(!sess||!sess.playersChoice) return '<div class="card"><div class="alert alert-info">Players Choice mode is not active.</div></div>';
  var inP=getInPlayers(date);
  if(!inP.length) return '<div class="card"><div class="alert alert-info">No players marked IN yet.</div></div>';

  var ppCourt=sess.type==='singles'?2:4;
  var mpp=sess.matchesPerPlayer||4;
  var courts=sess.courts||4;
  var pcData=sess.pcSubmissions||{};

  // Determine current active round (first round without assignments or 0 if round 1 not done)
  var rounds=sess.assignments&&sess.assignments.rounds?sess.assignments.rounds:[];
  var currentRoundIdx=rounds.length; // 0-based index of next round to submit

  var pOpts='<option value="">â€” unassigned â€”</option>';
  for(var i=0;i<inP.length;i++) pOpts+='<option value="'+inP[i].id+'">'+fmtId(inP[i].id)+' '+esc(inP[i].name)+'</option>';
  var courtOpts='';
  for(var c=1;c<=courts;c++) courtOpts+='<option value="'+c+'">Court '+c+'</option>';

  var h='<div class="card"><h2>ğŸ¾ Players Choice</h2>';

  // Round 1: always auto-assigned by admin
  h+='<div style="background:#e8f5e9;border:1.5px solid #1a5c2a;border-radius:8px;padding:10px 12px;margin-bottom:12px">';
  h+='<div style="font-weight:700;color:#1a5c2a;margin-bottom:3px">Round 1 â€” Auto-Assigned</div>';
  h+='<div style="font-size:.83rem;color:#2e7d32">Round 1 is automatically generated with varied partners. Check Court Assignments for your Round 1 match.</div>';
  h+='</div>';

  // Submission form: only show for rounds beyond what admin has already generated
  // Users submit court+partner for the NEXT round
  var nextRound=currentRoundIdx+1; // 1-based
  var submittedPids=Object.keys(pcData);

  if(nextRound<=mpp&&nextRound>1){
    h+='<div style="background:#fff3cd;border:1.5px solid #e6ac00;border-radius:8px;padding:10px 12px;margin-bottom:12px">';
    h+='<div style="font-weight:700;color:#856404;margin-bottom:3px">â³ Round '+nextRound+' â€” Submit Your Court Request</div>';
    h+='<div style="font-size:.82rem;color:#856404">Submit your partner and court preference for Round '+nextRound+'. Admin will generate the court assignment once all players submit.</div>';
    h+='</div>';
    // Show who submitted for this round
    var submittedForNext=submittedPids.filter(function(pid){ var pr=pcData[pid]; return pr&&pr[currentRoundIdx]&&!pr[currentRoundIdx].auto; });
    h+='<div id="pc-submitted-wrap" style="margin-bottom:10px">';
    h+='<div style="font-size:.82rem;font-weight:700;color:#1a5c2a;margin-bottom:4px">Submitted for Round '+nextRound+': '+submittedForNext.length+'/'+inP.length+'</div>';
    if(submittedForNext.length){
      h+='<div style="display:flex;flex-wrap:wrap;gap:4px">';
      submittedForNext.forEach(function(pid){ var sp=getPlayer(parseInt(pid)); h+='<span style="background:#d4edda;color:#155724;border-radius:14px;padding:2px 8px;font-size:.78rem">'+esc(sp?sp.name:pid)+'</span>'; });
      h+='</div>';
    }
    h+='</div>';
    h+='<div style="border:1.5px solid #e8f5e9;border-radius:8px;padding:12px;margin-bottom:12px">';
    h+='<label>Your Name</label>';
    h+='<select id="pc-self-sel" style="width:100%;padding:8px;margin-bottom:10px">'+pOpts+'</select>';
    h+='<div style="border:1px solid #eee;border-radius:8px;padding:8px">';
    h+='<div style="font-size:.85rem;font-weight:700;color:#1a5c2a;margin-bottom:6px">Round '+nextRound+'</div>';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
    if(ppCourt===4){
      h+='<div><label style="font-size:.78rem">Partner</label>';
      h+='<select id="pc-partner-next" style="width:100%;padding:6px">'+pOpts+'</select></div>';
    }
    h+='<div><label style="font-size:.78rem">Court</label>';
    h+='<select id="pc-court-next" style="width:100%;padding:6px">'+courtOpts+'</select></div>';
    h+='</div></div>';
    h+='<button class="btn btn-primary" id="pc-submit-btn" style="width:100%;margin-top:8px" data-pc-round="'+currentRoundIdx+'">Submit Round '+nextRound+' Request</button>';
    h+='</div>';
  } else if(nextRound>mpp){
    h+='<div class="alert alert-info">All rounds complete! Check Court Assignments for results.</div>';
  } else if(nextRound===1){
    h+='<div class="alert alert-info">Waiting for admin to generate Round 1 assignments...</div>';
  }

  h+='<div id="pc-user-grid" style="margin-top:12px">'+playersChoiceCourtGrid(sess,date,false)+'</div>';
  h+='</div>';
  return h;
}

function submitPlayersChoice(){
  // Find the players choice session
  var _spDts=(S.seasons[S.currentSeason]||[]).slice().sort();var _spTd=new Date();_spTd.setHours(0,0,0,0);var date=null;for(var _spi=0;_spi<_spDts.length;_spi++){var _spd=_spDts[_spi],_spds=S.sessions[_spd];if(_spds&&_spds.playersChoice){if(new Date(_spd+'T12:00:00')>=_spTd){date=_spd;break;}else date=_spd;}} if(!date) return;
  var sess=getSession(date);
  var selfSel=byId('pc-self-sel'); if(!selfSel) return;
  var selfPid=parseInt(selfSel.value);
  if(!selfPid){ showToast('Please select your name.'); return; }
  var mpp=sess.matchesPerPlayer||4;
  var ppCourt=sess.type==='singles'?2:4;
  // Determine which round index this submission is for
  var submitBtn=byId('pc-submit-btn');
  var roundIdx=submitBtn?parseInt(submitBtn.dataset.pcRound||'1'):1;
  if(isNaN(roundIdx)||roundIdx<1) roundIdx=1;
  if(!sess.pcSubmissions) sess.pcSubmissions={};
  var prefs=sess.pcSubmissions[selfPid]||[];
  // Ensure array is padded up to roundIdx
  while(prefs.length<=roundIdx) prefs.push({auto:true,partner:null,court:1});
  var partnerEl=byId('pc-partner-next');
  var courtEl=byId('pc-court-next');
  prefs[roundIdx]={
    partner: partnerEl?parseInt(partnerEl.value)||null:null,
    court: courtEl?parseInt(courtEl.value)||1:1
  };
  sess.pcSubmissions[selfPid]=prefs;
  S.sessions[date]=sess; save();
  showToast('Submitted! Waiting for all players to confirm Round '+(roundIdx+1)+'.');
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYERS CHOICE â€” ADMIN VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPlayersChoiceAdmin(){
  var date=S.selectedDate; if(!date){ showToast('No date selected.'); return; }
  var sess=getSession(date);
  var pcData=sess.pcSubmissions||{};
  var inP=getInPlayers(date);
  var mpp=sess.matchesPerPlayer||4;
  var ppCourt=sess.type==='singles'?2:4;
  var pids=Object.keys(pcData);

  if(!pids.length){
    showModal('<h3>ğŸ“‹ Players Choice Submissions</h3><div class="alert alert-info">No submissions yet.</div><div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Close</button></div>');
    byId('m-cancel').addEventListener('click',closeModal);
    return;
  }

  var body='<h3>ğŸ“‹ Players Choice Submissions</h3>';
  body+='<div style="overflow-y:auto;max-height:55vh">';
  for(var i=0;i<pids.length;i++){
    var pid=parseInt(pids[i]), pp=getPlayer(pid);
    var prefs=pcData[pids[i]];
    body+='<div style="border:1.5px solid #e8f5e9;border-radius:8px;padding:8px;margin-bottom:8px">';
    body+='<div style="font-weight:700;color:#1a5c2a;margin-bottom:4px">'+esc(pp?pp.name:fmtId(pid))+'</div>';
    for(var r=0;r<prefs.length;r++){
      var pr=prefs[r];
      var partnerP=pr.partner?getPlayer(pr.partner):null;
      body+='<div style="font-size:.82rem;padding:2px 0">Match '+(r+1)+': ';
      if(ppCourt===4) body+='Partner: <strong>'+esc(partnerP?partnerP.name:(pr.partner?fmtId(pr.partner):'Any'))+'</strong> Â· ';
      body+='Court <strong>'+pr.court+'</strong></div>';
    }
    body+='</div>';
  }
  body+='</div>';
  body+='<div class="modal-btns">';
  body+='<button class="btn btn-secondary" id="m-cancel">Close</button>';
  body+='<button class="btn btn-primary" id="m-pc-gen">Generate from Preferences</button>';
  body+='</div>';

  showModal(body);
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-pc-gen').addEventListener('click',function(){
    generatePlayersChoiceAssignments(date, sess, pcData);
    closeModal();
    var existingRounds=sess.assignments&&sess.assignments.rounds?sess.assignments.rounds.length:0;
    showToast('Round '+(existingRounds)+' generated!');
    render();
  });
}

function generatePlayersChoiceAssignments(date, sess, pcData){
  var inP=getInPlayers(date);
  var ppCourt=sess.type==='singles'?2:4;
  var mpp=sess.matchesPerPlayer||4;
  var courts=sess.courts||4;

  // Incremental: if round 1 exists, append next round from preferences
  var existingRounds=sess.assignments&&sess.assignments.rounds?sess.assignments.rounds:[];
  var startRound=existingRounds.length;

  var allRounds=existingRounds.slice();

  // ROUND 1: Auto-assign with different partners (same algo as rotatePartners=true)
  if(startRound===0){
    (function generateRound1(){
      var lockedTeams=sess.lockedTeams||[];
      var noByePids=sess.noByePids||[];
      var seasonByes={};
      for(var i=0;i<inP.length;i++) seasonByes[inP[i].id]=((S.byeCounts[inP[i].id]||{})[S.currentSeason]||0);
      var shuffled=inP.slice().sort(function(a,b){ return parseFloat(b.usta)-parseFloat(a.usta); });
      var playPerRound=Math.min(inP.length, courts*ppCourt);
      var activeCourts=Math.floor(playPerRound/ppCourt);
      var byes=[];
      if(shuffled.length>activeCourts*ppCourt){
        var byeCount=shuffled.length-activeCourts*ppCourt;
        var byeCands=shuffled.slice().sort(function(a,b){ return (seasonByes[a.id]||0)-(seasonByes[b.id]||0); });
        for(var bi=0;bi<byeCount;bi++){
          if(noByePids.indexOf(byeCands[bi].id)<0){ byes.push(byeCands[bi].id); }
        }
      }
      var playing=shuffled.filter(function(p){ return byes.indexOf(p.id)<0; });
      var roundCourts=[];
      for(var c=0;c<activeCourts&&playing.length>=ppCourt;c++){
        var team1=playing.splice(0,ppCourt/2).map(function(p){ return p.id; });
        var team2=playing.splice(0,ppCourt/2).map(function(p){ return p.id; });
        if(team1.length>0&&team2.length>0) roundCourts.push({teams:[team1,team2]});
      }
      allRounds.push({courts:roundCourts, byes:byes});
    })();
  }

  // ROUNDS 2+: Build ONLY the next single round from player preferences
  // (Admin must press Generate again after players submit for each subsequent round)
  var r=startRound; // generate exactly one round: the current startRound
  if(r>=1&&r<mpp){
    var placed={};
    var roundCourts2=[];
    var requests=[];
    var pids=Object.keys(pcData);
    for(var i=0;i<pids.length;i++){
      var pid=parseInt(pids[i]);
      var prefs=pcData[pids[i]];
      // prefs[0]=round1 placeholder, prefs[r]=round r+1
      if(prefs&&prefs[r]&&!prefs[r].auto){
        requests.push({pid:pid, partner:prefs[r].partner, court:prefs[r].court});
      }
    }
    var byCourt={};
    for(var i=0;i<requests.length;i++){
      var ct=requests[i].court;
      if(!byCourt[ct]) byCourt[ct]=[];
      byCourt[ct].push(requests[i]);
    }
    var ctKeys=Object.keys(byCourt).sort();
    for(var ci=0;ci<ctKeys.length&&ci<courts;ci++){
      var ctReqs=byCourt[ctKeys[ci]];
      if(ctReqs.length<2) continue;
      var team1=[], team2=[];
      var half=ppCourt/2;
      var used={};
      for(var i=0;i<ctReqs.length;i++){
        if(used[ctReqs[i].pid]) continue;
        var partner=ctReqs[i].partner;
        if(ppCourt===4&&partner&&!used[partner]){
          if(team1.length<half){ team1.push(ctReqs[i].pid); team1.push(partner); used[ctReqs[i].pid]=true; used[partner]=true; }
          else if(team2.length<half){ team2.push(ctReqs[i].pid); team2.push(partner); used[ctReqs[i].pid]=true; used[partner]=true; }
        } else {
          if(team1.length<half){ team1.push(ctReqs[i].pid); used[ctReqs[i].pid]=true; }
          else if(team2.length<half){ team2.push(ctReqs[i].pid); used[ctReqs[i].pid]=true; }
        }
      }
      if(team1.length>0&&team2.length>0) roundCourts2.push({teams:[team1,team2]});
    }
    var allPlaced={};
    for(var ci=0;ci<roundCourts2.length;ci++){
      for(var ti=0;ti<roundCourts2[ci].teams.length;ti++){
        for(var pi=0;pi<roundCourts2[ci].teams[ti].length;pi++) allPlaced[roundCourts2[ci].teams[ti][pi]]=true;
      }
    }
    var byes2=[];
    for(var i=0;i<inP.length;i++) if(!allPlaced[inP[i].id]) byes2.push(inP[i].id);
    allRounds.push({courts:roundCourts2, byes:byes2});
  }

  sess.assignments={rounds:allRounds, mode:'playersChoice'};
  // Preserve existing scores when adding new rounds
  if(!sess.scores) sess.scores={};
  if(startRound===0) sess.scores={};
  sess.posted=false;
  S.sessions[date]=sess;
  save();
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
byId('admin-btn').addEventListener('click',function(){
  if(S.isAdmin){ S.isAdmin=false; saveLocalPrefs(); render(); return; }
  showModal('<h3>ğŸ” Admin Login</h3>'
    +'<label>Password</label><input type="password" id="m-pass" placeholder="Enter password">'
    +'<div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Cancel</button><button class="btn btn-primary" id="m-login">Login</button></div>');
  setTimeout(function(){ var p=byId('m-pass'); if(p) p.focus(); },100);
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-login').addEventListener('click',function(){
    var p=byId('m-pass');
    if(p&&p.value===PASS){ S.isAdmin=true; saveLocalPrefs(); closeModal(); render(); }
    else showToast('Incorrect password.');
  });
});
</script>
</body>
</html>