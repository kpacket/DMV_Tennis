<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>DMV Tennis</title>

<!-- â•â• PWA META TAGS â•â• -->
<meta name="application-name" content="DMV Tennis">
<meta name="description" content="DMV Tennis League â€“ RSVP, court assignments, and scores">
<meta name="theme-color" content="#1a5c2a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DMV Tennis">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='32' fill='%231a5c2a'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle'%3EğŸ¾%3C/text%3E%3C/svg%3E">

<!-- PWA Manifest -->
<script>
(function(){
  var manifest = {
    name:"DMV Tennis",short_name:"DMV Tennis",
    description:"DMV Tennis League â€“ RSVP, court assignments, and scores",
    start_url:"./",display:"standalone",
    background_color:"#f0f4f0",theme_color:"#1a5c2a",
    orientation:"portrait-primary",
    icons:[
      {src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='32' fill='%231a5c2a'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle'%3EğŸ¾%3C/text%3E%3C/svg%3E",sizes:"192x192",type:"image/svg+xml",purpose:"any maskable"},
      {src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='80' fill='%231a5c2a'/%3E%3Ctext x='256' y='350' font-size='280' text-anchor='middle'%3EğŸ¾%3C/text%3E%3C/svg%3E",sizes:"512x512",type:"image/svg+xml",purpose:"any maskable"}
    ]
  };
  var blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
  var link=document.createElement('link');
  link.rel='manifest'; link.href=URL.createObjectURL(blob);
  document.head.appendChild(link);
})();
</script>

<!-- Firebase SDK (ESM module - no external script blocking issues) -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';
window._fbInit = function(config) {
  const app = initializeApp(config);
  const db = getDatabase(app);
  window._fbDb = db;
  window._fbRef = ref;
  window._fbSet = set;
  window._fbOnValue = onValue;
  window.dispatchEvent(new Event('firebase-ready'));
};
window._fbInit({
  apiKey: "AIzaSyDh2HPkMnsUqf0jJ1gq3BbpsOW6IGagdvQ",
  authDomain: "dmv-tennis.firebaseapp.com",
  databaseURL: "https://dmv-tennis-default-rtdb.firebaseio.com",
  projectId: "dmv-tennis",
  storageBucket: "dmv-tennis.firebasestorage.app",
  messagingSenderId: "44825593054",
  appId: "1:44825593054:web:460f3bfc71c91d9ecf6e4f"
});
</script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:#f0f4f0;color:#222;min-height:100vh}
body{padding-bottom:env(safe-area-inset-bottom)}
header{background:#1a5c2a;color:#fff;padding:14px 20px;padding-top:max(14px,env(safe-area-inset-top));padding-left:max(20px,env(safe-area-inset-left));padding-right:max(20px,env(safe-area-inset-right));display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
header h1{font-size:1.2rem}
.btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:.9rem;font-weight:600;transition:opacity .2s;display:inline-block;-webkit-tap-highlight-color:transparent}
.btn-primary{background:#f5a623;color:#222}
.btn-green{background:#1a5c2a;color:#fff}
.btn-secondary{background:#fff;color:#1a5c2a;border:2px solid #1a5c2a}
.btn-danger{background:#c0392b;color:#fff}
.btn-sm{padding:5px 10px;font-size:.8rem}
.btn:active{opacity:.7}
#app{max-width:1000px;margin:0 auto;padding:16px}
.card{background:#fff;border-radius:10px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.card h2{color:#1a5c2a;margin-bottom:12px;font-size:1.1rem;border-bottom:2px solid #e8f5e9;padding-bottom:8px}
.tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.tab{padding:9px 18px;border-radius:20px;cursor:pointer;font-weight:600;font-size:.9rem;border:2px solid #1a5c2a;color:#1a5c2a;background:#fff;-webkit-tap-highlight-color:transparent}
.tab.active{background:#1a5c2a;color:#fff}
input,select,textarea{width:100%;padding:10px;border:1.5px solid #ccc;border-radius:6px;font-size:1rem;margin-bottom:8px;-webkit-appearance:none;appearance:none}
input:focus,select:focus,textarea:focus{outline:none;border-color:#1a5c2a}
label{font-size:.85rem;font-weight:600;color:#444;display:block;margin-bottom:4px}
.form-row{display:flex;gap:8px;flex-wrap:wrap}
.form-row>div{flex:1;min-width:140px}
table{width:100%;border-collapse:collapse;font-size:.88rem}
th{background:#1a5c2a;color:#fff;padding:8px;text-align:left}
td{padding:8px;border-bottom:1px solid #eee;vertical-align:middle}
.sticky-table-wrap{overflow-y:auto;max-height:60vh;border-radius:8px;border:1px solid #ddd}
.sticky-table-wrap table{border-collapse:separate;border-spacing:0}
.sticky-table-wrap th{position:sticky;top:0;z-index:2;box-shadow:0 2px 4px rgba(0,0,0,.12)}
.pts-badge{background:#1a5c2a;color:#fff;border-radius:14px;padding:3px 10px;font-size:.82rem;font-weight:700}
.team-a-chip{background:#dbeafe;color:#1e40af;border-radius:14px;padding:3px 10px;font-size:.82rem;font-weight:600;display:inline-block;margin:2px}
.team-b-chip{background:#fee2e2;color:#991b1b;border-radius:14px;padding:3px 10px;font-size:.82rem;font-weight:600;display:inline-block;margin:2px}
.captain-crown{font-size:.8rem;margin-right:2px}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:.75rem;font-weight:700}
.badge-in{background:#d4edda;color:#155724}
.badge-out{background:#f8d7da;color:#721c24}
.round-block{margin-bottom:20px}
.round-title{font-weight:700;color:#1a5c2a;font-size:1rem;margin-bottom:10px;padding:6px 12px;background:#e8f5e9;border-radius:6px}
.courts-row{display:flex;gap:10px;flex-wrap:wrap}
.court-card{border:2px solid #1a5c2a;border-radius:10px;overflow:hidden;flex:1;min-width:200px;max-width:280px}
.court-card.hl-court{border-color:#e67e00}
.court-header{background:#1a5c2a;color:#fff;padding:7px 12px;font-weight:700;font-size:.9rem}
.court-header.hl-hdr{background:#e67e00}
.court-body{padding:10px 12px}
.team{background:#e8f5e9;border-radius:6px;padding:7px 10px;margin:3px 0}
.team-label{font-size:.72rem;font-weight:700;color:#1a5c2a;margin-bottom:3px}
.player-chip{display:inline-block;background:#fff;border:1.5px solid #1a5c2a;border-radius:14px;padding:2px 9px;margin:2px;font-size:.78rem}
.player-chip.hl{background:#f5a623;border-color:#e67e00;font-weight:700}
.bye-chip{background:#fff3cd;border:1.5px solid #e6ac00}
.vs{text-align:center;font-weight:700;color:#888;margin:3px 0;font-size:.78rem}
.score-row{display:flex;align-items:center;justify-content:flex-end;gap:6px;margin-top:8px;padding-top:8px;border-top:1px dashed #ccc}
.score-badge{background:#e8f5e9;border-radius:6px;padding:3px 8px;font-size:.82rem;font-weight:700;color:#1a5c2a}
.score-na{color:#aaa;font-size:.8rem;font-style:italic;flex:1}
.team-row{display:flex;align-items:center;justify-content:space-between;gap:6px}
.team-score{background:#1a5c2a;color:#fff;border-radius:6px;padding:2px 10px;font-size:.85rem;font-weight:700;min-width:28px;text-align:center;flex-shrink:0}
.team-score.winner{background:#f5a623;color:#222}
.team-score.empty{background:#eee;color:#aaa}
.bye-row{background:#fff3cd;border-radius:6px;padding:8px 12px;margin-top:8px;font-size:.85rem}
.alert{padding:10px 14px;border-radius:6px;margin-bottom:12px;font-size:.88rem}
.alert-info{background:#d1ecf1;color:#0c5460}
.alert-warn{background:#fff3cd;color:#856404}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:8px}
.cal-day{padding:6px;text-align:center;border-radius:6px;font-size:.82rem;cursor:default}
.cal-sat{border:1.5px solid #ccc;background:#f9f9f9;cursor:pointer;-webkit-tap-highlight-color:transparent}
.cal-sat:active{background:#e8f5e9}
.cal-sat.active{background:#1a5c2a;color:#fff;border-color:#1a5c2a}
.cal-hdr{font-weight:700;font-size:.75rem;color:#666}
.cal-other{color:#ccc}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
.modal-overlay.open{display:flex}
.modal{background:#fff;border-radius:12px;padding:20px;max-width:440px;width:100%;max-height:90vh;overflow-y:auto}
.modal.modal-wide{max-width:680px}
.modal h3{color:#1a5c2a;margin-bottom:14px}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
.season-btn{padding:6px 14px;border-radius:16px;border:2px solid #1a5c2a;cursor:pointer;font-weight:600;font-size:.85rem;background:#fff;color:#1a5c2a;-webkit-tap-highlight-color:transparent}
.season-btn.active{background:#1a5c2a;color:#fff}
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 22px;border-radius:20px;font-size:.9rem;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.3);opacity:0;transition:opacity .4s;pointer-events:none;white-space:nowrap;max-width:90vw;text-align:center}
.score-input-wrap{display:flex;align-items:center;gap:8px;margin:6px 0}
.score-input-wrap input{margin:0;width:70px;text-align:center;flex-shrink:0}
.score-team-lbl{font-size:.9rem;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rsvp-big-btn{flex:1;padding:16px;font-size:1.1rem;border-radius:8px;margin-top:4px}

/* Sync indicator */
#sync-dot{width:8px;height:8px;border-radius:50%;background:#f5a623;display:inline-block;margin-left:6px;vertical-align:middle;transition:background .4s}
#sync-dot.synced{background:#4caf50}
#sync-dot.error{background:#c0392b}

/* Loading screen */
#loading{position:fixed;inset:0;background:#1a5c2a;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999;color:#fff}
#loading .spin{font-size:3rem;animation:spin 1s linear infinite;margin-bottom:16px}
#loading p{font-size:1rem;opacity:.8}
@keyframes spin{to{transform:rotate(360deg)}}

/* PWA Install Banner */
#install-banner{display:none;position:fixed;bottom:0;left:0;right:0;background:#1a5c2a;color:#fff;padding:14px 16px;padding-bottom:max(14px,env(safe-area-inset-bottom));z-index:8888;flex-direction:row;align-items:center;gap:12px;box-shadow:0 -2px 12px rgba(0,0,0,.2)}
#install-banner.show{display:flex}
#install-banner .ib-text{flex:1;font-size:.9rem;line-height:1.3}
#install-banner .ib-text strong{display:block;font-size:1rem}
#install-banner .ib-btns{display:flex;gap:8px;flex-shrink:0}
#install-banner .ib-install{background:#f5a623;color:#222;border:none;border-radius:8px;padding:9px 18px;font-weight:700;font-size:.9rem;cursor:pointer}
#install-banner .ib-dismiss{background:transparent;color:rgba(255,255,255,.7);border:1.5px solid rgba(255,255,255,.4);border-radius:8px;padding:9px 14px;font-size:.9rem;cursor:pointer}
#ios-tip{display:none;position:fixed;bottom:0;left:0;right:0;background:#1a5c2a;color:#fff;padding:16px;padding-bottom:max(16px,env(safe-area-inset-bottom));z-index:8888;box-shadow:0 -2px 12px rgba(0,0,0,.2);text-align:center;font-size:.9rem;line-height:1.5}
#ios-tip.show{display:block}
#ios-tip strong{display:block;margin-bottom:4px;font-size:1rem}
#ios-tip .ios-close{margin-top:10px;background:rgba(255,255,255,.2);border:none;color:#fff;border-radius:8px;padding:8px 24px;font-size:.9rem;cursor:pointer}
</style>
</head>
<body>

<!-- Loading screen shown until Firebase data is ready -->
<div id="loading">
  <div class="spin">ğŸ¾</div>
  <p>Loading DMV Tennisâ€¦</p>
</div>

<!-- PWA Install prompts -->
<div id="install-banner">
  <div class="ib-text"><strong>ğŸ“² Install DMV Tennis</strong>Add to your home screen for quick access</div>
  <div class="ib-btns">
    <button class="ib-dismiss" id="ib-dismiss">Later</button>
    <button class="ib-install" id="ib-install">Install</button>
  </div>
</div>
<div id="ios-tip">
  <strong>ğŸ“² Install DMV Tennis on your iPhone</strong>
  Tap <strong>Share</strong> (â–¡â†‘) then <strong>"Add to Home Screen"</strong>
  <br><button class="ios-close" id="ios-close">Got it</button>
</div>

<header>
  <h1>ğŸ¾ DMV Tennis <span id="sync-dot" title="Syncingâ€¦"></span></h1>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <span id="hdr-season" style="font-size:.85rem;opacity:.85"></span>
    <button class="btn btn-secondary btn-sm" id="admin-btn">Admin Login</button>
  </div>
</header>
<div id="app"></div>
<div class="modal-overlay" id="modal-overlay"><div class="modal" id="modal-body"></div></div>
<div id="toast"></div>

<script>
// â•â• FIREBASE INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase ESM module sets window._fbDb, _fbRef, _fbSet, _fbOnValue
// We defer setup until 'firebase-ready' fires
var dbRef = null;
var _saveTimer = null;
var _loaded = false;

// â•â• PWA INSTALL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _deferredPrompt = null;
window.addEventListener('beforeinstallprompt', function(e){
  e.preventDefault(); _deferredPrompt = e;
  if(!isStandalone()) document.getElementById('install-banner').classList.add('show');
});
function isStandalone(){ return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone===true; }
function isIOS(){ return /iphone|ipad|ipod/i.test(navigator.userAgent) && !window.MSStream; }
document.getElementById('ib-install').addEventListener('click', function(){
  if(!_deferredPrompt) return;
  _deferredPrompt.prompt();
  _deferredPrompt.userChoice.then(function(){ _deferredPrompt=null; document.getElementById('install-banner').classList.remove('show'); });
});
document.getElementById('ib-dismiss').addEventListener('click', function(){ document.getElementById('install-banner').classList.remove('show'); });
document.getElementById('ios-close').addEventListener('click', function(){
  document.getElementById('ios-tip').classList.remove('show');
  try{ localStorage.setItem('dmvt_ios_tip','1'); }catch(e){}
});
window.addEventListener('load', function(){
  if(isIOS() && !isStandalone()){
    var seen=false; try{ seen=!!localStorage.getItem('dmvt_ios_tip'); }catch(e){}
    if(!seen) setTimeout(function(){ document.getElementById('ios-tip').classList.add('show'); }, 3000);
  }
});

// â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var S = {
  players: [],
  seasons: {Spring:[],Summer:[],Fall:[],Winter:[]},
  currentSeason: 'Winter',
  sessions: {},
  byeCounts: {},
  playerStats: {},
  captainPid: null,
  pointsConfig: {matchWin:3, gameWin:1, attendance:1},
  isAdmin: false,
  selectedDate: null,
  adminTab: 'roster',
  userTab: 'rsvp'
};
var PASS = 'mydmvtennis';
var SEASONS = ['Spring','Summer','Fall','Winter'];

// â”€â”€ Load admin pref from localStorage (device-only) â”€â”€
try {
  var localPrefs = JSON.parse(localStorage.getItem('dmvt_prefs')||'{}');
  if(localPrefs.isAdmin) S.isAdmin = true;
  if(localPrefs.adminTab) S.adminTab = localPrefs.adminTab;
  if(localPrefs.userTab) S.userTab = localPrefs.userTab;
  if(localPrefs.selectedDate) S.selectedDate = localPrefs.selectedDate;
  if(localPrefs.currentSeason) S.currentSeason = localPrefs.currentSeason;
  if(localPrefs.captainPid) S.captainPid = parseInt(localPrefs.captainPid)||null;
} catch(e){}

function saveLocalPrefs(){
  try{
    localStorage.setItem('dmvt_prefs', JSON.stringify({
      isAdmin: S.isAdmin,
      adminTab: S.adminTab,
      userTab: S.userTab,
      captainPid: S.captainPid||null,
      selectedDate: S.selectedDate,
      currentSeason: S.currentSeason
    }));
  }catch(e){}
}

// â”€â”€ Save shared data to Firebase (debounced 400ms) â”€â”€â”€â”€
function save(){
  saveLocalPrefs();
  if(!dbRef){ return; } // Firebase not ready yet â€” skip remote save
  setSyncDot('saving');
  if(_saveTimer) clearTimeout(_saveTimer);
  _saveTimer = setTimeout(function(){
    var data = {
      players: S.players || [],
      seasons: S.seasons || {},
      sessions: S.sessions || {},
      byeCounts: S.byeCounts || {},
      playerStats:  S.playerStats  || {},
      pointsConfig: S.pointsConfig  || {matchWin:3,gameWin:1,attendance:1}
    };
    // Firebase doesn't support undefined values â€” strip them
    window._fbSet(dbRef, JSON.parse(JSON.stringify(data)))
      .then(function(){ setSyncDot('synced'); })
      .catch(function(e){ setSyncDot('error'); showToast('âš ï¸ Save failed: ' + e.message); });
  }, 400);
}

function setSyncDot(state){
  var dot = document.getElementById('sync-dot');
  if(!dot) return;
  dot.className = state === 'synced' ? 'synced' : state === 'error' ? 'error' : '';
}

// â”€â”€ Listen to Firebase for real-time updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initFirebaseListener() {
  var db = window._fbDb;
  dbRef = window._fbRef(db, 'dmvtennis');
  window._fbOnValue(dbRef, function(snapshot){
    var data = snapshot.val();
    if(data){
      S.players     = data.players     || [];
      S.seasons     = data.seasons     || {Spring:[],Summer:[],Fall:[],Winter:[]};
      S.sessions    = data.sessions    || {};
      S.byeCounts   = data.byeCounts   || {};
      S.playerStats  = data.playerStats  || {};
      S.pointsConfig = data.pointsConfig  || {matchWin:3,gameWin:1,attendance:1};
    }
    setSyncDot('synced');
    // Refresh PC court grids live if visible
    (function(){
      var upD=getUpcoming();
      if(!upD) return;
      var upS=getSession(upD);
      if(!upS.playersChoice) return;
      var ag=byId('pc-court-grid');
      if(ag){ ag.innerHTML=playersChoiceCourtGrid(upS,upD,true); bindScoreButtons(); }
      var ug=byId('pc-user-grid');
      if(ug){ ug.innerHTML=playersChoiceCourtGrid(upS,upD,false); }
    })();
    if(!_loaded){
      _loaded = true;
      document.getElementById('loading').style.display = 'none';
    }
    render();
  }, function(error){
    setSyncDot('error');
    document.getElementById('loading').style.display = 'none';
    showToast('âš ï¸ Connection error. Check your internet.');
    if(!_loaded){ _loaded=true; render(); }
  });
}
window.addEventListener('firebase-ready', initFirebaseListener);

// â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(str){
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function getPlayer(id){
  for(var i=0;i<S.players.length;i++) if(S.players[i].id===id) return S.players[i];
  return null;
}
function fmtId(id){ return id<10?'0'+id:''+id; }
function fmtDate(d){
  try{ return new Date(d+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'}); }
  catch(e){ return d||''; }
}
function getSession(date){
  if(!date) return {type:'doubles',rotatePartners:true,manualPartners:false,teamBattle:false,playersChoice:false,teamA:[],teamB:[],captainA:null,captainB:null,courts:4,matchesPerPlayer:4,rsvps:{},assignments:null,scores:{},posted:false,lockedTeams:[],noByePids:[]};
  if(!S.sessions[date]) S.sessions[date]={type:'doubles',rotatePartners:true,manualPartners:false,teamBattle:false,playersChoice:false,teamA:[],teamB:[],captainA:null,captainB:null,courts:4,matchesPerPlayer:4,rsvps:{},assignments:null,scores:{},posted:false,lockedTeams:[],noByePids:[]};
  var sess=S.sessions[date];
  if(!sess.scores) sess.scores={};
  if(!sess.rsvps) sess.rsvps={};
  if(sess.courts===undefined) sess.courts=4;
  if(sess.matchesPerPlayer===undefined) sess.matchesPerPlayer=4;
  if(sess.type===undefined) sess.type='doubles';
  return sess;
}
function getInPlayers(date){
  var sess=getSession(date), result=[];
  for(var i=0;i<S.players.length;i++)
    if(sess.rsvps[S.players[i].id]==='IN') result.push(S.players[i]);
  return result;
}
function getUpcoming(){
  var dates=(S.seasons[S.currentSeason]||[]).slice().sort();
  var today=new Date(); today.setHours(0,0,0,0);
  for(var i=0;i<dates.length;i++)
    if(new Date(dates[i]+'T12:00:00')>=today) return dates[i];
  return null;
}
function byId(id){ return document.getElementById(id); }

// â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _tt=null;
function showToast(msg){
  var t=byId('toast'); if(!t) return;
  t.textContent=msg; t.style.opacity='1';
  if(_tt) clearTimeout(_tt);
  _tt=setTimeout(function(){ t.style.opacity='0'; },3000);
}

// â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModal(html,wide){ var m=byId('modal-body').parentElement; if(m){ m.classList.toggle('modal-wide',!!wide); } byId('modal-body').innerHTML=html; byId('modal-overlay').classList.add('open'); }
function closeModal(){ byId('modal-overlay').classList.remove('open'); byId('modal-body').innerHTML=''; }
byId('modal-overlay').addEventListener('click',function(e){ if(e.target.id==='modal-overlay') closeModal(); });

// â•â• ROOT RENDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  byId('hdr-season').textContent=''; // keep sync dot; set season label separately
  var seasonEl = document.createElement('span');
  seasonEl.textContent = S.currentSeason+' Season';
  var hdrSeason = byId('hdr-season');
  if(hdrSeason) hdrSeason.textContent = S.currentSeason+' Season';
  byId('admin-btn').textContent=S.isAdmin?'Logout':'Admin Login';
  byId('app').innerHTML=S.isAdmin?adminHTML():userHTML();
  if(S.isAdmin) bindAdmin(); else bindUser();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USER VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function userHTML(){
  var upcomingDate=getUpcoming();
  var upSess=upcomingDate?getSession(upcomingDate):null;
  var showCaptainTab=upSess&&upSess.teamBattle;
  var showPCTab=upSess&&upSess.playersChoice;
  var h='<div class="tabs">'
    +'<button class="tab'+(S.userTab==='rsvp'?' active':'')+'" data-utab="rsvp">RSVP</button>'
    +'<button class="tab'+(S.userTab==='schedule'?' active':'')+'" data-utab="schedule">Schedule</button>'
    +(showCaptainTab?'<button class="tab'+(S.userTab==='captain'?' active':'')+'" data-utab="captain">âš”ï¸ My Team</button>':'')
    +(showPCTab?'<button class="tab'+(S.userTab==='pchoice'?' active':'')+'" data-utab="pchoice">ğŸ¾ My Court</button>':'')
    +'<button class="tab'+(S.userTab==='stats'?' active':'')+'" data-utab="stats">Stats</button>'
    +'</div>';
  h+=(S.userTab==='rsvp')?rsvpHTML():(S.userTab==='captain')?captainTeamHTML():(S.userTab==='pchoice')?playersChoiceUserHTML():(S.userTab==='schedule')?scheduleHTML(false):byesHTML();
  return h;
}
function bindUser(){
  document.querySelectorAll('[data-utab]').forEach(function(b){
    b.addEventListener('click',function(){ S.userTab=b.dataset.utab; saveLocalPrefs(); render(); });
  });
  var lb=byId('rsvp-lookup-btn'); if(lb) lb.addEventListener('click',renderRsvpStatus);
  var rs=byId('rsvp-sel');
  if(rs){ rs.addEventListener('change',renderRsvpStatus); rs.addEventListener('input',renderRsvpStatus); }
  var capLogin=byId('captain-login-btn'); if(capLogin) capLogin.addEventListener('click',openCaptainLogin);
  var pcSubmit=byId('pc-submit-btn'); if(pcSubmit) pcSubmit.addEventListener('click',submitPlayersChoice);

  // Captain team management
  var capAddBtn=byId('cap-add-btn');
  if(capAddBtn){
    var capSel=byId('cap-add-player-sel');
    // Show/hide cross-team warning on selection change
    if(capSel){
      capSel.addEventListener('change',function(){
        var pid=parseInt(capSel.value);
        var warn=byId('cap-add-warn');
        if(!warn||!pid) { if(warn) warn.style.display='none'; return; }
        var date=getUpcoming(); if(!date) return;
        var sess=getSession(date);
        var isCapA=(S.captainPid===sess.captainA);
        var otherTeam=isCapA?(sess.teamB||[]):(sess.teamA||[]);
        warn.style.display=(otherTeam.indexOf(pid)>=0)?'block':'none';
      });
    }
    capAddBtn.addEventListener('click',function(){
      var pid=capSel?parseInt(capSel.value):0;
      if(!pid){ showToast('Please select a player.'); return; }
      var date=getUpcoming(); if(!date) return;
      var sess=getSession(date);
      var isCapA=(S.captainPid===sess.captainA);
      var isCapB=(S.captainPid===sess.captainB);
      if(!isCapA&&!isCapB){ showToast('Not a captain.'); return; }
      var otherTeam=isCapA?(sess.teamB||[]):(sess.teamA||[]);
      if(isCapA){
        if(!sess.teamA) sess.teamA=[];
        if(sess.teamA.indexOf(pid)<0) sess.teamA.push(pid);
      } else {
        if(!sess.teamB) sess.teamB=[];
        if(sess.teamB.indexOf(pid)<0) sess.teamB.push(pid);
      }
      var wasOnOtherTeam=otherTeam.indexOf(pid)>=0;
      S.sessions[date]=sess; save();
      showToast('Player added!'+(wasOnOtherTeam?' (Note: they are also on the other team)':''));
      render();
    });
  }
  // Captain remove player
  document.querySelectorAll('[data-remove-pid]').forEach(function(btn){
    btn.addEventListener('click',function(){
      var pid=parseInt(btn.dataset.removePid);
      var date=getUpcoming(); if(!date) return;
      var sess=getSession(date);
      var isCapA=(S.captainPid===sess.captainA);
      if(isCapA){ sess.teamA=(sess.teamA||[]).filter(function(id){ return id!==pid; }); }
      else { sess.teamB=(sess.teamB||[]).filter(function(id){ return id!==pid; }); }
      S.sessions[date]=sess; save();
      showToast('Player removed.'); render();
    });
  });
  bindScoreButtons(); bindHighlightSelect();
}

// â”€â”€ RSVP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ RSVP ROSTER SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rsvpRosterHTML(date){
  var sess=getSession(date), rsvps=sess.rsvps||{};
  var inList=[], outList=[], pendingList=[];
  for(var i=0;i<S.players.length;i++){
    var p=S.players[i], st=rsvps[p.id];
    if(st==='IN') inList.push(p);
    else if(st==='OUT') outList.push(p);
    else pendingList.push(p);
  }
  var h='<div style="margin-top:16px;border-top:2px solid #e8f5e9;padding-top:14px">';
  h+='<div style="font-weight:700;color:#1a5c2a;margin-bottom:10px;font-size:.95rem">ğŸ“‹ Who&#39;s Playing?</div>';

  // IN
  h+='<div style="margin-bottom:10px">';
  h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
  h+='<span class="badge badge-in">âœ… IN</span>';
  h+='<span style="font-size:.82rem;color:#555">'+inList.length+' player'+(inList.length!==1?'s':'')+'</span>';
  h+='</div>';
  if(inList.length){
    h+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
    for(var i=0;i<inList.length;i++){
      h+='<span style="background:#d4edda;color:#155724;border-radius:16px;padding:4px 12px;font-size:.85rem;font-weight:600">'+esc(inList[i].name)+'</span>';
    }
    h+='</div>';
  } else {
    h+='<span style="color:#aaa;font-size:.82rem;font-style:italic">No one yet</span>';
  }
  h+='</div>';

  // OUT
  if(outList.length){
    h+='<div style="margin-bottom:10px">';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
    h+='<span class="badge badge-out">âŒ OUT</span>';
    h+='<span style="font-size:.82rem;color:#555">'+outList.length+' player'+(outList.length!==1?'s':'')+'</span>';
    h+='</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
    for(var i=0;i<outList.length;i++){
      h+='<span style="background:#f8d7da;color:#721c24;border-radius:16px;padding:4px 12px;font-size:.85rem">'+esc(outList[i].name)+'</span>';
    }
    h+='</div></div>';
  }

  // Pending
  if(pendingList.length){
    h+='<div>';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
    h+='<span style="background:#eee;color:#666;border-radius:12px;padding:2px 8px;font-size:.75rem;font-weight:700">â³ PENDING</span>';
    h+='<span style="font-size:.82rem;color:#555">'+pendingList.length+' haven&#39;t responded</span>';
    h+='</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
    for(var i=0;i<pendingList.length;i++){
      h+='<span style="background:#f5f5f5;color:#888;border-radius:16px;padding:4px 12px;font-size:.85rem">'+esc(pendingList[i].name)+'</span>';
    }
    h+='</div></div>';
  }

  h+='</div>';
  return h;
}

function rsvpHTML(){
  var date=getUpcoming();
  if(!date) return '<div class="card"><h2>ğŸ“… Upcoming Saturday</h2><div class="alert alert-info">No upcoming Saturday scheduled yet.</div></div>';
  var label='';
  try{ label=new Date(date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'}); }catch(e){ label=date; }
  var opts='<option value="">-- Choose your name --</option>';
  for(var i=0;i<S.players.length;i++){
    var p=S.players[i];
    opts+='<option value="'+p.id+'">'+fmtId(p.id)+' - '+esc(p.name)+'</option>';
  }
  return '<div class="card"><h2>ğŸ“… '+esc(label)+'</h2>'
    +'<label>Select Your Name</label>'
    +'<select id="rsvp-sel" style="font-size:1rem;padding:12px;margin-bottom:10px">'+opts+'</select>'
    +'<button class="btn btn-green" style="width:100%;padding:12px;font-size:1rem;margin-bottom:12px" id="rsvp-lookup-btn">View / Update My Status</button>'
    +'<div id="rsvp-status"></div>'
    +'<div id="rsvp-roster">'+rsvpRosterHTML(date)+'</div>'
    +'</div>';
}
function renderRsvpStatus(){
  var sel=byId('rsvp-sel'), el=byId('rsvp-status');
  if(!sel||!el) return;
  var pid=parseInt(sel.value);
  if(!pid){ el.innerHTML='<div class="alert alert-warn">Please select your name first.</div>'; return; }
  var date=getUpcoming(); if(!date){ el.innerHTML=''; return; }
  var sess=getSession(date), cur=sess.rsvps[pid]||null, p=getPlayer(pid), name=p?p.name:fmtId(pid);
  el.innerHTML='<div>'
    +'<div style="font-size:.95rem;margin-bottom:10px">Status for <strong>'+esc(name)+'</strong>: '
    +(cur?'<span class="badge '+(cur==='IN'?'badge-in':'badge-out')+'">'+cur+'</span>':'<span style="color:#888">Not set</span>')
    +'</div><div style="display:flex;gap:12px">'
    +'<button class="btn rsvp-big-btn '+(cur==='IN'?'btn-primary':'btn-secondary')+'" id="btn-in">âœ… IN</button>'
    +'<button class="btn rsvp-big-btn '+(cur==='OUT'?'btn-danger':'btn-secondary')+'" id="btn-out">âŒ OUT</button>'
    +'</div></div>';
  byId('btn-in').addEventListener('click',function(){ setRsvp(pid,'IN',date); });
  byId('btn-out').addEventListener('click',function(){ setRsvp(pid,'OUT',date); });
  var rr=byId('rsvp-roster'); if(rr) rr.innerHTML=rsvpRosterHTML(date);
}
function setRsvp(pid,status,date){
  var sess=getSession(date);
  sess.rsvps[pid]=status;
  S.sessions[date]=sess;
  save();
  var p=getPlayer(pid), name=p?p.name:fmtId(pid), el=byId('rsvp-status');
  if(!el) return;
  el.innerHTML='<div>'
    +'<div style="font-size:.95rem;margin-bottom:10px">Status for <strong>'+esc(name)+'</strong>: '
    +'<span class="badge '+(status==='IN'?'badge-in':'badge-out')+'">'+status+'</span></div>'
    +'<div style="display:flex;gap:12px">'
    +'<button class="btn rsvp-big-btn '+(status==='IN'?'btn-primary':'btn-secondary')+'" id="btn-in">âœ… IN</button>'
    +'<button class="btn rsvp-big-btn '+(status==='OUT'?'btn-danger':'btn-secondary')+'" id="btn-out">âŒ OUT</button>'
    +'</div><div style="margin-top:10px;color:#1a5c2a;font-weight:700">âœ“ Saved!</div></div>';
  byId('btn-in').addEventListener('click',function(){ setRsvp(pid,'IN',date); });
  byId('btn-out').addEventListener('click',function(){ setRsvp(pid,'OUT',date); });
  var rr=byId('rsvp-roster'); if(rr) rr.innerHTML=rsvpRosterHTML(date);
}

// â”€â”€ SCHEDULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scheduleHTML(isAdmin){
  var date=isAdmin?S.selectedDate:getUpcoming();
  if(!date) return '<div class="card"><h2>ğŸ† Court Assignments</h2><div class="alert alert-info">No date available.</div></div>';
  var sess=getSession(date);
  if(sess.playersChoice){
    return playersChoiceCourtGrid(sess, date, isAdmin);
  }
  if(!isAdmin&&(!sess.posted||!sess.assignments))
    return '<div class="card"><h2>ğŸ† Court Assignments</h2><div class="alert alert-info">Assignments not yet posted by admin.</div></div>';
  if(!sess.assignments)
    return '<div class="card"><h2>ğŸ† Court Assignments</h2><div class="alert alert-info">No assignments generated yet.</div></div>';
  var inP=getInPlayers(date);
  var hlOpts='<option value="">-- Select your name --</option>';
  for(var i=0;i<inP.length;i++) hlOpts+='<option value="'+inP[i].id+'">'+fmtId(inP[i].id)+' - '+esc(inP[i].name)+'</option>';
  return '<div class="card"><h2>ğŸ† Court Assignments â€” '+fmtDate(date)+'</h2>'
    +'<div style="background:#fffde7;border:1.5px solid #f5a623;border-radius:8px;padding:8px 12px;margin-bottom:12px">'
    +'<label>ğŸ” Highlight My Matches</label><select id="hl-sel">'+hlOpts+'</select></div>'
    +'<div id="rounds-display">'+roundsHTML(sess,date,null)+'</div></div>';
}
function roundsHTML(sess,date,hid){
  if(!sess||!sess.assignments||!Array.isArray(sess.assignments.rounds)) return '';
  var scores=sess.scores||{}, out='', rounds=sess.assignments.rounds;
  var noByePids=sess.noByePids||[];
  var lockedTeams=sess.lockedTeams||[];
  // Build a set of all locked player ids
  var lockedPidSet={};
  for(var li=0;li<lockedTeams.length;li++) for(var lj=0;lj<lockedTeams[li].length;lj++) lockedPidSet[lockedTeams[li][lj]]=true;
  // Helper: is this team a locked team?
  function isLockedTeam(team){
    if(!team||team.length<2) return false;
    for(var li=0;li<lockedTeams.length;li++){
      var lt=lockedTeams[li];
      if(lt.length===team.length&&team.every(function(pid){ return lt.indexOf(pid)>=0; })) return true;
    }
    return false;
  }
  for(var ri=0;ri<rounds.length;ri++){
    var round=rounds[ri]; if(!round||!Array.isArray(round.courts)) continue;
    out+='<div class="round-block"><div class="round-title">Round '+(ri+1)+'</div><div class="courts-row">';
    for(var ci=0;ci<round.courts.length;ci++){
      var court=round.courts[ci]; if(!court||!Array.isArray(court.teams)) continue;
      var hasMe=false;
      if(hid!=null) for(var t=0;t<court.teams.length;t++) if(Array.isArray(court.teams[t])&&court.teams[t].indexOf(hid)>=0){ hasMe=true; break; }
      var scoreKey=ri+'_'+ci, sc=scores[scoreKey]||null;
      out+='<div class="court-card'+(hasMe?' hl-court':'')+'">'
        +'<div class="court-header'+(hasMe?' hl-hdr':'')+'">Court '+(ci+1)+'</div>'
        +'<div class="court-body">';
      for(var ti=0;ti<court.teams.length;ti++){
        var team=court.teams[ti]; if(!Array.isArray(team)) continue;
        var teamScore = sc ? (ti===0 ? sc.t1 : sc.t2) : null;
        var otherScore = sc ? (ti===0 ? sc.t2 : sc.t1) : null;
        var isWinner = sc && parseInt(teamScore) > parseInt(otherScore);
        var teamLocked = isLockedTeam(team);
        out+='<div class="team"><div class="team-row"><div class="team-label" style="margin:0">Team '+(ti+1)+(teamLocked?' ğŸ”’':'')+'</div>';
        out+='<span class="team-score'+(sc ? (isWinner ? ' winner' : '') : ' empty')+'">'+(sc ? esc(teamScore) : 'â€”')+'</span>';
        out+='</div><div style="margin-top:4px">';
        for(var pi=0;pi<team.length;pi++){
          var pid2=team[pi], tp=getPlayer(pid2);
          var earlyLeave=noByePids.indexOf(pid2)>=0;
          out+='<span class="player-chip'+(pid2===hid?' hl':'')+'">'+(earlyLeave?'âš¡ ':'')+fmtId(pid2)+' '+(tp?esc(tp.name):'?')+'</span>';
        }
        out+='</div></div>';
        if(ti===0&&court.teams.length>1) out+='<div class="vs">VS</div>';
      }
      out+='<div class="score-row">';
      out+='<button class="btn btn-secondary btn-sm" data-score-btn data-date="'+esc(date)+'" data-round="'+ri+'" data-court="'+ci+'">'+(sc?'âœï¸ Edit Score':'+ Score')+'</button>';
      out+='</div></div></div>';
    }
    out+='</div>';
    if(Array.isArray(round.byes)&&round.byes.length){
      out+='<div class="bye-row">â¸ Sitting out: ';
      for(var bi=0;bi<round.byes.length;bi++){
        var bpid=round.byes[bi], bp=getPlayer(bpid);
        out+='<span class="player-chip bye-chip'+(bpid===hid?' hl':'')+'">'+fmtId(bpid)+' '+(bp?esc(bp.name):'?')+'</span>';
      }
      out+='</div>';
    }
    out+='</div>';
  }
  return out;
}
function bindScoreButtons(){
  document.querySelectorAll('[data-score-btn]').forEach(function(b){
    b.addEventListener('click',function(){
      var date=b.dataset.date, ri=parseInt(b.dataset.round), ci=parseInt(b.dataset.court);
      if(date&&!isNaN(ri)&&!isNaN(ci)) openScoreModal(date,ri,ci);
    });
  });
}
function bindHighlightSelect(){
  var hsel=byId('hl-sel'); if(!hsel) return;
  hsel.addEventListener('change',function(){
    var hid=parseInt(hsel.value)||null;
    var date=S.isAdmin?S.selectedDate:getUpcoming(); if(!date) return;
    var sess=getSession(date), el=byId('rounds-display');
    if(el){ el.innerHTML=roundsHTML(sess,date,hid); bindScoreButtons(); }
  });
}

// â”€â”€ SCORE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openScoreModal(date,ri,ci){
  var sess=getSession(date);
  if(!sess.assignments||!Array.isArray(sess.assignments.rounds)) return;
  var round=sess.assignments.rounds[ri]; if(!round||!Array.isArray(round.courts)) return;
  var court=round.courts[ci]; if(!court||!Array.isArray(court.teams)) return;
  var key=ri+'_'+ci, sc=sess.scores[key]||{t1:'',t2:''};
  function teamName(team){ if(!Array.isArray(team)) return 'Team'; var n=[]; for(var i=0;i<team.length;i++){ var p=getPlayer(team[i]); n.push(p?p.name:fmtId(team[i])); } return n.join(' & '); }
  var t1=teamName(court.teams[0])||'Team 1', t2=teamName(court.teams[1])||'Team 2';
  var clrBtn=(sc.t1!=='')?'<button class="btn btn-danger btn-sm" id="sc-clear">Clear</button>':'';
  showModal('<h3>ğŸ“ Score â€” Court '+(ci+1)+', Round '+(ri+1)+'</h3>'
    +'<div class="score-input-wrap"><span class="score-team-lbl">'+esc(t1)+'</span><input id="sc-t1" type="number" min="0" max="99" value="'+esc(sc.t1)+'" placeholder="0"></div>'
    +'<div style="text-align:center;font-weight:700;color:#888;margin:4px 0">VS</div>'
    +'<div class="score-input-wrap"><span class="score-team-lbl">'+esc(t2)+'</span><input id="sc-t2" type="number" min="0" max="99" value="'+esc(sc.t2)+'" placeholder="0"></div>'
    +'<div class="modal-btns">'+clrBtn+'<button class="btn btn-secondary" id="sc-cancel">Cancel</button><button class="btn btn-primary" id="sc-save">Save Score</button></div>');
  byId('sc-cancel').addEventListener('click',closeModal);
  var clr=byId('sc-clear');
  if(clr) clr.addEventListener('click',function(){ delete sess.scores[key]; S.sessions[date]=sess; rebuildSeasonStats(S.currentSeason); save(); closeModal(); showToast('Score cleared.'); });
  byId('sc-save').addEventListener('click',function(){
    var v1=byId('sc-t1').value.trim(), v2=byId('sc-t2').value.trim();
    if(v1===''||v2===''){ showToast('Please enter scores for both teams.'); return; }
    sess.scores[key]={t1:v1,t2:v2}; S.sessions[date]=sess; rebuildSeasonStats(S.currentSeason); save(); closeModal(); showToast('Score saved!');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function adminHTML(){
  var tabs=['roster','calendar','session','byes'], labels=['Roster','Calendar','Session','Stats'];
  var h='<div class="tabs">';
  for(var i=0;i<tabs.length;i++) h+='<button class="tab'+(S.adminTab===tabs[i]?' active':'')+'" data-atab="'+tabs[i]+'">'+labels[i]+'</button>';
  h+='</div>';
  if(S.adminTab==='roster') h+=rosterHTML();
  else if(S.adminTab==='calendar') h+=calendarHTML();
  else if(S.adminTab==='session') h+=sessionHTML();
  else if(S.adminTab==='byes') h+=byesHTML();
  return h;
}
function bindAdmin(){
  document.querySelectorAll('[data-atab]').forEach(function(b){
    b.addEventListener('click',function(){ S.adminTab=b.dataset.atab; saveLocalPrefs(); render(); });
  });
  var addBtn=byId('add-player-btn'); if(addBtn) addBtn.addEventListener('click',function(){ openPlayerModal(null); });
  var syncBtn=byId('sync-btn'); if(syncBtn) syncBtn.addEventListener('click',openSheetSync);
  var exportBtn=byId('export-btn'); if(exportBtn) exportBtn.addEventListener('click',exportCSV);
  var importStatsBtn=byId('import-stats-btn'); if(importStatsBtn) importStatsBtn.addEventListener('click',openImportStats);
  var exportStatsBtn=byId('export-stats-btn'); if(exportStatsBtn) exportStatsBtn.addEventListener('click',exportStats);
  var attBtn=byId('att-btn'); if(attBtn) attBtn.addEventListener('click',openAttendanceModal);
  var cfgSave=byId('cfg-save-btn'); if(cfgSave) cfgSave.addEventListener('click',savePointsConfig);
  document.querySelectorAll('[data-edit-pid]').forEach(function(b){
    b.addEventListener('click',function(){ openPlayerModal(parseInt(b.dataset.editPid)); });
  });
  document.querySelectorAll('[data-del-pid]').forEach(function(b){
    b.addEventListener('click',function(){
      var id=parseInt(b.dataset.delPid), p=getPlayer(id);
      showModal('<h3>Remove Player</h3><p style="margin-bottom:16px">Remove <strong>'+(p?esc(p.name):'this player')+'</strong>?</p>'
        +'<div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Cancel</button><button class="btn btn-danger" id="m-confirm">Remove</button></div>');
      byId('m-cancel').addEventListener('click',closeModal);
      byId('m-confirm').addEventListener('click',function(){ S.players=S.players.filter(function(x){ return x.id!==id; }); save(); closeModal(); });
    });
  });
  document.querySelectorAll('[data-season-btn]').forEach(function(b){
    b.addEventListener('click',function(){ S.currentSeason=b.dataset.seasonBtn; save(); saveLocalPrefs(); render(); });
  });
  document.querySelectorAll('[data-cal-date]').forEach(function(b){
    b.addEventListener('click',function(){
      var key=b.dataset.calDate, s=S.currentSeason;
      if(!S.seasons[s]) S.seasons[s]=[];
      var idx=S.seasons[s].indexOf(key);
      if(idx>=0) S.seasons[s].splice(idx,1); else S.seasons[s].push(key);
      save();
    });
  });
  var dateSel=byId('session-date-sel');
  if(dateSel) dateSel.addEventListener('change',function(){ S.selectedDate=dateSel.value; saveLocalPrefs(); render(); });
  ['s-type','s-rotate','s-courts','s-matches'].forEach(function(id){
    var el=byId(id); if(el) el.addEventListener('change',saveSessionSettings);
  });
  var genBtn=byId('gen-btn'); if(genBtn) genBtn.addEventListener('click',generateAssignments);
  var clearAssignBtn=byId('clear-assign-btn'); if(clearAssignBtn) clearAssignBtn.addEventListener('click',function(){
    var date=S.selectedDate; if(!date) return;
    var sess=getSession(date);
    sess.assignments=null; sess.scores={}; sess.posted=false;
    S.sessions[date]=sess; save(); showToast('Court assignment cleared.'); render();
  });
  var mpBtn=byId('manual-partners-btn'); if(mpBtn) mpBtn.addEventListener('click',openManualPartnersModal);
  var aaOptBtn=byId('aa-options-btn'); if(aaOptBtn) aaOptBtn.addEventListener('click',openAutoAssignOptions);
  var tbBtn=byId('team-battle-btn'); if(tbBtn) tbBtn.addEventListener('click',openTeamBattleSetup);
  var pcaBtn=byId('players-choice-admin-btn'); if(pcaBtn) pcaBtn.addEventListener('click',openPlayersChoiceAdmin);
  var postBtn=byId('post-btn');
  if(postBtn) postBtn.addEventListener('click',function(){
    var date=S.selectedDate; if(!date) return;
    var sess=getSession(date); sess.posted=!sess.posted;
    S.sessions[date]=sess; save();
  });
  document.querySelectorAll('[data-rsvp-pid]').forEach(function(b){
    b.addEventListener('click',function(){
      var pid=parseInt(b.dataset.rsvpPid), status=b.dataset.rsvpStatus;
      if(!S.selectedDate) return;
      var sess=getSession(S.selectedDate);
      sess.rsvps[pid]=status;
      S.sessions[S.selectedDate]=sess; save();
    });
  });
  bindScoreButtons(); bindHighlightSelect();
}

// â”€â”€ ROSTER HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rosterHTML(){
  var h='<div class="card"><h2>ğŸ‘¥ Player Roster</h2>'
    +'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">'
    +'<button class="btn btn-primary" id="add-player-btn">+ Add Player</button>'
    +'<button class="btn btn-secondary" id="sync-btn">Copy from .CSV</button>'
    +'<button class="btn btn-secondary" id="export-btn">Export .CSV</button>'
    +'</div>';
  if(!S.players.length){
    h+='<div class="alert alert-info">No players yet. Add players or import from CSV.</div>';
  } else {
    h+='<table><tr><th>ID</th><th>Name</th><th>USTA</th><th>Member Status</th><th>Fee Paid</th><th>Actions</th></tr>';
    for(var i=0;i<S.players.length;i++){
      var p=S.players[i];
      var ms=p.memberStatus||'Active';
      var msBadge=ms==='Active'?'badge-in':ms==='Inactive'?'badge-out':'';
      h+='<tr><td>'+fmtId(p.id)+'</td><td>'+esc(p.name)+'</td><td>'+esc(p.usta)+'</td>'
        +'<td><span class="badge '+msBadge+'">'+esc(ms)+'</span></td>'
        +'<td>$'+(p.fees||0)+'</td>'
        +'<td style="white-space:nowrap">'
        +'<button class="btn btn-secondary btn-sm" data-edit-pid="'+p.id+'">Edit</button> '
        +'<button class="btn btn-danger btn-sm" data-del-pid="'+p.id+'">Del</button>'
        +'</td></tr>';
    }
    h+='</table>';
  }
  return h+'</div>';
}

// â”€â”€ CALENDAR HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calendarHTML(){
  var s=S.currentSeason, activeArr=S.seasons[s]||[], activeSet={};
  for(var i=0;i<activeArr.length;i++) activeSet[activeArr[i]]=true;
  var now=new Date(), y=now.getFullYear();
  var monthSets={Spring:[[y,2],[y,3],[y,4]],Summer:[[y,5],[y,6],[y,7]],Fall:[[y,8],[y,9],[y,10]],Winter:[[y-1,11],[y,0],[y,1]]};
  var h='<div class="card"><h2>ğŸ“† Season Calendar</h2><div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">';
  for(var si=0;si<SEASONS.length;si++) h+='<button class="season-btn'+(SEASONS[si]===s?' active':'')+'" data-season-btn="'+SEASONS[si]+'">'+SEASONS[si]+'</button>';
  h+='</div><div class="alert alert-info" style="margin-bottom:12px">Click any Saturday to toggle it on/off for the <strong>'+s+'</strong> season.</div>';
  var months=monthSets[s]||[];
  for(var mi=0;mi<months.length;mi++){
    var yr=months[mi][0], mo=months[mi][1];
    h+='<div style="margin-bottom:16px"><div style="font-weight:700;margin-bottom:6px">'+new Date(yr,mo,1).toLocaleString('en-US',{month:'long',year:'numeric'})+'</div><div class="calendar-grid">';
    var dayLabels=['Su','Mo','Tu','We','Th','Fr','Sa'];
    for(var dl=0;dl<7;dl++) h+='<div class="cal-day cal-hdr">'+dayLabels[dl]+'</div>';
    var first=new Date(yr,mo,1).getDay();
    for(var fi=0;fi<first;fi++) h+='<div class="cal-day cal-other"></div>';
    var dim=new Date(yr,mo+1,0).getDate();
    for(var d=1;d<=dim;d++){
      var isSat=new Date(yr,mo,d).getDay()===6;
      var moStr=mo+1<10?'0'+(mo+1):''+(mo+1), dStr=d<10?'0'+d:''+d, key=yr+'-'+moStr+'-'+dStr;
      if(isSat) h+='<div class="cal-day cal-sat'+(activeSet[key]?' active':'')+'" data-cal-date="'+key+'">'+d+'</div>';
      else h+='<div class="cal-day cal-other">'+d+'</div>';
    }
    h+='</div></div>';
  }
  return h+'</div>';
}

// â”€â”€ SESSION HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sessionHTML(){
  var dates=(S.seasons[S.currentSeason]||[]).slice().sort();
  if(!dates.length) return '<div class="card"><h2>âš™ï¸ Session Setup</h2><div class="alert alert-info">No dates scheduled. Add dates in the Calendar tab.</div></div>';
  if(!S.selectedDate||dates.indexOf(S.selectedDate)<0) S.selectedDate=dates[0];
  var date=S.selectedDate, sess=getSession(date), inP=getInPlayers(date), allR=sess.rsvps;
  var ppCourt=sess.type==='singles'?2:4;
  var playPerRound=Math.min(inP.length,sess.courts*ppCourt);
  var activeCourts=Math.floor(playPerRound/ppCourt);
  var rounds=inP.length>=ppCourt?Math.ceil((inP.length*sess.matchesPerPlayer)/Math.max(1,playPerRound)):0;
  var dateOpts='';
  for(var i=0;i<dates.length;i++) dateOpts+='<option value="'+dates[i]+'"'+(dates[i]===date?' selected':'')+'>'+fmtDate(dates[i])+'</option>';
  var rsvpRows='';
  for(var i=0;i<S.players.length;i++){
    var p=S.players[i], st=allR[p.id]||'â€”';
    rsvpRows+='<tr><td>'+fmtId(p.id)+'</td><td>'+esc(p.name)+'</td><td>'+esc(p.usta)+'</td>'
      +'<td><span class="badge '+(st==='IN'?'badge-in':st==='OUT'?'badge-out':'')+'">'+( st==='â€”'?'â€”':st)+'</span></td>'
      +'<td style="white-space:nowrap">'
      +'<button class="btn btn-primary btn-sm" data-rsvp-pid="'+p.id+'" data-rsvp-status="IN">IN</button> '
      +'<button class="btn btn-danger btn-sm" data-rsvp-pid="'+p.id+'" data-rsvp-status="OUT">OUT</button>'
      +'</td></tr>';
  }
  var infoBar=inP.length>=ppCourt
    ?'<div class="alert alert-info">ğŸ“Š <strong>'+inP.length+'</strong> players IN â†’ <strong>'+rounds+'</strong> rounds on <strong>'+activeCourts+'</strong> courts</div>'
    :'<div class="alert alert-warn">Need at least '+ppCourt+' players marked IN to generate assignments.</div>';
  var postBtnHTML=sess.assignments
    ?'<button class="btn '+(sess.posted?'btn-danger':'btn-green')+'" id="post-btn">'+(sess.posted?'Unpost from Users':'Post to Users')+'</button>':'';
  var h='<div class="card"><h2>âš™ï¸ Session Setup</h2>'
    +'<label>Select Date</label><select id="session-date-sel">'+dateOpts+'</select>'
    +'<div class="card" style="border:1.5px solid #e8f5e9"><h2>RSVP List</h2>'
    +(S.players.length
      ?'<table><tr><th>ID</th><th>Name</th><th>USTA</th><th>Status</th><th>Set</th></tr>'+rsvpRows+'</table>'
       +'<div style="margin-top:8px;font-weight:700;color:#1a5c2a">IN: '+inP.length+' players</div>'
      :'<div class="alert alert-info">No players in roster.</div>')
    +'</div>'
    +'<div class="card" style="border:1.5px solid #e8f5e9"><h2>Settings</h2>'
    +'<div class="form-row">'
    +'<div><label>Match Type</label><select id="s-type"><option value="singles"'+(sess.type==='singles'?' selected':'')+'>Singles</option><option value="doubles"'+(sess.type==='doubles'?' selected':'')+'>Doubles</option></select></div>'
    +'<div id="rot-wrap"'+(sess.type==='singles'?' style="display:none"':'')+'><label>Mode</label><select id="s-rotate">'+'<option value="0"'+(!sess.rotatePartners&&!sess.manualPartners&&!sess.teamBattle&&!sess.playersChoice?' selected':'')+'>AutoAssign: same partner</option>'+'<option value="1"'+(sess.rotatePartners&&!sess.teamBattle&&!sess.playersChoice?' selected':'')+'>AutoAssign: reassign each round</option>'+'<option value="manual"'+(sess.manualPartners&&!sess.teamBattle&&!sess.playersChoice?' selected':'')+'>Manual (Admin assigns)</option>'+'<option value="teamBattle"'+(sess.teamBattle?' selected':'')+'>Team Battle (A vs B)</option>'+'<option value="playersChoice"'+(sess.playersChoice?' selected':'')+'>Players Choice</option>'+'</select></div>'
    +'</div><div class="form-row">'
    +'<div><label>Courts Available</label><input id="s-courts" type="number" min="1" max="20" value="'+sess.courts+'"></div>'
    +'<div><label>Matches per Player (1â€“8)</label><input id="s-matches" type="number" min="1" max="8" value="'+sess.matchesPerPlayer+'"></div>'
    +'</div>'+infoBar+'</div>'
    +'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">'
    +'<button class="btn btn-primary" id="gen-btn">ğŸ¾ Generate Court Assignment</button>'
    +(sess.assignments?'<button class="btn btn-danger" id="clear-assign-btn">ğŸ—‘ Clear Assignment</button>':'')
    +(!sess.teamBattle&&!sess.playersChoice&&sess.type!=='singles'?'<button class="btn btn-secondary" id="aa-options-btn">âš™ï¸ AutoAssign Options</button>':'')
    +(sess.type!=='singles'?'<button class="btn btn-secondary" id="manual-partners-btn">âœ‹ Manually Assign Partners</button>':'')
    +(sess.teamBattle?'<button class="btn btn-secondary" id="team-battle-btn">âš”ï¸ Setup Team Battle</button>':'')
    +(sess.playersChoice?'<button class="btn btn-secondary" id="players-choice-admin-btn">ğŸ“‹ Submissions</button>':'')
    +postBtnHTML+'</div>';
  if(sess.assignments){
    var inp2=getInPlayers(date), hlOpts='<option value="">-- Select your name --</option>';
    for(var i=0;i<inp2.length;i++) hlOpts+='<option value="'+inp2[i].id+'">'+fmtId(inp2[i].id)+' - '+esc(inp2[i].name)+'</option>';
    h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">'
      +'<strong style="color:#1a5c2a">Assignment Preview</strong>'
      +'<span class="badge '+(sess.posted?'badge-in':'badge-out')+'">'+(sess.posted?'POSTED':'NOT POSTED')+'</span></div>'
      +'<div style="background:#fffde7;border:1.5px solid #f5a623;border-radius:8px;padding:8px 12px;margin-bottom:12px">'
      +'<label>ğŸ” Highlight My Matches</label><select id="hl-sel">'+hlOpts+'</select></div>'
      +'<div id="rounds-display">'+roundsHTML(sess,date,null)+'</div>';
  }
  if(sess.playersChoice){
    h+='<div id="pc-court-grid">'+playersChoiceCourtGrid(sess,date,true)+'</div>';
  }
  return h+'</div>';
}
function saveSessionSettings(){
  var date=S.selectedDate; if(!date) return;
  var sess=getSession(date);
  var t=byId('s-type'),r=byId('s-rotate'),c=byId('s-courts'),m=byId('s-matches');
  if(t) sess.type=t.value;
  if(r){
    var prevMode=[sess.rotatePartners,sess.manualPartners,sess.teamBattle,sess.playersChoice].join(',');
    sess.rotatePartners=(r.value==='1');
    sess.manualPartners=(r.value==='manual');
    sess.teamBattle=(r.value==='teamBattle');
    sess.playersChoice=(r.value==='playersChoice');
    var newMode=[sess.rotatePartners,sess.manualPartners,sess.teamBattle,sess.playersChoice].join(',');
    if(prevMode!==newMode && sess.assignments){
      sess.assignments=null; sess.scores={}; sess.posted=false;
      showToast('Mode changed â€” court assignment cleared.');
    }
  }
  if(c) sess.courts=Math.max(1,parseInt(c.value)||4);
  if(m) sess.matchesPerPlayer=Math.min(8,Math.max(1,parseInt(m.value)||4));
  var wrap=byId('rot-wrap'); if(wrap) wrap.style.display=(sess.type==='singles'?'none':'block');
  S.sessions[date]=sess; save();
}

// â”€â”€ BYES HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ STATS HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPlayerStats(pid, season){
  if(!S.playerStats) S.playerStats={};
  if(!S.playerStats[pid]) S.playerStats[pid]={};
  if(!S.playerStats[pid][season]) S.playerStats[pid][season]={wins:0,losses:0,gamesWon:0,gamesLost:0};
  return S.playerStats[pid][season];
}

// Rebuild all stats for a season from scratch based on all saved scores
function rebuildSeasonStats(season){
  if(!S.playerStats) S.playerStats={};

  // Clear existing match stats AND attendance for this season
  for(var pid in S.playerStats){
    if(S.playerStats[pid][season]) delete S.playerStats[pid][season];
    if(S.playerStats[pid][season+'_att'] !== undefined) S.playerStats[pid][season+'_att']=0;
  }

  var dates = S.seasons[season] || [];
  for(var di=0; di<dates.length; di++){
    var date = dates[di];
    var sess = S.sessions[date];
    if(!sess || !sess.assignments) continue;

    // Attendance: count each IN player once per session IF any score exists for that date
    var scores = sess.scores || {};
    var hasAnyScore = false;
    var scoreKeys = Object.keys(scores);
    for(var ski=0; ski<scoreKeys.length; ski++){
      var skv = scores[scoreKeys[ski]];
      if(skv && skv.t1!=='' && skv.t2!=='') { hasAnyScore=true; break; }
    }
    if(hasAnyScore){
      var rsvps = sess.rsvps || {};
      for(var rpid in rsvps){
        if(rsvps[rpid]==='IN'){
          var rpidInt = parseInt(rpid);
          if(!S.playerStats[rpidInt]) S.playerStats[rpidInt]={};
          S.playerStats[rpidInt][season+'_att'] = (S.playerStats[rpidInt][season+'_att']||0) + 1;
        }
      }
    }

    // Match/game stats from scores
    if(!sess.scores) continue;
    var rounds = sess.assignments.rounds || [];
    for(var ri=0; ri<rounds.length; ri++){
      var round = rounds[ri];
      if(!round || !round.courts) continue;
      for(var ci=0; ci<round.courts.length; ci++){
        var court = round.courts[ci];
        if(!court || !court.teams || court.teams.length < 2) continue;
        var key = ri+'_'+ci;
        var sc = sess.scores[key];
        if(!sc || sc.t1==='' || sc.t2==='') continue;
        var s1=parseInt(sc.t1), s2=parseInt(sc.t2);
        if(isNaN(s1)||isNaN(s2)) continue;
        var team1 = court.teams[0] || [], team2 = court.teams[1] || [];
        var t1wins = s1 > s2, t2wins = s2 > s1;
        for(var pi=0; pi<team1.length; pi++){
          var st = getPlayerStats(team1[pi], season);
          if(t1wins) st.wins++; else if(t2wins) st.losses++;
          st.gamesWon += s1; st.gamesLost += s2;
        }
        for(var pi2=0; pi2<team2.length; pi2++){
          var st2 = getPlayerStats(team2[pi2], season);
          if(t2wins) st2.wins++; else if(t1wins) st2.losses++;
          st2.gamesWon += s2; st2.gamesLost += s1;
        }
      }
    }
  }
}

function calcTotalPoints(pid, season){
  if(!S.pointsConfig) S.pointsConfig={matchWin:3,gameWin:1,attendance:1};
  var cfg=S.pointsConfig;
  var st=getPlayerStats(pid,season);
  var att=(S.playerStats[pid]||{})[season+'_att']||0;
  return st.wins*cfg.matchWin + st.gamesWon*cfg.gameWin + att*cfg.attendance;
}

function byesHTML(){
  var season = S.currentSeason;
  if(!S.playerStats) S.playerStats={};
  if(!S.pointsConfig) S.pointsConfig={matchWin:3,gameWin:1,attendance:1};
  var cfg=S.pointsConfig;
  var isAdmin=S.isAdmin;

  var h = '<div class="card"><h2>ğŸ“Š Season Stats â€” '+season+'</h2>';

  // Points config (admin only)
  if(isAdmin){
    h += '<div class="card" style="border:1.5px solid #e8f5e9;margin-bottom:12px">'      +'<h2>âš™ï¸ Points Configuration</h2>'      +'<div class="form-row">'      +'<div><label>Points per Match Win</label><input id="cfg-match-win" type="number" min="0" value="'+cfg.matchWin+'"></div>'      +'<div><label>Points per Game Won</label><input id="cfg-game-win" type="number" min="0" value="'+cfg.gameWin+'"></div>'      +'<div><label>Points per Session Attended</label><input id="cfg-att" type="number" min="0" value="'+cfg.attendance+'"></div>'      +'</div>'      +'<button class="btn btn-green btn-sm" id="cfg-save-btn" style="margin-top:4px">Save Config</button>'      +'</div>';
  }

  if(isAdmin){
    h += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">'      +'<button class="btn btn-secondary" id="import-stats-btn">Import Stats .CSV</button>'      +'<button class="btn btn-secondary" id="export-stats-btn">Export Stats .CSV</button>'      +'<button class="btn btn-secondary" id="att-btn">Mark Attendance</button>'      +'</div>';
  }

  if(!S.players.length){
    return h+'<div class="alert alert-info">No players in roster.</div></div>';
  }

  // Build rows
  var rows = S.players.map(function(p){
    var bc = (S.byeCounts[p.id]||{})[season]||0;
    var st = getPlayerStats(p.id, season);
    var att=(S.playerStats[p.id]||{})[season+'_att']||0;
    var total = st.wins + st.losses;
    var winPct = total > 0 ? Math.round((st.wins/total)*100) : null;
    var pts = calcTotalPoints(p.id, season);
    return { p:p, byes:bc, wins:st.wins, losses:st.losses, gamesWon:st.gamesWon, gamesLost:st.gamesLost, winPct:winPct, total:total, att:att, pts:pts };
  });

  rows.sort(function(a,b){
    if(b.pts !== a.pts) return b.pts - a.pts;
    if(b.wins !== a.wins) return b.wins - a.wins;
    return b.gamesWon - a.gamesWon;
  });

  h += '<div class="sticky-table-wrap">';
  h += '<table><tr><th>#</th><th>Name</th><th>Pts</th><th>M Won</th><th>M Lost</th><th>Win%</th><th>G Won</th><th>G Lost</th><th>Att</th><th>Byes</th></tr>';
  for(var i=0; i<rows.length; i++){
    var r = rows[i];
    var winPctStr = r.winPct !== null ? r.winPct+'%' : 'â€”';
    var medal = i===0&&r.total>0 ? 'ğŸ¥‡ ' : i===1&&r.total>0 ? 'ğŸ¥ˆ ' : i===2&&r.total>0 ? 'ğŸ¥‰ ' : '';
    h += '<tr>'      +'<td style="color:#888;font-size:.8rem">'+(i+1)+'</td>'      +'<td><strong>'+medal+esc(r.p.name)+'</strong></td>'      +'<td><span class="pts-badge">'+r.pts+'</span></td>'      +'<td style="color:#155724;font-weight:700">'+r.wins+'</td>'      +'<td style="color:#721c24">'+r.losses+'</td>'      +'<td><span style="background:'+(r.winPct===null?'#eee':r.winPct>=50?'#d4edda':'#f8d7da')+';padding:2px 7px;border-radius:10px;font-size:.8rem;font-weight:700">'+winPctStr+'</span></td>'      +'<td>'+r.gamesWon+'</td>'      +'<td>'+r.gamesLost+'</td>'      +'<td>'+r.att+'</td>'      +'<td style="color:#856404">'+r.byes+'</td>'      +'</tr>';
  }
  h += '</table></div>';

  var totalMatches=0, totalScored=0;
  rows.forEach(function(r){ totalMatches+=r.total; totalScored+=r.gamesWon; });
  if(totalMatches>0){
    h += '<div style="margin-top:10px;font-size:.82rem;color:#666">'      +Math.round(totalMatches/2)+' matches recorded Â· '+totalScored+' total games this season</div>';
  }

  return h+'</div>';
}



// â”€â”€ AUTOASSIGN OPTIONS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAutoAssignOptions(){
  var date=S.selectedDate; if(!date){ showToast('No date selected.'); return; }
  var sess=getSession(date);
  var inP=getInPlayers(date);
  if(!inP.length){ showToast('No players marked IN.'); return; }
  var lockedTeams=sess.lockedTeams||[];
  var noByePids=sess.noByePids||[];
  var ppCourt=sess.type==='singles'?2:4;
  var half=ppCourt/2; // players per team = 2 for doubles, 1 for singles

  // Build player options
  var pOpts='<option value="">â€” select â€”</option>';
  for(var i=0;i<inP.length;i++) pOpts+='<option value="'+inP[i].id+'">'+fmtId(inP[i].id)+' '+esc(inP[i].name)+'</option>';

  // Render locked teams rows
  function lockedRows(){
    var h='';
    for(var li=0;li<lockedTeams.length;li++){
      var lt=lockedTeams[li];
      var names=lt.map(function(id){ var p=getPlayer(id); return p?esc(p.name):fmtId(id); }).join(' & ');
      h+='<div class="locked-row" style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid #eee">'+
        '<span style="flex:1;font-size:.88rem">ğŸ”’ '+names+'</span>'+
        '<button class="btn btn-danger btn-sm locked-del-btn" data-li="'+li+'">âœ•</button>'+
        '</div>';
    }
    return h||'<div style="color:#aaa;font-size:.82rem;padding:4px 0">No locked teams yet.</div>';
  }

  // No-bye checkboxes
  function noByeChecks(){
    var h='';
    for(var i=0;i<inP.length;i++){
      var checked=noByePids.indexOf(inP[i].id)>=0;
      h+='<label style="display:flex;align-items:center;gap:8px;padding:3px 0;cursor:pointer">'+
        '<input type="checkbox" class="no-bye-chk" value="'+inP[i].id+'"'+(checked?' checked':'')+' style="width:15px;height:15px"> '+
        '<span style="font-size:.88rem">'+fmtId(inP[i].id)+' '+esc(inP[i].name)+'</span>'+
        '</label>';
    }
    return h;
  }

  // Build add-locked-team selects (one per slot in a team)
  function addLockedSelects(){
    var hh='<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">';
    for(var si2=0;si2<half;si2++){
      hh+='<select id="lt-p'+si2+'" style="padding:6px;flex:1;border-radius:6px;border:1.5px solid #ccc">'+pOpts+'</select>';
    }
    hh+='<button class="btn btn-green btn-sm" id="lt-add-btn">+ Add</button></div>';
    return hh;
  }

  var body='<h3>âš™ï¸ AutoAssign Options</h3>';

  // Locked teams section
  body+='<div style="margin-bottom:16px">'+
    '<div style="font-weight:700;margin-bottom:6px">ğŸ”’ Locked Teams (stay together all rounds)</div>'+
    '<div id="locked-rows-wrap">'+lockedRows()+'</div>'+
    '<div style="margin-top:8px"><label style="font-size:.8rem">Add locked team ('+half+' players):</label>'+addLockedSelects()+'</div>'+
    '</div>';

  // No-bye section (early leave protection - multi-select)
  body+='<div style="margin-bottom:16px">'+
    '<div style="font-weight:700;margin-bottom:4px">âš¡ Early Leave Protection</div>'+
    '<div style="font-size:.8rem;color:#555;margin-bottom:8px">Selected players will never sit out a round. Tap to toggle.</div>'+
    '<div id="no-bye-btns" style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;border:1px solid #eee;border-radius:8px">';
  for(var i=0;i<inP.length;i++){
    var checked=noByePids.indexOf(inP[i].id)>=0;
    body+='<button type="button" class="no-bye-toggle-btn" data-pid="'+inP[i].id+'" style="padding:5px 12px;border-radius:20px;border:2px solid '+(checked?'#e67e00':'#ccc')+';background:'+(checked?'#fff3cd':'#fff')+';color:'+(checked?'#7d4a00':'#444')+';font-weight:'+(checked?'700':'400')+';font-size:.82rem;cursor:pointer;transition:all .15s">'+
      (checked?'âš¡ ':'')+fmtId(inP[i].id)+' '+esc(inP[i].name)+
      '</button>';
  }
  body+='</div></div>';

  body+='<div class="modal-btns">'+
    '<button class="btn btn-secondary" id="m-cancel">Cancel</button>'+
    '<button class="btn btn-primary" id="aa-opts-save">Save Options</button>'+
    '</div>';

  showModal(body,true);

  byId('m-cancel').addEventListener('click',closeModal);

  // Toggle early leave protection buttons
  function bindNoByeToggleBtns(){
    document.querySelectorAll('.no-bye-toggle-btn').forEach(function(btn){
      btn.addEventListener('click',function(){
        var pid=parseInt(btn.dataset.pid);
        var idx=noByePids.indexOf(pid);
        if(idx>=0){ noByePids.splice(idx,1); }
        else { noByePids.push(pid); }
        var active=noByePids.indexOf(pid)>=0;
        btn.style.border='2px solid '+(active?'#e67e00':'#ccc');
        btn.style.background=active?'#fff3cd':'#fff';
        btn.style.color=active?'#7d4a00':'#444';
        btn.style.fontWeight=active?'700':'400';
        btn.textContent=(active?'âš¡ ':'')+fmtId(pid)+' '+(getPlayer(pid)?esc(getPlayer(pid).name):fmtId(pid));
      });
    });
  }
  bindNoByeToggleBtns();
  function bindLockedDelBtns(){
    document.querySelectorAll('.locked-del-btn').forEach(function(btn){
      btn.addEventListener('click',function(){
        var li=parseInt(btn.dataset.li);
        lockedTeams.splice(li,1);
        byId('locked-rows-wrap').innerHTML=lockedRows();
        bindLockedDelBtns();
        bindNoByeToggleBtns();
      });
    });
  }
  bindLockedDelBtns();

  // Add locked team
  byId('lt-add-btn').addEventListener('click',function(){
    var ids=[];
    for(var si3=0;si3<half;si3++){
      var selEl=byId('lt-p'+si3);
      if(selEl&&parseInt(selEl.value)) ids.push(parseInt(selEl.value));
    }
    if(ids.length<2){ showToast('Select '+half+' different players.'); return; }
    if(new Set(ids).size!==ids.length){ showToast('Please select different players.'); return; }
    lockedTeams.push(ids);
    byId('locked-rows-wrap').innerHTML=lockedRows();
    bindLockedDelBtns();
    for(var si4=0;si4<half;si4++){ var selEl2=byId('lt-p'+si4); if(selEl2) selEl2.value=''; }
  });

  // Save
  byId('aa-opts-save').addEventListener('click',function(){
    // noByePids is already tracked in the local array via toggle buttons
    sess.lockedTeams=lockedTeams;
    sess.noByePids=noByePids;
    S.sessions[date]=sess; save(); closeModal(); showToast('AutoAssign options saved!');
  });
}

// â”€â”€ ASSIGNMENT ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateAssignments(){
  var date=S.selectedDate; if(!date){ showToast('No date selected.'); return; }
  var sess=getSession(date);
  // Dispatch to mode-specific generators
  if(sess.teamBattle){
    if(!(sess.teamA&&sess.teamA.length)&&!(sess.teamB&&sess.teamB.length)){
      showToast('Set up teams first using the âš”ï¸ Setup Team Battle button.');
      return;
    }
    generateTeamBattleAssignments(date, sess);
    showToast('Team Battle assignments generated!');
    render();
    return;
  }
  var inP=getInPlayers(date), ppCourt=sess.type==='singles'?2:4;
  if(inP.length<ppCourt){ showToast('Need at least '+ppCourt+' players marked IN.'); return; }
  var numCourts=sess.courts, mpp=sess.matchesPerPlayer;
  var playPerRound=Math.min(inP.length,numCourts*ppCourt), activeCourts=Math.floor(playPerRound/ppCourt);
  var totalRounds=Math.ceil((inP.length*mpp)/Math.max(1,playPerRound));

  // Session options
  var lockedTeams=sess.lockedTeams||[];   // array of [pid,pid] pairs
  var noByePids=sess.noByePids||[];       // array of pids that must never sit out
  var rotate=sess.rotatePartners;         // true = new partners each round

  // Validate noByePids don't conflict with bye math
  var need=inP.length-activeCourts*ppCourt;
  if(need>0){
    showToast('Note: '+need+' player'+(need>1?'s':'')+' will sit out each round (byes needed due to player count).');
  }

  // Build sorted pool; locked-team members stay as units
  var sorted=inP.slice().sort(function(a,b){ return parseFloat(b.usta)-parseFloat(a.usta); });
  if(!S.byeCounts) S.byeCounts={};
  for(var i=0;i<sorted.length;i++) if(!S.byeCounts[sorted[i].id]) S.byeCounts[sorted[i].id]={};
  var seasonByes={};
  for(var i=0;i<sorted.length;i++) seasonByes[sorted[i].id]=(S.byeCounts[sorted[i].id][S.currentSeason])||0;
  var playCounts={}, todayByes={};
  for(var i=0;i<sorted.length;i++){ playCounts[sorted[i].id]=0; todayByes[sorted[i].id]=0; }

  // Build set of locked-team members (for rotation logic)
  var lockedMemberOf={};
  for(var li=0;li<lockedTeams.length;li++){
    var lt=lockedTeams[li];
    for(var lj=0;lj<lt.length;lj++) lockedMemberOf[lt[lj]]=li;
  }

  var allRounds=[];
  // Track partner/opponent history to avoid rematches
  var lastPartner={};
  var opponentHistory={}; // opponentHistory[pid][oppPid] = number of times faced
  var partnerHistory={};  // partnerHistory[pid][partPid] = number of times partnered
  for(var i=0;i<sorted.length;i++){
    opponentHistory[sorted[i].id]={};
    partnerHistory[sorted[i].id]={};
  }

  for(var r=0;r<totalRounds;r++){
    // --- Determine byes (never put noByePids on bye if avoidable) ---
    var byeCount=inP.length-activeCourts*ppCourt;
    var byes=[];
    if(byeCount>0){
      // candidates: prefer NOT noByePids and those with fewest today byes
      var byeCandidates=sorted.slice().sort(function(a,b){
        var aNoBye=noByePids.indexOf(a.id)>=0?1:0;
        var bNoBye=noByePids.indexOf(b.id)>=0?1:0;
        if(aNoBye!==bNoBye) return aNoBye-bNoBye; // push noByePids to end
        var d=(seasonByes[a.id]||0)-(seasonByes[b.id]||0);
        return d!==0?d:playCounts[b.id]-playCounts[a.id];
      });
      // Collect byes respecting locked teams (whole locked team sits if one sits)
      var byeSet={};
      for(var bi=0;bi<byeCandidates.length&&Object.keys(byeSet).length<byeCount;bi++){
        var cid=byeCandidates[bi].id;
        if(byeSet[cid]) continue;
        var ltIdx=lockedMemberOf[cid];
        if(ltIdx!==undefined){
          // bye the whole locked team together
          var lt=lockedTeams[ltIdx];
          var wouldBye=Object.keys(byeSet).length+lt.length;
          if(wouldBye<=byeCount){ for(var lj=0;lj<lt.length;lj++) byeSet[lt[lj]]=true; }
        } else {
          byeSet[cid]=true;
        }
      }
      byes=Object.keys(byeSet).map(Number);
    }

    var playing=sorted.filter(function(p){ return byes.indexOf(p.id)<0; });

    var roundCourts;
    if(!rotate){
      // Same partner mode â€” same pairs throughout, but avoid opponent rematches
      roundCourts=assignCourtsWithLocked(playing, activeCourts, ppCourt, lockedTeams, null, opponentHistory, partnerHistory);
    } else {
      // Rotate mode â€” try to give each player a different partner AND opponent than previous rounds
      roundCourts=assignCourtsWithLocked(playing, activeCourts, ppCourt, lockedTeams, lastPartner, opponentHistory, partnerHistory);
    }
    // Update history tracking for next round
    for(var ci=0;ci<roundCourts.length;ci++){
      var ct=roundCourts[ci];
      var t0=ct.teams[0]||[], t1=ct.teams[1]||[];
      // Partner history
      for(var pi=0;pi<t0.length;pi++) for(var pi2=0;pi2<t0.length;pi2++){
        if(pi!==pi2){ partnerHistory[t0[pi]][t0[pi2]]=(partnerHistory[t0[pi]][t0[pi2]]||0)+1; }
      }
      for(var pi=0;pi<t1.length;pi++) for(var pi2=0;pi2<t1.length;pi2++){
        if(pi!==pi2){ partnerHistory[t1[pi]][t1[pi2]]=(partnerHistory[t1[pi]][t1[pi2]]||0)+1; }
      }
      // Opponent history
      for(var pi=0;pi<t0.length;pi++) for(var pi2=0;pi2<t1.length;pi2++){
        opponentHistory[t0[pi]][t1[pi2]]=(opponentHistory[t0[pi]][t1[pi2]]||0)+1;
        opponentHistory[t1[pi2]][t0[pi]]=(opponentHistory[t1[pi2]][t0[pi]]||0)+1;
      }
      // Update lastPartner for rotate mode
      if(rotate){
        for(var pi=0;pi<t0.length;pi++) for(var pi2=0;pi2<t0.length;pi2++){
          if(pi!==pi2) lastPartner[t0[pi]]=t0[pi2];
        }
        for(var pi=0;pi<t1.length;pi++) for(var pi2=0;pi2<t1.length;pi2++){
          if(pi!==pi2) lastPartner[t1[pi]]=t1[pi2];
        }
      }
    }

    allRounds.push({courts:roundCourts, byes:byes});
    for(var bi=0;bi<byes.length;bi++){ todayByes[byes[bi]]++; seasonByes[byes[bi]]=(seasonByes[byes[bi]]||0)+1; }
    for(var pi=0;pi<playing.length;pi++) playCounts[playing[pi].id]++;
  }

  for(var i=0;i<sorted.length;i++){
    S.byeCounts[sorted[i].id][S.currentSeason]=seasonByes[sorted[i].id]||0;
  }
  sess.assignments={rounds:allRounds}; sess.scores={}; sess.posted=false;
  S.sessions[date]=sess; save(); showToast('Assignments generated!');
}

function assignCourtsWithLocked(playing, numCourts, ppCourt, lockedTeams, lastPartner, opponentHistory, partnerHistory){
  opponentHistory = opponentHistory || {};
  partnerHistory = partnerHistory || {};
  // Build "units" â€” locked teams travel as one unit, singles as individuals
  var units=[], usedInUnit={};
  for(var li=0;li<lockedTeams.length;li++){
    var lt=lockedTeams[li];
    var allPlaying=true;
    for(var lj=0;lj<lt.length;lj++) if(!playing.some(function(p){ return p.id===lt[lj]; })){ allPlaying=false; break; }
    if(allPlaying){
      for(var lj=0;lj<lt.length;lj++) usedInUnit[lt[lj]]=true;
      units.push({ids:lt, avgUsta: lt.reduce(function(s,id){ var p=playing.find(function(p){ return p.id===id; }); return s+(p?parseFloat(p.usta):3.0); },0)/lt.length, locked:true});
    }
  }
  for(var i=0;i<playing.length;i++){
    if(!usedInUnit[playing[i].id]) units.push({ids:[playing[i].id], avgUsta:parseFloat(playing[i].usta)||3.0, locked:false});
  }
  units.sort(function(a,b){ return b.avgUsta-a.avgUsta; });

  // If rotating or same-partner mode, shuffle free units to vary opponents
  if(lastPartner !== null || opponentHistory){
    var lockedUnits=units.filter(function(u){ return u.locked; });
    var freeUnits=units.filter(function(u){ return !u.locked; });
    // Fisher-Yates shuffle free units for variety
    for(var i=freeUnits.length-1;i>0;i--){
      var j=Math.floor(Math.random()*(i+1));
      var tmp=freeUnits[i]; freeUnits[i]=freeUnits[j]; freeUnits[j]=tmp;
    }
    // Re-sort by usta to keep balance
    freeUnits.sort(function(a,b){ return b.avgUsta-a.avgUsta; });
    units=lockedUnits.concat(freeUnits);
  }

  // Pack units into courts: pair top half vs bottom half by usta
  var courts=[];
  var half=Math.floor(units.length/2);
  var top=units.slice(0,half), bot=units.slice(half).reverse();
  var pairsPerCourt=ppCourt/2;

  // Build all possible unit pairings (top[i] partnered with adjacent top to form a team)
  // For doubles: pair consecutive units within top half as team1, consecutive in bot half as team2
  // Then choose court pairings that minimize opponent repeats

  // Build raw team pairs: each "team" is 2 units merged for doubles, 1 unit for singles
  var topTeams=[], botTeams=[];
  if(ppCourt===4){
    // Pair consecutive units into teams of 2
    for(var i=0;i+1<top.length;i+=2){
      var ids=top[i].ids.concat(top[i+1].ids);
      // Prefer partner pairs with fewest prior encounters
      var score=0;
      for(var a=0;a<top[i].ids.length;a++) for(var b=0;b<top[i+1].ids.length;b++)
        score+=(partnerHistory[top[i].ids[a]]||{})[top[i+1].ids[b]]||0;
      topTeams.push({ids:ids, score:score});
    }
    for(var i=0;i+1<bot.length;i+=2){
      var ids=bot[i].ids.concat(bot[i+1].ids);
      var score=0;
      for(var a=0;a<bot[i].ids.length;a++) for(var b=0;b<bot[i+1].ids.length;b++)
        score+=(partnerHistory[bot[i].ids[a]]||{})[bot[i+1].ids[b]]||0;
      botTeams.push({ids:ids, score:score});
    }
  } else {
    // Singles: each unit is already a single player
    for(var i=0;i<top.length;i++) topTeams.push({ids:top[i].ids, score:0});
    for(var i=0;i<bot.length;i++) botTeams.push({ids:bot[i].ids, score:0});
  }

  // Now pair topTeams vs botTeams to form courts, minimizing opponent repeats
  // Simple greedy: for each top team, find best bot team match with fewest prior opponent encounters
  var usedBot={};
  for(var i=0;i<numCourts&&i<topTeams.length;i++){
    var tTeam=topTeams[i];
    var bestBot=-1, bestScore=Infinity;
    for(var j=0;j<botTeams.length;j++){
      if(usedBot[j]) continue;
      var oppScore=0;
      for(var a=0;a<tTeam.ids.length;a++) for(var b=0;b<botTeams[j].ids.length;b++)
        oppScore+=(opponentHistory[tTeam.ids[a]]||{})[botTeams[j].ids[b]]||0;
      if(oppScore<bestScore){ bestScore=oppScore; bestBot=j; }
    }
    if(bestBot<0) break;
    usedBot[bestBot]=true;
    var team1=tTeam.ids, team2=botTeams[bestBot].ids;
    if(team1.length>0&&team2.length>0) courts.push({teams:[team1,team2]});
  }
  return courts;
}
function assignCourts(players,numCourts,ppCourt){
  var sorted=players.slice().sort(function(a,b){ return parseFloat(b.usta)-parseFloat(a.usta); }), courts=[];
  if(ppCourt===2){
    for(var i=0;i<numCourts&&i<Math.floor(sorted.length/2);i++)
      courts.push({teams:[[sorted[i].id],[sorted[sorted.length-1-i].id]]});
  } else {
    var half=Math.floor(sorted.length/2), top=sorted.slice(0,half), bot=sorted.slice(half).reverse(), teams=[];
    for(var i=0;i<Math.min(top.length,bot.length);i++) teams.push([top[i].id,bot[i].id]);
    var n=teams.length;
    for(var i=0;i<numCourts&&i<Math.floor(n/2);i++) courts.push({teams:[teams[i],teams[n-1-i]]});
  }
  return courts;
}

// â”€â”€ PLAYER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPlayerModal(id){
  var p=(id!==null)?getPlayer(id):null, ratings=['2.0','2.5','3.0','3.5','4.0','4.5','5.0'], ustaOpts='';
  for(var i=0;i<ratings.length;i++) ustaOpts+='<option'+(p&&p.usta===ratings[i]?' selected':'')+'>'+ratings[i]+'</option>';
  var curStatus=p?(p.memberStatus||'Active'):'Active';
  var statusOpts=['Active','Inactive','Guest'].map(function(s){ return '<option'+(curStatus===s?' selected':'')+'>'+s+'</option>'; }).join('');
  showModal('<h3>'+(p?'Edit':'Add')+' Player</h3>'
    +'<label>Name</label><input id="m-name" value="'+(p?esc(p.name):'')+'" placeholder="Full name">'
    +'<label>USTA Rating</label><select id="m-usta">'+ustaOpts+'</select>'
    +'<label>Member Status</label><select id="m-status">'+statusOpts+'</select>'
    +'<label>Fee Paid ($)</label><input id="m-fees" type="number" min="0" value="'+(p?p.fees||0:0)+'">'
    +'<div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Cancel</button><button class="btn btn-primary" id="m-save">'+(p?'Save':'Add')+'</button></div>');
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-save').addEventListener('click',function(){
    var name=byId('m-name').value.trim(), usta=byId('m-usta').value, fees=parseFloat(byId('m-fees').value)||0, memberStatus=byId('m-status').value||'Active';
    if(!name){ showToast('Name is required.'); return; }
    if(id!==null){ var px=getPlayer(id); if(px){ px.name=name; px.usta=usta; px.fees=fees; px.memberStatus=memberStatus; } }
    else {
      var used={};
      for(var i=0;i<S.players.length;i++) used[S.players[i].id]=true;
      var nid=1; while(used[nid]&&nid<1000) nid++;
      S.players.push({id:nid,name:name,usta:usta,fees:fees,memberStatus:memberStatus});
    }
    save(); closeModal();
  });
}

// â”€â”€ CSV IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSheetSync(){
  showModal('<h3>ğŸ“‹ Copy from .CSV</h3>'
    +'<div class="alert alert-info" style="margin-bottom:10px">'
    +'<strong>How to import:</strong><br>1. Open your CSV file in Excel or Google Sheets<br>2. Select all data including header row (Ctrl+A)<br>3. Copy (Ctrl+C)<br>4. Paste below and click Import<br><br>'
    +'Column order: <strong>Player ID, Name, USTA Rating, Member Status, Fee Paid</strong></div>'
    +'<label>Paste CSV Data</label>'
    +'<textarea id="m-csv" rows="10" placeholder="Player ID&#9;Name&#9;USTA Rating&#9;Member Status&#9;Fee Paid&#10;1&#9;John Smith&#9;3.5&#9;Active&#9;150"></textarea>'
    +'<div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Cancel</button><button class="btn btn-primary" id="m-sync">Import</button></div>');
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-sync').addEventListener('click',function(){
    var raw=byId('m-csv').value.trim();
    if(!raw){ showToast('Please paste your CSV data.'); return; }
    var delim=raw.split('\n')[0].indexOf('\t')>=0?'\t':',';
    var rows=parseDelimited(raw,delim);
    if(!rows.length){ showToast('No data rows found. Make sure you included a header row.'); return; }
    var result=importRows(rows);
    save(); closeModal();
    showToast('Import complete! Added: '+result.added+'  Updated: '+result.updated+'  Skipped: '+result.skipped);
  });
}
function parseDelimited(text,delim){
  var lines=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').trim().split('\n'), rows=[];
  for(var i=1;i<lines.length;i++){
    var line=lines[i].trim(); if(!line) continue;
    var cols=line.split(delim);
    for(var j=0;j<cols.length;j++) cols[j]=cols[j].trim().replace(/^"|"$/g,'');
    rows.push(cols);
  }
  return rows;
}
function importRows(rows){
  var added=0,updated=0,skipped=0;
  for(var i=0;i<rows.length;i++){
    var row=rows[i]; if(row.length<2){ skipped++; continue; }
    var pid=parseInt(row[0]),name=(row[1]||'').trim(),usta=(row[2]||'3.0').trim();
    var memberStatus=(row[3]||'Active').trim()||'Active';
    var fees=parseFloat(row[4])||0;
    if(!pid||!name){ skipped++; continue; }
    var ex=getPlayer(pid);
    if(ex){ ex.name=name; ex.usta=usta; ex.memberStatus=memberStatus; ex.fees=fees; updated++; }
    else { S.players.push({id:pid,name:name,usta:usta,memberStatus:memberStatus,fees:fees}); added++; }
  }
  return{added:added,updated:updated,skipped:skipped};
}

// â”€â”€ CSV EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV(){
  if(!S.players.length){ showToast('No players to export.'); return; }
  var rows=[['Player ID','Name','USTA Rating','Member Status','Fee Paid']];
  for(var i=0;i<S.players.length;i++){ var p=S.players[i]; rows.push([fmtId(p.id),p.name,p.usta,p.memberStatus||'Active',p.fees||0]); }
  var csv='';
  for(var i=0;i<rows.length;i++){
    var cols=[]; for(var j=0;j<rows[i].length;j++) cols.push('"'+String(rows[i][j]).replace(/"/g,'""')+'"');
    csv+=cols.join(',')+'\r\n';
  }
  try{
    var blob=new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob), a=document.createElement('a');
    a.href=url; a.download='dmv_tennis_roster.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    showToast('Roster exported!');
  }catch(e){ showToast('Export not supported in this browser.'); }
}


// â”€â”€ STATS CSV EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportStats(){
  var season = S.currentSeason;
  if(!S.players.length){ showToast('No players to export.'); return; }
  var rows=[['Player ID','Name','Season','Matches Won','Matches Lost','Games Won','Games Lost','Attendance','Byes','Total Points']];
  for(var i=0;i<S.players.length;i++){
    var p=S.players[i];
    var st=getPlayerStats(p.id,season);
    var bc=(S.byeCounts[p.id]||{})[season]||0;
    var att=(S.playerStats[p.id]||{})[season+'_att']||0;
    var pts=calcTotalPoints(p.id,season);
    rows.push([fmtId(p.id),p.name,season,st.wins,st.losses,st.gamesWon,st.gamesLost,att,bc,pts]);
  }
  var csv='';
  for(var i=0;i<rows.length;i++){
    var cols=[]; for(var j=0;j<rows[i].length;j++) cols.push('"'+String(rows[i][j]).replace(/"/g,'""')+'"');
    csv+=cols.join(',')+'\r\n';
  }
  try{
    var blob=new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob), a=document.createElement('a');
    a.href=url; a.download='dmv_tennis_stats_'+season.toLowerCase()+'.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    showToast('Stats exported!');
  }catch(e){ showToast('Export not supported in this browser.'); }
}

// â”€â”€ STATS CSV IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openImportStats(){
  var season=S.currentSeason;
  var info='<h3>ğŸ“‹ Import Stats CSV</h3>'
    +'<div class="alert alert-info" style="margin-bottom:10px">'
    +'<strong>How to import:</strong><br>1. Use a previously exported Stats CSV<br>'
    +'2. Select all including header row (Ctrl+A)<br>3. Copy (Ctrl+C) and paste below<br><br>'
    +'Column order: <strong>Player ID, Name, Season, Matches Won, Matches Lost, Games Won, Games Lost, Byes</strong><br>'
    +'<em>Only rows matching the current season ('+esc(season)+') will be imported.</em>'
    +'</div>'
    +'<label>Paste CSV Data</label>'
    +'<textarea id="m-stats-csv" rows="10" placeholder="Player ID,Name,Season,Matches Won,Matches Lost,Games Won,Games Lost,Byes"></textarea>'
    +'<div class="modal-btns">'
    +'<button class="btn btn-secondary" id="m-cancel">Cancel</button>'
    +'<button class="btn btn-primary" id="m-stats-import">Import</button>'
    +'</div>';
  showModal(info);
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-stats-import').addEventListener('click',function(){
    var raw=byId('m-stats-csv').value.trim();
    if(!raw){ showToast('Please paste your CSV data.'); return; }
    var firstLine=raw.split('\n')[0];
    var delim=firstLine.indexOf('\t')>=0?'\t':',';
    var lines=raw.replace(/\r\n/g,'\n').replace(/\r/g,'\n').trim().split('\n');
    var added=0,skipped=0;
    if(!S.playerStats) S.playerStats={};
    for(var i=1;i<lines.length;i++){
      var line=lines[i].trim(); if(!line){ skipped++; continue; }
      var cols=line.split(delim);
      for(var j=0;j<cols.length;j++) cols[j]=cols[j].trim().replace(/^"|"$/g,'');
      var pid=parseInt(cols[0]), rowSeason=(cols[2]||'').trim();
      var wins=parseInt(cols[3])||0, losses=parseInt(cols[4])||0;
      var gw=parseInt(cols[5])||0, gl=parseInt(cols[6])||0;
      var att=parseInt(cols[7])||0, byes=parseInt(cols[8])||0;
      if(!pid||rowSeason!==season){ skipped++; continue; }
      if(!S.playerStats[pid]) S.playerStats[pid]={};
      S.playerStats[pid][season]={wins:wins,losses:losses,gamesWon:gw,gamesLost:gl};
      S.playerStats[pid][season+'_att']=att;
      if(!S.byeCounts[pid]) S.byeCounts[pid]={};
      S.byeCounts[pid][season]=byes;
      added++;
    }
    save(); closeModal();
    showToast('Stats imported! '+added+' records updated, '+skipped+' skipped.');
  });
}


// â”€â”€ POINTS CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function savePointsConfig(){
  var mw=byId('cfg-match-win'), gw=byId('cfg-game-win'), att=byId('cfg-att');
  if(!mw||!gw||!att) return;
  if(!S.pointsConfig) S.pointsConfig={};
  S.pointsConfig.matchWin=Math.max(0,parseInt(mw.value)||0);
  S.pointsConfig.gameWin=Math.max(0,parseInt(gw.value)||0);
  S.pointsConfig.attendance=Math.max(0,parseInt(att.value)||0);
  save();
  showToast('Points config saved!');
}

// â”€â”€ ATTENDANCE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAttendanceModal(){
  var season=S.currentSeason;
  if(!S.players.length){ showToast('No players in roster.'); return; }
  var rows='';
  for(var i=0;i<S.players.length;i++){
    var p=S.players[i];
    var att=(S.playerStats[p.id]||{})[season+'_att']||0;
    rows+='<tr>'
    +'<td>'+fmtId(p.id)+'</td>'
    +'<td>'+esc(p.name)+'</td>'
    +'<td><input class="att-input" type="number" min="0" data-pid="'+p.id+'" value="'+att+'" style="width:70px;padding:6px;border:1.5px solid #ccc;border-radius:6px;font-size:.9rem;margin:0"></td>'
    +'</tr>';
  }
  showModal('<h3>ğŸ“… Session Attendance â€” '+esc(season)+'</h3>'
    +'<div class="alert alert-info" style="margin-bottom:10px">Enter total sessions attended this season per player.</div>'
    +'<div style="overflow-y:auto;max-height:50vh">'
    +'<table><tr><th>ID</th><th>Name</th><th>Sessions</th></tr>'+rows+'</table>'
    +'</div>'
    +'<div class="modal-btns">'
    +'<button class="btn btn-secondary" id="m-cancel">Cancel</button>'
    +'<button class="btn btn-primary" id="m-att-save">Save</button>'
    +'</div>');
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-att-save').addEventListener('click',function(){
    if(!S.playerStats) S.playerStats={};
    var inputs=document.querySelectorAll('.att-input');
    inputs.forEach(function(inp){
      var pid=parseInt(inp.dataset.pid), val=Math.max(0,parseInt(inp.value)||0);
      if(!S.playerStats[pid]) S.playerStats[pid]={};
      S.playerStats[pid][season+'_att']=val;
    });
    save(); closeModal(); showToast('Attendance saved!');
  });
}

// â”€â”€ MANUAL PARTNERS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openManualPartnersModal(){
  var date=S.selectedDate; if(!date){ showToast('No date selected.'); return; }
  var sess=getSession(date);
  var inP=getInPlayers(date);
  if(inP.length<2){ showToast('Need at least 2 players marked IN.'); return; }

  // Build rounds (use existing assignment count or default from settings)
  var ppCourt=sess.type==='singles'?2:4;
  var playPerRound=Math.min(inP.length,sess.courts*ppCourt);
  var activeCourts=Math.floor(playPerRound/ppCourt);
  var totalRounds=Math.ceil((inP.length*(sess.matchesPerPlayer||4))/Math.max(1,playPerRound));
  if(totalRounds<1) totalRounds=1;
  if(totalRounds>8) totalRounds=8;

  // Load existing manual assignments if any
  var manual=sess.manualAssignments||{};

  var pOpts='<option value="">â€” unassigned â€”</option>';
  for(var i=0;i<inP.length;i++) pOpts+='<option value="'+inP[i].id+'">'+fmtId(inP[i].id)+' '+esc(inP[i].name)+'</option>';

  var body='<h3>ğŸ¾ Manual Partner Assignment</h3>'
    +'<div class="alert alert-info" style="margin-bottom:10px">Assign partners for each court each round. Unassigned slots will be auto-filled.</div>';

  for(var r=0;r<totalRounds;r++){
    body+='<div style="margin-bottom:14px"><strong style="color:#1a5c2a">Round '+(r+1)+'</strong>';
    for(var c=0;c<activeCourts;c++){
      var key='r'+r+'c'+c;
      var slot=manual[key]||{t1p1:'',t1p2:'',t2p1:'',t2p2:''};
      body+='<div style="border:1.5px solid #ddd;border-radius:8px;padding:8px;margin-top:6px">'
    +'<div style="font-size:.8rem;color:#888;margin-bottom:6px">Court '+(c+1)+'</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">'
    +(sess.type==='singles'
          ? '<select class="mp-sel" data-key="'+key+'" data-slot="t1p1"><option>Team 1'+pOpts+'</select>'
    +'<select class="mp-sel" data-key="'+key+'" data-slot="t2p1"><option>Team 2'+pOpts+'</select>'
          : '<select class="mp-sel" data-key="'+key+'" data-slot="t1p1" style="font-size:.8rem">'+buildOptGroup('T1 P1',slot.t1p1,pOpts)+'</select>'
    +'<select class="mp-sel" data-key="'+key+'" data-slot="t1p2" style="font-size:.8rem">'+buildOptGroup('T1 P2',slot.t1p2,pOpts)+'</select>'
    +'<select class="mp-sel" data-key="'+key+'" data-slot="t2p1" style="font-size:.8rem">'+buildOptGroup('T2 P1',slot.t2p1,pOpts)+'</select>'
    +'<select class="mp-sel" data-key="'+key+'" data-slot="t2p2" style="font-size:.8rem">'+buildOptGroup('T2 P2',slot.t2p2,pOpts)+'</select>'
        )+'</div></div>';
    }
    body+='</div>';
  }

  body+='<div class="modal-btns">'
    +'<button class="btn btn-secondary" id="m-cancel">Cancel</button>'
    +'<button class="btn btn-primary" id="m-mp-save">Save & Generate</button>'
    +'</div>';

  showModal(body);
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-mp-save').addEventListener('click',function(){
    var sels=document.querySelectorAll('.mp-sel');
    var newManual={};
    sels.forEach(function(s){ 
      if(!newManual[s.dataset.key]) newManual[s.dataset.key]={};
      newManual[s.dataset.key][s.dataset.slot]=s.value?parseInt(s.value):null;
    });
    sess.manualAssignments=newManual;
    S.sessions[date]=sess;
    save();
    closeModal();
    generateAssignmentsWithManual(date,sess,newManual);
  });
}

function buildOptGroup(label, selectedVal, pOpts){
  return '<option value="" style="color:#aaa">'+label+'</option>'
    +pOpts.replace('value="'+selectedVal+'"','value="'+selectedVal+'" selected');
}

function generateAssignmentsWithManual(date, sess, manual){
  var inP=getInPlayers(date);
  var ppCourt=sess.type==='singles'?2:4;
  var playPerRound=Math.min(inP.length,sess.courts*ppCourt);
  var activeCourts=Math.floor(playPerRound/ppCourt);
  var totalRounds=Math.ceil((inP.length*(sess.matchesPerPlayer||4))/Math.max(1,playPerRound));
  if(totalRounds<1) totalRounds=1; if(totalRounds>8) totalRounds=8;

  var usedSet={};
  var allRounds=[];

  if(!S.byeCounts) S.byeCounts={};
  for(var i=0;i<inP.length;i++) if(!S.byeCounts[inP[i].id]) S.byeCounts[inP[i].id]={};
  var seasonByes={};
  for(var i=0;i<inP.length;i++) seasonByes[inP[i].id]=(S.byeCounts[inP[i].id][S.currentSeason])||0;

  for(var r=0;r<totalRounds;r++){
    var assigned={};
    var roundCourts=[];

    // First pass: apply manual assignments
    for(var c=0;c<activeCourts;c++){
      var key='r'+r+'c'+c;
      var slot=manual[key];
      var teams=[[],[]];
      if(slot){
        var slots=[slot.t1p1,slot.t1p2,slot.t2p1,slot.t2p2];
        var si=0;
        for(var ti=0;ti<2;ti++){
          var count=ppCourt/2;
          for(var pi=0;pi<count;pi++){
            var pid=slots[si++];
            if(pid){ teams[ti].push(pid); assigned[pid]=true; }
          }
        }
      }
      roundCourts.push({teams:teams, key:key});
    }

    // Second pass: auto-fill remaining players using USTA sort
    var unassigned=inP.filter(function(p){ return !assigned[p.id]; });
    unassigned.sort(function(a,b){ return parseFloat(b.usta)-parseFloat(a.usta); });

    // Determine byes from unassigned excess
    var slotsNeeded=activeCourts*ppCourt;
    var alreadyAssignedCount=Object.keys(assigned).length;
    var slotsLeft=slotsNeeded-alreadyAssignedCount;
    var byes=[];
    if(unassigned.length>slotsLeft){
      var byeCount=unassigned.length-slotsLeft;
      // pick byes from least-bye players
      var byeCandidates=unassigned.slice().sort(function(a,b){
        return (seasonByes[a.id]||0)-(seasonByes[b.id]||0);
      });
      for(var bi=0;bi<byeCount;bi++){
        byes.push(byeCandidates[bi].id);
        seasonByes[byeCandidates[bi].id]=(seasonByes[byeCandidates[bi].id]||0)+1;
      }
      unassigned=unassigned.filter(function(p){ return byes.indexOf(p.id)<0; });
    }

    // Fill open slots with unassigned players
    var ui=0;
    for(var c2=0;c2<roundCourts.length;c2++){
      var ct=roundCourts[c2];
      for(var ti=0;ti<2;ti++){
        var target=ppCourt/2;
        while(ct.teams[ti].length<target && ui<unassigned.length){
          ct.teams[ti].push(unassigned[ui++].id);
        }
      }
      // Only include court if both teams have players
      if(ct.teams[0].length>0&&ct.teams[1].length>0){
        // no-op, already structured
      }
    }

    // Filter out empty courts
    var validCourts=roundCourts.filter(function(ct){
      return ct.teams[0].length>0&&ct.teams[1].length>0;
    });

    allRounds.push({courts:validCourts,byes:byes});
  }

  // Save bye counts
  for(var i=0;i<inP.length;i++){
    if(!S.byeCounts[inP[i].id]) S.byeCounts[inP[i].id]={};
    S.byeCounts[inP[i].id][S.currentSeason]=seasonByes[inP[i].id]||0;
  }

  sess.assignments={rounds:allRounds}; sess.scores={}; sess.posted=false;
  S.sessions[date]=sess; save(); showToast('Manual assignments generated!');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEAM BATTLE â€” ADMIN SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openTeamBattleSetup(){
  var date=S.selectedDate; if(!date){ showToast('No date selected.'); return; }
  var sess=getSession(date);
  var inP=getInPlayers(date);
  if(inP.length<4){ showToast('Need at least 4 players marked IN.'); return; }

  var teamA=sess.teamA||[], teamB=sess.teamB||[];
  var captainA=sess.captainA||null, captainB=sess.captainB||null;

  // Player select options
  function playerOpts(selected){
    var o='<option value="">â€” none â€”</option>';
    for(var i=0;i<inP.length;i++){
      o+='<option value="'+inP[i].id+'"'+(inP[i].id===selected?' selected':'')+'>'+fmtId(inP[i].id)+' '+esc(inP[i].name)+'</option>';
    }
    return o;
  }

  // Build team lists
  function teamCheckboxes(team, prefix){
    var h='';
    for(var i=0;i<inP.length;i++){
      var p=inP[i], checked=team.indexOf(p.id)>=0;
      var chipColor=prefix==='ta'?'#dbeafe':'#fee2e2';
      var borderColor=prefix==='ta'?'#1e40af':'#991b1b';
      h+='<label style="display:flex;align-items:center;gap:8px;padding:5px 6px;cursor:pointer;border-radius:6px;background:'+(checked?chipColor:'transparent')+';border:1.5px solid '+(checked?borderColor:'transparent')+'">'
        +'<input type="checkbox" class="'+prefix+'-chk" value="'+p.id+'"'+(checked?' checked':'')+' style="width:16px;height:16px;cursor:pointer"> '
        +'<span style="font-size:.88rem">'+fmtId(p.id)+' '+esc(p.name)+'</span>'
        +'</label>';
    }
    return h;
  }

  var body='<h3>âš”ï¸ Team Battle Setup</h3>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">'
    +'<div style="border:2px solid #1e40af;border-radius:8px;padding:10px">'
    +'<div style="font-weight:700;color:#1e40af;margin-bottom:8px">ğŸ”µ Team A</div>'
    +'<label style="font-size:.8rem">Captain</label>'
    +'<select id="cap-a-sel" style="width:100%;margin-bottom:8px;padding:6px;border-radius:6px;border:1.5px solid #ccc">'+playerOpts(captainA)+'</select>'
    +'<label style="font-size:.8rem">Players</label>'
    +'<div style="max-height:220px;overflow-y:auto;border:1px solid #e0e0e0;border-radius:6px;padding:6px">'+teamCheckboxes(teamA,'ta')+'</div>'
    +'</div>'
    +'<div style="border:2px solid #991b1b;border-radius:8px;padding:10px">'
    +'<div style="font-weight:700;color:#991b1b;margin-bottom:8px">ğŸ”´ Team B</div>'
    +'<label style="font-size:.8rem">Captain</label>'
    +'<select id="cap-b-sel" style="width:100%;margin-bottom:8px;padding:6px;border-radius:6px;border:1.5px solid #ccc">'+playerOpts(captainB)+'</select>'
    +'<label style="font-size:.8rem">Players</label>'
    +'<div style="max-height:220px;overflow-y:auto;border:1px solid #e0e0e0;border-radius:6px;padding:6px">'+teamCheckboxes(teamB,'tb')+'</div>'
    +'</div>'
    +'</div>'
    +'<div class="alert alert-info" style="margin-top:10px;font-size:.82rem">Players can be on both teams or neither â€” checkboxes are independent. Captains can also add players from their own view. After saving, use <strong>"Generate Court Assignment"</strong> to create the schedule.</div>'
    +'<div class="modal-btns">'
    +'<button class="btn btn-secondary" id="m-cancel">Cancel</button>'
    +'<button class="btn btn-primary" id="m-tb-save">Save & Generate</button>'
    +'</div>';

  showModal(body,true);
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-tb-save').addEventListener('click',function(){
    var newTeamA=[], newTeamB=[];
    document.querySelectorAll('.ta-chk:checked').forEach(function(c){ newTeamA.push(parseInt(c.value)); });
    document.querySelectorAll('.tb-chk:checked').forEach(function(c){ newTeamB.push(parseInt(c.value)); });
    var newCapA=parseInt(byId('cap-a-sel').value)||null;
    var newCapB=parseInt(byId('cap-b-sel').value)||null;
    if(!newTeamA.length||!newTeamB.length){ showToast('Each team needs at least one player.'); return; }
    // Warn about cross-team players
    var crossPlayers=newTeamA.filter(function(id){ return newTeamB.indexOf(id)>=0; });
    if(crossPlayers.length){
      var names=crossPlayers.map(function(id){ var p=getPlayer(id); return p?p.name:fmtId(id); }).join(', ');
      showToast('âš ï¸ Warning: '+names+' is on both teams!');
    }
    sess.teamA=newTeamA; sess.teamB=newTeamB;
    sess.captainA=newCapA; sess.captainB=newCapB;
    S.sessions[date]=sess; save();
    closeModal();
    showToast('Team Battle saved! Click "Generate Court Assignment" to create schedule.');
  });
}

function generateTeamBattleAssignments(date, sess){
  var teamA=sess.teamA||[], teamB=sess.teamB||[];
  var ppCourt=sess.type==='singles'?2:4;
  var courts=sess.courts||4;
  var mpp=sess.matchesPerPlayer||4;
  var matchesPerRound=Math.min(Math.min(Math.floor(teamA.length/(ppCourt/2)), Math.floor(teamB.length/(ppCourt/2))), courts);
  if(matchesPerRound<1) matchesPerRound=1;

  // Estimate rounds needed
  var totalPlayers=teamA.length+teamB.length;
  var playPerRound=matchesPerRound*ppCourt;
  var totalRounds=Math.max(1,Math.ceil((totalPlayers*mpp)/Math.max(1,playPerRound)));
  if(totalRounds>8) totalRounds=8;

  // Get full player objects
  function getInPByIds(ids){
    return ids.map(function(id){ return getPlayer(id); }).filter(Boolean);
  }
  var aPlayers=getInPByIds(teamA).sort(function(a,b){ return parseFloat(b.usta)-parseFloat(a.usta); });
  var bPlayers=getInPByIds(teamB).sort(function(a,b){ return parseFloat(b.usta)-parseFloat(a.usta); });

  var allRounds=[];
  for(var r=0;r<totalRounds;r++){
    var roundCourts=[];
    // Pair up A vs B players across courts
    var usedA={}, usedB={};
    for(var c=0;c<matchesPerRound;c++){
      // Pick next unused players from each team
      var aTeam=[], bTeam=[];
      var half=ppCourt/2;
      for(var i=0;i<aPlayers.length&&aTeam.length<half;i++){
        if(!usedA[aPlayers[i].id]){ aTeam.push(aPlayers[i].id); usedA[aPlayers[i].id]=true; }
      }
      for(var i=0;i<bPlayers.length&&bTeam.length<half;i++){
        if(!usedB[bPlayers[i].id]){ bTeam.push(bPlayers[i].id); usedB[bPlayers[i].id]=true; }
      }
      if(aTeam.length>0&&bTeam.length>0) roundCourts.push({teams:[aTeam,bTeam]});
    }
    // Byes = anyone in both teams not playing
    var byes=[];
    for(var i=0;i<aPlayers.length;i++) if(!usedA[aPlayers[i].id]) byes.push(aPlayers[i].id);
    for(var i=0;i<bPlayers.length;i++) if(!usedB[bPlayers[i].id]) byes.push(bPlayers[i].id);
    // Rotate for next round
    if(aPlayers.length>1) aPlayers.push(aPlayers.shift());
    if(bPlayers.length>1) bPlayers.push(bPlayers.shift());
    allRounds.push({courts:roundCourts, byes:byes});
  }

  sess.assignments={rounds:allRounds, mode:'teamBattle'};
  sess.scores={};
  sess.posted=false;
  S.sessions[date]=sess;
  save();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEAM BATTLE â€” CAPTAIN VIEW (user-facing)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCaptainLogin(){
  var date=getUpcoming(); if(!date){ showToast('No upcoming session.'); return; }
  var sess=getSession(date);
  if(!sess.teamBattle){ showToast('No Team Battle active for this session.'); return; }
  var inP=getInPlayers(date);
  var pOpts='<option value="">-- Select your name --</option>';
  for(var i=0;i<inP.length;i++){
    var isCap=(inP[i].id===sess.captainA||inP[i].id===sess.captainB);
    if(isCap) pOpts+='<option value="'+inP[i].id+'">'+fmtId(inP[i].id)+' '+esc(inP[i].name)+' ğŸ‘‘</option>';
  }
  showModal('<h3>ğŸ‘‘ Captain Login</h3>'
    +'<div class="alert alert-info" style="margin-bottom:10px">Only assigned captains can access this view.</div>'
    +'<label>Select Your Name</label>'
    +'<select id="cap-login-sel" style="padding:10px;width:100%">'+pOpts+'</select>'
    +'<div class="modal-btns">'
    +'<button class="btn btn-secondary" id="m-cancel">Cancel</button>'
    +'<button class="btn btn-primary" id="m-cap-confirm">Enter My Team</button>'
    +'</div>');
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-cap-confirm').addEventListener('click',function(){
    var pid=parseInt(byId('cap-login-sel').value);
    if(!pid){ showToast('Please select your name.'); return; }
    if(pid!==sess.captainA&&pid!==sess.captainB){ showToast('You are not listed as a captain.'); return; }
    S.captainPid=pid; saveLocalPrefs(); closeModal(); render();
  });
}

function captainTeamHTML(){
  var date=getUpcoming(); if(!date) return '<div class="card"><div class="alert alert-info">No upcoming session.</div></div>';
  var sess=getSession(date);
  if(!sess.teamBattle) return '<div class="card"><div class="alert alert-info">No Team Battle mode active.</div></div>';
  if(!S.captainPid) return '<div class="card"><h2>âš”ï¸ Captain View</h2>'
    +'<div class="alert alert-info">You need to log in as a captain to access this view.</div>'
    +'<button class="btn btn-primary" id="captain-login-btn">ğŸ‘‘ Captain Login</button></div>';

  var isCapA=(S.captainPid===sess.captainA);
  var isCapB=(S.captainPid===sess.captainB);
  if(!isCapA&&!isCapB) return '<div class="card"><div class="alert alert-warn">You are not a captain for this session. <button class="btn btn-secondary btn-sm" id="captain-login-btn">Switch Captain</button></div></div>';

  var myTeam=isCapA?(sess.teamA||[]):(sess.teamB||[]);
  var otherTeam=isCapA?(sess.teamB||[]):(sess.teamA||[]);
  var teamLabel=isCapA?'ğŸ”µ Team A':'ğŸ”´ Team B';
  var teamColor=isCapA?'#1e40af':'#991b1b';
  var teamBorder=isCapA?'#1e40af':'#991b1b';
  var chipClass=isCapA?'team-a-chip':'team-b-chip';

  var inP=getInPlayers(date);

  var h='<div class="card"><h2>âš”ï¸ '+teamLabel+'</h2>';
  h+='<div style="font-size:.85rem;color:#555;margin-bottom:12px">Captain: <strong>'+esc((getPlayer(S.captainPid)||{name:'?'}).name)+'</strong>'
    +' <button class="btn btn-secondary btn-sm" id="captain-login-btn" style="margin-left:8px">Switch</button></div>';

  // Team member management section
  h+='<div style="border:2px solid '+teamBorder+';border-radius:8px;padding:12px;margin-bottom:14px">';
  h+='<div style="font-weight:700;color:'+teamColor+';margin-bottom:8px">My Team Roster ('+myTeam.length+' players)</div>';

  // Current members
  if(myTeam.length){
    h+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">';
    for(var i=0;i<myTeam.length;i++){
      var mp=getPlayer(myTeam[i]);
      var isCap=(myTeam[i]===S.captainPid);
      h+='<span class="'+chipClass+'" style="display:inline-flex;align-items:center;gap:4px">'+(isCap?'ğŸ‘‘ ':'')+esc(mp?mp.name:fmtId(myTeam[i]))+
        (!isCap?'<button type="button" data-remove-pid="'+myTeam[i]+'" style="background:none;border:none;cursor:pointer;color:inherit;font-size:.75rem;padding:0;margin-left:2px">âœ•</button>':'')+'</span>';
    }
    h+='</div>';
  } else {
    h+='<div style="color:#aaa;font-size:.85rem;margin-bottom:10px">No players assigned yet.</div>';
  }

  // Add player section
  h+='<div style="margin-top:8px">';
  h+='<label style="font-size:.8rem;font-weight:600">Add Player to Team</label>';
  h+='<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">';
  h+='<select id="cap-add-player-sel" style="flex:1;padding:7px;border-radius:6px;border:1.5px solid #ccc;font-size:.88rem">';
  h+='<option value="">â€” select player â€”</option>';
  for(var i=0;i<inP.length;i++){
    var alreadyMine=myTeam.indexOf(inP[i].id)>=0;
    if(!alreadyMine){
      var alreadyOther=otherTeam.indexOf(inP[i].id)>=0;
      h+='<option value="'+inP[i].id+'"'+(alreadyOther?' style="color:#991b1b;font-weight:700"':'')+'>'+fmtId(inP[i].id)+' '+esc(inP[i].name)+(alreadyOther?' âš ï¸ (other team)':'')+'</option>';
    }
  }
  h+='</select>';
  h+='<button class="btn btn-green btn-sm" id="cap-add-btn">+ Add</button>';
  h+='</div>';
  h+='<div id="cap-add-warn" style="margin-top:6px;color:#856404;font-size:.82rem;display:none">âš ï¸ This player is already on the other team. They will play for both teams if added.</div>';
  h+='</div></div>';

  // Show assignments if generated
  if(sess.assignments&&sess.assignments.rounds){
    h+='<div style="font-weight:700;margin-bottom:8px">Today\'s Matches</div>';
    var rounds=sess.assignments.rounds;
    for(var ri=0;ri<rounds.length;ri++){
      var round=rounds[ri]; if(!round||!round.courts) continue;
      h+='<div style="font-size:.85rem;font-weight:600;color:#555;margin-top:10px">Round '+(ri+1)+'</div>';
      var myPlayed=false;
      for(var ci=0;ci<round.courts.length;ci++){
        var court=round.courts[ci];
        var myTeamOnCourt=false;
        for(var ti=0;ti<court.teams.length;ti++){
          for(var pi=0;pi<court.teams[ti].length;pi++){
            if(myTeam.indexOf(court.teams[ti][pi])>=0){ myTeamOnCourt=true; break; }
          }
          if(myTeamOnCourt) break;
        }
        if(!myTeamOnCourt) continue;
        myPlayed=true;
        var sc=sess.scores?sess.scores[ri+'_'+ci]:null;
        h+='<div style="border:1.5px solid #ddd;border-radius:8px;padding:8px;margin-top:4px">';
        h+='<div style="font-size:.8rem;color:#888">Court '+(ci+1)+'</div>';
        for(var ti=0;ti<court.teams.length;ti++){
          var teamPids=court.teams[ti];
          var myT=false;
          for(var pi=0;pi<teamPids.length;pi++) if(myTeam.indexOf(teamPids[pi])>=0){ myT=true; break; }
          var bgColor=myT?(isCapA?'#dbeafe':'#fee2e2'):'#f5f5f5';
          var tScore=sc?(ti===0?sc.t1:sc.t2):null;
          h+='<div style="background:'+bgColor+';border-radius:6px;padding:4px 8px;margin:3px 0;display:flex;justify-content:space-between;align-items:center">';
          h+='<div>';
          for(var pi=0;pi<teamPids.length;pi++){
            var pp=getPlayer(teamPids[pi]);
            h+='<span style="font-size:.85rem;font-weight:'+(myT?'700':'400')+'">'+esc(pp?pp.name:fmtId(teamPids[pi]))+(pi<teamPids.length-1?' & ':'')+'</span>';
          }
          h+='</div>';
          h+='<span style="font-weight:700;color:'+(myT?teamColor:'#666')+'">'+(tScore!==null&&tScore!==''?tScore:'â€”')+'</span>';
          h+='</div>';
          if(ti===0) h+='<div style="text-align:center;font-size:.75rem;color:#aaa">vs</div>';
        }
        h+='</div>';
      }
      if(!myPlayed){
        var inBye=false;
        if(round.byes) for(var pi=0;pi<myTeam.length;pi++) if(round.byes.indexOf(myTeam[pi])>=0){ inBye=true; break; }
        h+='<div style="color:#856404;font-size:.82rem;padding:4px 0">'+(inBye?'â¸ Sitting out this round':'No courts assigned')+'</div>';
      }
    }
  } else {
    h+='<div class="alert alert-info">Assignments will be generated by admin once teams are set.</div>';
  }

  h+='</div>';
  return h;
}


// â”€â”€ PLAYERS CHOICE LIVE COURT GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playersChoiceCourtGrid(sess, date, isAdmin){
  var pcData=sess.pcSubmissions||{};
  var courts=sess.courts||4;
  var mpp=sess.matchesPerPlayer||4;
  var ppCourt=sess.type==='singles'?2:4;

  var h='<div class="card"><h2>ğŸ¾ Live Court View â€” Players Choice</h2>';
  h+='<div class="alert alert-info" style="font-size:.82rem;margin-bottom:10px">';
  h+=isAdmin?'Updates live as players submit preferences.':'Courts fill in as players submit preferences.';
  h+='</div>';

  // Build a courtGrid[round][courtNum] = {team1:[pids], team2:[pids]}
  var courtGrid=[];
  for(var r=0;r<mpp;r++){
    var row={};
    for(var c=1;c<=courts;c++) row[c]={team1:[],team2:[]};
    courtGrid.push(row);
  }
  var pids=Object.keys(pcData);
  for(var i=0;i<pids.length;i++){
    var pid=parseInt(pids[i]);
    var prefs=pcData[pids[i]];
    for(var r=0;r<prefs.length&&r<mpp;r++){
      var pref=prefs[r];
      var ct=pref.court||1;
      if(ct<1||ct>courts) continue;
      var grid=courtGrid[r][ct];
      var partner=pref.partner;
      if(ppCourt===4&&partner){
        var alreadyPlaced=false;
        for(var c2=1;c2<=courts;c2++){
          if(courtGrid[r][c2].team1.indexOf(partner)>=0||courtGrid[r][c2].team2.indexOf(partner)>=0){ alreadyPlaced=true; break; }
        }
        if(!alreadyPlaced&&grid.team1.indexOf(pid)<0&&grid.team2.indexOf(pid)<0){
          if(grid.team1.length<ppCourt/2){ grid.team1.push(pid); grid.team1.push(partner); continue; }
          else if(grid.team2.length<ppCourt/2){ grid.team2.push(pid); grid.team2.push(partner); continue; }
        }
      }
      if(grid.team1.indexOf(pid)<0&&grid.team2.indexOf(pid)<0){
        if(grid.team1.length<ppCourt/2) grid.team1.push(pid);
        else if(grid.team2.length<ppCourt/2) grid.team2.push(pid);
        else grid.team1.push(pid);
      }
    }
  }

  for(var r=0;r<mpp;r++){
    h+='<div class="round-block"><div class="round-title">Round '+(r+1)+'</div><div class="courts-row">';
    var anyP=false;
    for(var c=1;c<=courts;c++){
      var grid=courtGrid[r][c];
      if(!grid.team1.length&&!grid.team2.length) continue;
      anyP=true;
      var scKey=r+'_'+(c-1);
      var sc=sess.scores?sess.scores[scKey]||null:null;
      h+='<div class="court-card">';
      h+='<div class="court-header">Court '+c+'</div>';
      h+='<div class="court-body">';
      for(var ti=0;ti<2;ti++){
        var tPids=ti===0?grid.team1:grid.team2;
        var tScore=sc?(ti===0?sc.t1:sc.t2):null;
        var oScore=sc?(ti===0?sc.t2:sc.t1):null;
        var isWin=sc&&parseInt(tScore)>parseInt(oScore);
        h+='<div class="team"><div class="team-row"><div class="team-label">Team '+(ti+1)+'</div>';
        h+='<span class="team-score'+(sc?(isWin?' winner':''):'  empty')+'">'+(sc?tScore:'â€”')+'</span>';
        h+='</div><div style="margin-top:4px">';
        for(var pi=0;pi<tPids.length;pi++){
          var pp=getPlayer(tPids[pi]);
          h+='<span class="player-chip">'+esc(pp?pp.name:fmtId(tPids[pi]))+'</span>';
        }
        if(!tPids.length) h+='<span style="color:#aaa;font-size:.8rem">waiting...</span>';
        h+='</div></div>';
        if(ti===0) h+='<div class="vs">VS</div>';
      }
      if(isAdmin){
        h+='<div class="score-row"><button class="btn btn-secondary btn-sm" data-score-btn data-date="'+esc(date)+'" data-round="'+r+'" data-court="'+(c-1)+'">'+((sc&&sc.t1!=='')?'âœï¸ Edit Score':'+ Score')+'</button></div>';
      }
      h+='</div></div>';
    }
    if(!anyP) h+='<div style="color:#aaa;font-size:.85rem;padding:8px">No preferences submitted yet.</div>';
    h+='</div></div>';
  }

  if(pids.length){
    h+='<div style="margin-top:8px"><span style="font-size:.82rem;font-weight:700;color:#1a5c2a">âœ… '+pids.length+' submitted: </span>';
    for(var i=0;i<pids.length;i++){
      var spp=getPlayer(parseInt(pids[i]));
      h+='<span style="background:#d4edda;color:#155724;border-radius:14px;padding:2px 9px;font-size:.8rem;margin:2px;display:inline-block">'+esc(spp?spp.name:pids[i])+'</span>';
    }
    h+='</div>';
  } else {
    h+='<div style="color:#aaa;font-size:.85rem;margin-top:8px">No submissions yet.</div>';
  }
  h+='</div>';
  return h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYERS CHOICE â€” USER VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function playersChoiceUserHTML(){
  var date=getUpcoming(); if(!date) return '<div class="card"><div class="alert alert-info">No upcoming session.</div></div>';
  var sess=getSession(date);
  if(!sess.playersChoice) return '<div class="card"><div class="alert alert-info">Players Choice mode is not active for this session.</div></div>';

  var inP=getInPlayers(date);
  if(!inP.length) return '<div class="card"><div class="alert alert-info">No players marked IN yet.</div></div>';

  var ppCourt=sess.type==='singles'?2:4;
  var mpp=sess.matchesPerPlayer||4;
  var courts=sess.courts||4;

  // Load existing PC submissions
  var pcData=sess.pcSubmissions||{};

  var pOpts='<option value="">â€” unassigned â€”</option>';
  for(var i=0;i<inP.length;i++) pOpts+='<option value="'+inP[i].id+'">'+fmtId(inP[i].id)+' '+esc(inP[i].name)+'</option>';

  var courtOpts='';
  for(var c=1;c<=courts;c++) courtOpts+='<option value="'+c+'">Court '+c+'</option>';

  var h='<div class="card"><h2>ğŸ¾ Players Choice</h2>';
  h+='<div class="alert alert-info" style="margin-bottom:12px">Select your partner, court, and round for each match you want to play.</div>';

  // Show who has already submitted
  var submittedPids=Object.keys(pcData);
  h+='<div id="pc-submitted-wrap" style="margin-bottom:12px">';
  if(submittedPids.length){
    h+='<div style="font-weight:700;font-size:.85rem;margin-bottom:6px">âœ… Submitted ('+submittedPids.length+' players)</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
    for(var i=0;i<submittedPids.length;i++){
      var sp=getPlayer(parseInt(submittedPids[i]));
      h+='<span style="background:#d4edda;color:#155724;border-radius:14px;padding:3px 10px;font-size:.82rem">'+esc(sp?sp.name:submittedPids[i])+'</span>';
    }
    h+='</div>';
  }
  h+='</div>';

  h+='<div style="border:1.5px solid #e8f5e9;border-radius:8px;padding:12px">';
  h+='<div style="font-weight:700;margin-bottom:10px">Submit My Preferences</div>';
  h+='<label>Your Name</label>';
  h+='<select id="pc-self-sel" style="width:100%;padding:8px;margin-bottom:10px">'+pOpts+'</select>';

  for(var r=0;r<mpp;r++){
    h+='<div style="border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px">';
    h+='<div style="font-size:.85rem;font-weight:700;color:#1a5c2a;margin-bottom:6px">Match '+(r+1)+'</div>';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
    if(ppCourt===4){
      h+='<div><label style="font-size:.78rem">Partner</label>';
      h+='<select id="pc-partner-'+r+'" style="width:100%;padding:6px">'+pOpts+'</select></div>';
    }
    h+='<div><label style="font-size:.78rem">Court</label>';
    h+='<select id="pc-court-'+r+'" style="width:100%;padding:6px">'+courtOpts+'</select></div>';
    h+='</div></div>';
  }

  h+='<button class="btn btn-primary" id="pc-submit-btn" style="width:100%;margin-top:4px">Submit My Preferences</button>';
  h+='</div>';
  h+='<div id="pc-user-grid" style="margin-top:12px">'+playersChoiceCourtGrid(sess,date,false)+'</div>';
  h+='</div>';
  return h;
}

function submitPlayersChoice(){
  var date=getUpcoming(); if(!date) return;
  var sess=getSession(date);
  var selfSel=byId('pc-self-sel'); if(!selfSel) return;
  var selfPid=parseInt(selfSel.value);
  if(!selfPid){ showToast('Please select your name.'); return; }
  var mpp=sess.matchesPerPlayer||4;
  var ppCourt=sess.type==='singles'?2:4;
  var prefs=[];
  for(var r=0;r<mpp;r++){
    var partnerEl=byId('pc-partner-'+r);
    var courtEl=byId('pc-court-'+r);
    prefs.push({
      partner: partnerEl?parseInt(partnerEl.value)||null:null,
      court: courtEl?parseInt(courtEl.value)||1:1
    });
  }
  if(!sess.pcSubmissions) sess.pcSubmissions={};
  sess.pcSubmissions[selfPid]=prefs;
  S.sessions[date]=sess; save();
  showToast('Preferences submitted! Court view updated.');
  // Refresh just the grid elements without full re-render
  var adminGrid=byId('pc-court-grid');
  if(adminGrid) adminGrid.innerHTML=playersChoiceCourtGrid(sess,date,true);
  var userGridEl=byId('pc-user-grid');
  if(userGridEl) userGridEl.innerHTML=playersChoiceCourtGrid(sess,date,false);
  // Also re-bind score buttons if admin grid was refreshed
  if(adminGrid) bindScoreButtons();
  // Refresh submitted-who list in user form
  var subWrap=byId('pc-submitted-wrap');
  if(subWrap){
    var pcD=sess.pcSubmissions||{};
    var sPids=Object.keys(pcD);
    var sHtml='<div style="font-weight:700;font-size:.85rem;margin-bottom:6px">âœ… Submitted ('+sPids.length+' players)</div><div style="display:flex;flex-wrap:wrap;gap:6px">';
    for(var si=0;si<sPids.length;si++){ var spp=getPlayer(parseInt(sPids[si])); sHtml+='<span style="background:#d4edda;color:#155724;border-radius:14px;padding:3px 10px;font-size:.82rem">'+esc(spp?spp.name:sPids[si])+'</span>'; }
    sHtml+='</div>';
    subWrap.innerHTML=sHtml;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYERS CHOICE â€” ADMIN VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPlayersChoiceAdmin(){
  var date=S.selectedDate; if(!date){ showToast('No date selected.'); return; }
  var sess=getSession(date);
  var pcData=sess.pcSubmissions||{};
  var inP=getInPlayers(date);
  var mpp=sess.matchesPerPlayer||4;
  var ppCourt=sess.type==='singles'?2:4;
  var pids=Object.keys(pcData);

  if(!pids.length){
    showModal('<h3>ğŸ“‹ Players Choice Submissions</h3><div class="alert alert-info">No submissions yet.</div><div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Close</button></div>');
    byId('m-cancel').addEventListener('click',closeModal);
    return;
  }

  var body='<h3>ğŸ“‹ Players Choice Submissions</h3>';
  body+='<div style="overflow-y:auto;max-height:55vh">';
  for(var i=0;i<pids.length;i++){
    var pid=parseInt(pids[i]), pp=getPlayer(pid);
    var prefs=pcData[pids[i]];
    body+='<div style="border:1.5px solid #e8f5e9;border-radius:8px;padding:8px;margin-bottom:8px">';
    body+='<div style="font-weight:700;color:#1a5c2a;margin-bottom:4px">'+esc(pp?pp.name:fmtId(pid))+'</div>';
    for(var r=0;r<prefs.length;r++){
      var pr=prefs[r];
      var partnerP=pr.partner?getPlayer(pr.partner):null;
      body+='<div style="font-size:.82rem;padding:2px 0">Match '+(r+1)+': ';
      if(ppCourt===4) body+='Partner: <strong>'+esc(partnerP?partnerP.name:(pr.partner?fmtId(pr.partner):'Any'))+'</strong> Â· ';
      body+='Court <strong>'+pr.court+'</strong></div>';
    }
    body+='</div>';
  }
  body+='</div>';
  body+='<div class="modal-btns">';
  body+='<button class="btn btn-secondary" id="m-cancel">Close</button>';
  body+='<button class="btn btn-primary" id="m-pc-gen">Generate from Preferences</button>';
  body+='</div>';

  showModal(body);
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-pc-gen').addEventListener('click',function(){
    generatePlayersChoiceAssignments(date, sess, pcData);
    closeModal();
    showToast('Assignments generated from player preferences!');
  });
}

function generatePlayersChoiceAssignments(date, sess, pcData){
  var inP=getInPlayers(date);
  var ppCourt=sess.type==='singles'?2:4;
  var mpp=sess.matchesPerPlayer||4;
  var courts=sess.courts||4;

  // Build rounds from preferences
  // Each round = one match slot per player
  var allRounds=[];
  for(var r=0;r<mpp;r++){
    var placed={};
    var roundCourts=[];
    // Collect requests for this round
    var requests=[];
    var pids=Object.keys(pcData);
    for(var i=0;i<pids.length;i++){
      var pid=parseInt(pids[i]);
      var prefs=pcData[pids[i]];
      if(prefs[r]){ requests.push({pid:pid, partner:prefs[r].partner, court:prefs[r].court}); }
    }
    // Group by court
    var byCourt={};
    for(var i=0;i<requests.length;i++){
      var ct=requests[i].court;
      if(!byCourt[ct]) byCourt[ct]=[];
      byCourt[ct].push(requests[i]);
    }
    // Build court assignments
    var ctKeys=Object.keys(byCourt).sort();
    for(var ci=0;ci<ctKeys.length&&ci<courts;ci++){
      var ctReqs=byCourt[ctKeys[ci]];
      if(ctReqs.length<2) continue;
      var team1=[], team2=[];
      var half=ppCourt/2;
      // pair by partner preference or just split
      var used={};
      for(var i=0;i<ctReqs.length;i++){
        if(used[ctReqs[i].pid]) continue;
        var partner=ctReqs[i].partner;
        if(ppCourt===4&&partner&&!used[partner]){
          if(team1.length<half){ team1.push(ctReqs[i].pid); team1.push(partner); used[ctReqs[i].pid]=true; used[partner]=true; }
          else if(team2.length<half){ team2.push(ctReqs[i].pid); team2.push(partner); used[ctReqs[i].pid]=true; used[partner]=true; }
        } else {
          if(team1.length<half){ team1.push(ctReqs[i].pid); used[ctReqs[i].pid]=true; }
          else if(team2.length<half){ team2.push(ctReqs[i].pid); used[ctReqs[i].pid]=true; }
        }
      }
      if(team1.length>0&&team2.length>0) roundCourts.push({teams:[team1,team2]});
    }
    // Byes = players marked IN but not placed
    var allPlaced={};
    for(var ci=0;ci<roundCourts.length;ci++){
      for(var ti=0;ti<roundCourts[ci].teams.length;ti++){
        for(var pi=0;pi<roundCourts[ci].teams[ti].length;pi++) allPlaced[roundCourts[ci].teams[ti][pi]]=true;
      }
    }
    var byes=[];
    for(var i=0;i<inP.length;i++) if(!allPlaced[inP[i].id]) byes.push(inP[i].id);
    allRounds.push({courts:roundCourts, byes:byes});
  }

  sess.assignments={rounds:allRounds, mode:'playersChoice'};
  sess.scores={};
  sess.posted=false;
  S.sessions[date]=sess;
  save();
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
byId('admin-btn').addEventListener('click',function(){
  if(S.isAdmin){ S.isAdmin=false; saveLocalPrefs(); render(); return; }
  showModal('<h3>ğŸ” Admin Login</h3>'
    +'<label>Password</label><input type="password" id="m-pass" placeholder="Enter password">'
    +'<div class="modal-btns"><button class="btn btn-secondary" id="m-cancel">Cancel</button><button class="btn btn-primary" id="m-login">Login</button></div>');
  setTimeout(function(){ var p=byId('m-pass'); if(p) p.focus(); },100);
  byId('m-cancel').addEventListener('click',closeModal);
  byId('m-login').addEventListener('click',function(){
    var p=byId('m-pass');
    if(p&&p.value===PASS){ S.isAdmin=true; saveLocalPrefs(); closeModal(); render(); }
    else showToast('Incorrect password.');
  });
});
</script>
</body>
</html>